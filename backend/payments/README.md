# Payments Service (архив)

Каталог хранит легаси-версию standalone-сервиса платежей. Боевой контур CRM использует встроенный модуль внутри [`backend/crm`](../crm/README.md): именно он публикует REST API и события `deal.payment.*`. Материалы из `backend/payments` нужны только для анализа миграций, сравнения контрактов и экспериментов в изолированной среде.

## Статус
- исходный Spring Boot-проект не поддерживается и не обновляется;
- контейнер `payments` удалён из `infra/docker-compose.yml`, архивный сервис запускается только вручную (см. раздел ниже);
- переменные `PAYMENTS_RABBITMQ_*` исключены из `env.example` и не синхронизируются скриптами — задавайте их вручную, если воспроизводите легаси-код;
- миграции Flyway и конфигурация очередей описывают прежнюю схему `payments` и нужны только для анализа наследия.

## Как воспроизвести легаси-сервис локально

> ⚠️ Развёртывание актуального окружения не подразумевает запуск этого сервиса. Запускайте легаси только для экспериментального анализа или повторного воспроизведения старых интеграций.

1. Скопируйте `env.example` в корень и в `backend/payments`:
   ```bash
   ./scripts/sync-env.sh backend/payments
   ```
2. Поднимите отдельные экземпляры PostgreSQL и RabbitMQ (`docker compose --env-file .env up -d postgres rabbitmq`).
3. Запустите сервис в локальном профиле:
   ```bash
   cd backend/payments
   SPRING_PROFILES_ACTIVE=local ./gradlew bootRun
   ```
   > ℹ️ Шаблон `env.example` больше не содержит значение `PAYMENTS_CRM_WEBHOOK_SECRET`. Если нужно принять вебхуки от актуальной CRM, задайте секрет вручную в `.env` этого сервиса или через переменную окружения перед запуском.

## Что можно найти в архиве
- историческую документацию по API (`docs/api/payments.md`),
- старые конфигурации Spring Cloud Stream (`src/main/resources/application*.yml`),
- пример миграций Flyway для схемы `payments` (`migrations/`).
- примеры подключения к RabbitMQ с использованием переменных `PAYMENTS_RABBITMQ_URL` (localhost) и `PAYMENTS_RABBITMQ_INTERNAL_URL` (docker-сеть) внутри конфигурации легаси-приложения — значения нужно задавать вручную перед запуском.

Эти материалы помогают при анализе миграции данных или восстановлении контекста предыдущих интеграций.

## Docker Compose и переменные окружения

Контейнер `payments` исключён из `infra/docker-compose.yml`, поэтому bootstrap-скрипты и профили Docker Compose больше не запускают легаси-сервис автоматически. Для редких сценариев воспроизведения следуйте шагам из раздела «Как воспроизвести легаси-сервис локально»: вручную синхронизируйте `.env`, поднимите необходимые зависимости (PostgreSQL, RabbitMQ) и стартуйте Spring Boot через `./gradlew bootRun`. Набор переменных окружения определяйте вручную — шаблон `env.example` не предоставляет значения `PAYMENTS_RABBITMQ_*` и других устаревших параметров.
