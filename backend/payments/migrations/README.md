# Миграции схемы `payments`

## Порядок миграций

1. `20240117090000_create_payments.sql` — таблица `payments` с внешними ключами на `crm.deals`, `crm.policies`, `auth.users`.
2. `20240117092000_create_payment_history.sql` — таблица `payment_history`, индексы по `payment_id` и `changed_at`.
3. `20240117094000_create_payment_schedules.sql` — таблица `payment_schedules` с уникальным ограничением `(deal_id, payment_type, due_date)`.
4. `20240117100000_seed_payment_dictionaries.sql` — типы и статусы платежей.

## Правила версионирования

* Таймстемпы миграций — в UTC с точностью до секунды.
* Любое изменение, влияющее на агрегации (например, новые статусные поля), должно сопровождаться обновлением витрин и представлений.
* Для долгих DML-операций требуется оборачивать изменения в `BEGIN/COMMIT` и фиксировать прогресс в комментариях миграции.
* После каждой миграции выполняется smoke-тест расчётов комиссий (см. автоматические тесты сервиса).
