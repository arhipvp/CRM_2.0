# План разработки CRM 2.0 с применением ИИ-ассистентов

## Этап 0. Предпроектная подготовка
- Сформировать детализированный бэклог первой поставки по сервисам Gateway, Auth, CRM/Deals (включая модуль оплат), Tasks, Documents, Notifications, Backup и пользовательским ролям. Использовать ИИ-инструменты для формирования пользовательских историй и уточнения acceptance-критериев.
- Провести сессии по уточнению архитектуры (микросервисы, PostgreSQL, RabbitMQ, Redis, Consul, наблюдаемость). Зафиксировать итоговые решения в диаграммах и текстовой документации. Привлекать ИИ для генерации схем и проверки согласованности терминов.

## Этап 1. Инфраструктурный фундамент
- Поддерживать репозиторий с `docker-compose`, шаблонами Kubernetes и пайплайнами CI/CD (GitHub Actions, Argo CD). Использовать ИИ для генерации базовых конфигураций и статических проверок.
- Поддерживать `env.example` и шаблоны `.env`/секретов. Проверять актуальность файла с помощью автоматизированных напоминаний и ревью с участием ИИ.
- Задокументировать процесс локального развёртывания и подготовки секретов в `docs/`. Предварительно сгенерировать инструкции на основе подсказок ИИ и затем валидировать вручную.
- Зафиксировать обязательные версии инструментов (Node.js 20 LTS, Corepack, `pnpm@9`) для фронтенда в общих гайдах и README.

### Прогресс
- ✅ Автоматизирован быстрый старт окружения: `scripts/bootstrap-local.sh` выполняет синхронизацию `.env`, запуск `docker compose`, настройку RabbitMQ, миграции, seeds и smoke-проверку с агрегированным отчётом; документация (`README.md`, `docs/local-setup.md`) дополнена разделами «Быстрый старт» с перечислением зависимостей и последовательности шагов.【F:scripts/bootstrap-local.sh†L1-L133】【F:README.md†L5-L22】【F:docs/local-setup.md†L1-L33】
- ✅ Bootstrap дополнительно переведён в неинтерактивный режим синхронизации `.env`, ожидает готовности контейнеров после `docker compose up` и проверяет обязательное наличие Python 3, оставляя `psql`/`redis-cli`/`curl` опциональными — обновлена документация о требованиях и быстром старте.【F:scripts/bootstrap-local.sh†L31-L139】【F:scripts/sync-env.sh†L1-L102】【F:README.md†L9-L35】【F:docs/local-setup.md†L34-L74】
- ✅ Улучшены автоматизированные smoke-проверки инфраструктуры: `scripts/check-local-infra.sh` по умолчанию использует `docker compose exec`, обрабатывает остановленные контейнеры и логирует выбранный режим; обновлён `docs/local-setup.md` — раздел 5 подчёркивает Docker-режим smoke-check и fallback на локальные CLI. 【F:scripts/check-local-infra.sh†L1-L192】【F:docs/local-setup.md†L225-L255】
- ✅ README синхронизирован с автоматизацией локального запуска: раздел «Быстрый старт» подчёркивает работу `bootstrap-local.sh` через Docker Compose и делает CLI `psql`/`redis-cli`/`curl` опциональными благодаря обновлённым `sync-env` и smoke-check; `docs/local-setup.md` содержит ссылку на переработанный раздел smoke-check и список шагов, выполняемых автоматически.【F:README.md†L11-L26】【F:docs/local-setup.md†L8-L26】
- ✅ Улучшены автоматизированные smoke-проверки инфраструктуры: `scripts/check-local-infra.sh` по умолчанию использует `docker compose exec`, обрабатывает остановленные контейнеры и логирует выбранный режим; обновлён `docs/local-setup.md` с описанием требований и fallback-сценариев. 【F:scripts/check-local-infra.sh†L1-L192】【F:docs/local-setup.md†L137-L164】
- ✅ Автоматизировано создание vhost-ов RabbitMQ: скрипт `infra/rabbitmq/bootstrap.sh` читает `*_RABBITMQ_URL` из `.env`, а в `docs/local-setup.md` описан идемпотентный сценарий запуска; `env.example` служит единым источником правды для перечисления очередей.【F:infra/rabbitmq/bootstrap.sh†L1-L115】【F:docs/local-setup.md†L101-L133】【F:env.example†L33-L75】
- ✅ Добавлен автоматизированный smoke-check инфраструктурных зависимостей: `docs/local-setup.md` фиксирует запуск `./scripts/check-local-infra.sh`, ожидаемый вывод и требования к утилитам, а README подчёркивает его использование перед стартом приложений.【F:docs/local-setup.md†L198-L228】【F:README.md†L29-L37】
- ✅ Обновлены переменные окружения и инструкции: `env.example` включает согласованные порты и адреса SSE-потоков Gateway, а в `docs/local-setup.md` отражены проверки heartbeat и маршруты для обновлённых портов. Исправлены несоответствия, вызывавшие ошибки SSE и конфликт портов при локальном запуске.【F:env.example†L97-L134】【F:docs/local-setup.md†L8-L34】
- ✅ Добавлены переменные `AUTH_JWT_ISSUER`, `AUTH_JWT_SECRET`, `AUTH_JWT_AUDIENCE`, а также значения TTL для access/refresh токенов — шаблон `env.example` служит единой точкой правды для всех команд и синхронизирован с конфигурацией Auth.【F:env.example†L120-L143】
- ✅ Фронтенд-документация и локальный гайд актуализированы: `frontend/README.md` ссылается на обновлённые переменные окружения, а `docs/local-setup.md` подчёркивает обязательность пересборки `.env` после изменения JWT-настроек Auth.【F:frontend/README.md†L1-L75】【F:docs/local-setup.md†L55-L71】
- ✅ Требования локальной среды уточнены: фронтенд переведён на Next.js 15 и React 19, а документация фиксирует установку Node.js 20 LTS, включение Corepack и активацию `pnpm@9` перед запуском фронтенда.【F:docs/local-setup.md†L34-L60】【F:docs/dependencies.md†L8-L41】【F:docs/tech-stack.md†L104-L136】【F:frontend/README.md†L6-L36】
- ✅ Синхронизированы SSE-маршруты Gateway: публичный поток `/api/v1/streams/deals` и алиас `/api/v1/streams/crm` задокументированы, а e2e-тест подтверждает проксирование через upstream `crm` для этапа миграции.【F:backend/gateway/README.md†L18-L32】【F:docs/api/streams.md†L16-L36】【F:backend/gateway/test/app.e2e-spec.ts†L123-L156】
- ✅ Инструкция по полной очистке локальной среды уточнена: `docs/local-setup.md` рекомендует `docker compose down -v`, удаление только игнорируемых каталогов данных в `infra/` и подчёркивает возможность восстановить seed-файлы через `git checkout -- backups/postgres/seeds`.
- ✅ Обновления оплат транслируются через канал сделок: публичный маршрут `GET /api/v1/streams/deals` агрегирует события CRM, а документация фиксирует публикацию `deal.updated` с блоком оплаты вместо отдельного платежного потока.【F:backend/gateway/src/sse/sse.controller.ts†L21-L35】【F:docs/api/streams.md†L16-L37】
- ✅ Автоматизирована базовая подготовка БД для CRM и Auth: добавлен скрипт `scripts/migrate-local.sh`, обновлены инструкции в `docs/local-setup.md`, README сервисов и синхронизированы требования к окружению.【F:scripts/migrate-local.sh†L1-L37】【F:docs/local-setup.md†L137-L156】【F:backend/crm/README.md†L70-L86】【F:backend/auth/README.md†L45-L61】
- ✅ Автоматизирована синхронизация `.env`: `scripts/sync-env.sh` создаёт файл в корне репозитория и основных сервисах с едиными подсказками, а `docs/local-setup.md` включает чек-лист ручной проверки секретов после копирования шаблона.【F:scripts/sync-env.sh†L1-L78】【F:docs/local-setup.md†L119-L129】
- 🔁 После следующих изменений инфраструктуры пересмотреть план и автоматически подтвердить актуальность через обновление соответствующих разделов, чтобы требование об обновлённости документа выполнялось по умолчанию.

## Этап 2. Бэкенд-ядро (Gateway, Auth, CRM/Deals)
- **Gateway/BFF (NestJS)**: поддерживать проект с REST/SSE-проксированием, интеграцией Redis и Consul, контрактными тестами. Использовать ИИ для генерации шаблонов контроллеров и тестов, а также ревью конфигураций.
- **Auth (Spring Boot WebFlux)**: поддерживать сервис с R2DBC, Liquibase, управлением ролями, интеграцией Redis и Telegram-ботом. Применять ИИ для генерации миграций и проверки схем безопасности.
- **CRM/Deals (FastAPI)**: развивать дальше модель клиентов, сделок, полисов и событий, интегрировать Celery и RabbitMQ. Использовать ИИ для генерации CRUD-эндпоинтов, схем и документации.
- Для каждого сервиса синхронизировать API-контракты с фронтендом, поддерживать миграции и тесты. Применять ИИ для автоматического сравнения спецификаций и генерации OpenAPI.

### Статус этапа 2
- ✅ Gateway/BFF: реализовано проксирование REST/SSE, heartbeat и тестовые сценарии; подробности в [`backend/gateway/README.md`](../backend/gateway/README.md).【F:backend/gateway/README.md†L4-L36】
- ✅ Синхронизирован публичный маршрут сделок: `GET /api/v1/streams/deals` заменяет старый `/crm`, добавлен обратный алиас и e2e-тест потоков, а документация отражает актуальное имя канала.【F:backend/gateway/src/sse/sse.controller.ts†L21-L32】【F:backend/gateway/test/app.e2e-spec.ts†L142-L206】【F:docs/api/streams.md†L12-L37】【F:backend/gateway/README.md†L17-L24】
- ✅ Auth: сервис WebFlux с R2DBC, ролями и миграциями зафиксирован в [`backend/auth/README.md`](../backend/auth/README.md).【F:backend/auth/README.md†L1-L64】
- ✅ CRM/Deals: доменные модели, RabbitMQ и Celery описаны в [`backend/crm/README.md`](../backend/crm/README.md).【F:backend/crm/README.md†L1-L68】

## Этап 3. Доменные сервисы второй волны
- **CRM/Deals — модуль оплат**: расширить существующий сервис обработкой событий RabbitMQ, миграциями Flyway и экспортом CSV. ИИ помогает в генерации валидаторов и обработчиков ошибок.
- **Documents (NestJS + локальное файловое хранилище)**: описать модель метаданных, управление каталогами и ACL, интеграцию с BullMQ и файловым шлюзом. ИИ участвует в проектировании структуры каталогов, генерации политик прав доступа/ACL и проверке сценариев резервного копирования.
- **Tasks (NestJS)**: управление задачами, TypeORM, RabbitMQ, BullMQ. ИИ используется для генерации расписаний, SLA-проверок и документации будущих расширений.
- **Notifications (NestJS)**: REST/SSE, RabbitMQ, rate limiting на Redis, вебхуки Telegram. ИИ помогает в составлении маршрутов доставки и сценариев тестирования.
- **Backup (FastAPI + APScheduler)**: бэкапы PostgreSQL/Redis/RabbitMQ/Consul, уведомления об инцидентах. ИИ ассистирует в генерации скриптов бэкапа и проверочных чек-листов.
- После реализации сервисов синхронизировать `env.example`, схемы очередей и инструкции запуска. ИИ используется для автоматической проверки несоответствий в конфигурациях.

## Этап 4. Фронтенд и UX
- Поддерживать Next.js 15 (App Router) проект на React 19 с React Query, Zustand, интеграцией REST/SSE, сборкой в CI/CD. ИИ помогает в генерации компонентов, хуков и тестов Playwright.
- Разработать дизайн-токены и макеты в `docs/frontend/`, `docs/frontend/mockups`. Использовать ИИ для прототипирования визуальных компонентов, генерации токенов и описаний UX.
- Поддерживать Next.js 14 (App Router) проект с React Query, Zustand, интеграцией REST/SSE, сборкой в CI/CD. ИИ помогает в генерации компонентов, хуков и тестов Playwright.
- Разработать дизайн-токены и макеты в `docs/frontend/`, `docs/frontend/mockups`, синхронизируя рабочие JSON и индекс в `frontend/src/design-tokens`. Использовать ИИ для прототипирования визуальных компонентов, генерации токенов и описаний UX.
- Вести README и Storybook-инструкции, фиксируя сценарии для ролей. ИИ применяется для генерации пользовательских сценариев и проверки согласованности терминов.

### Прогресс этапа 4
- ✅ Актуализированы требования фронтенда: `docs/local-setup.md` фиксирует стек Next.js 15/React 19 и подчёркивает необходимость Node.js 20 LTS с `pnpm@9` для запуска проекта.【F:docs/local-setup.md†L28-L33】【F:docs/local-setup.md†L39-L52】
- ✅ API-клиент фронтенда поддерживает автономный режим моков: значение `NEXT_PUBLIC_API_BASE_URL=mock` отключает сетевые запросы, а тесты Vitest подтверждают возврат данных из `src/mocks`. Документация (`frontend/README.md`, `env.example`) дополнена подсказками по включению режима.
- ✅ API-клиент фронтенда поддерживает таймауты: `FRONTEND_PROXY_TIMEOUT` пробрасывается в runtime Next.js, используется для отмены fetch-запросов и проксирования, а документация и `env.example` фиксируют дефолт 15 секунд.
- ✅ Улучшен локальный старт фронтенда: скрипты `pnpm dev`/`pnpm start` автоматически пробрасывают `FRONTEND_SERVICE_PORT` в `PORT`, Playwright использует ту же переменную, а документация (`frontend/README.md`, `docs/local-setup.md`, `env.example`) объясняет переопределение порта для Next.js.【F:frontend/package.json†L7-L11】【F:frontend/scripts/run-with-port.mjs†L1-L28】【F:frontend/playwright.config.ts†L3-L29】【F:frontend/README.md†L8-L42】【F:docs/local-setup.md†L76-L101】【F:env.example†L118-L133】
- ✅ Подписи источников в NotificationCenter унифицированы (CRM, модуль платежей, Уведомления), добавлен компонентный тест и актуализирована документация `docs/frontend/notifications.md`.
- ✅ Таблица платежей использует доменные статусы `planned/expected/received/paid_out/cancelled`, обновлены моки и тест, а документация `docs/frontend/payments.md` подтверждена как источник правды по отображению бейджей.

## Этап 5. Тестовые данные, QA и документация
- Подготовить seed-наборы для Auth, CRM/Deals (включая оплату), Documents, Tasks, Notifications в `backups/postgres/seeds`. ИИ помогает генерировать репрезентативные данные и сценарии проверки.
- Настроить процедуры загрузки seed-данных и контрольных запросов, задокументировать процесс для разработчиков и QA.
- Сформировать комплексный план тестирования (unit, интеграционные, контрактные, e2e, smoke) и интегрировать в CI/CD. Использовать ИИ для генерации тест-кейсов и проверки покрытия.
- Обновлять документацию и `env.example` при каждом изменении конфигураций, поддерживая единый источник правды.

### Прогресс этапа 5
- ✅ Подготовлен первый seed-набор (Auth → CRM с модулем оплат) и автоматизировано его применение: добавлены SQL-файлы, README каталога `seeds`, скрипт [`scripts/load-seeds.sh`](../scripts/load-seeds.sh) и обновлённые разделы `docs/testing-data.md`, `docs/local-setup.md`. Инструкция подчёркивает, что `env.example` остаётся источником правды для параметров подключения, а `README` делает `./scripts/load-seeds.sh` основным сценарием с ручными командами как fallback.

## Практики взаимодействия с ИИ
- Согласовать гайдлайны по использованию ИИ (безопасность, конфиденциальность данных, валидация результатов человеком).
- Автоматизировать проверку PR с помощью ИИ-ботов для рекомендаций и обнаружения уязвимостей, сохраняя финальное решение за командой.
- Проводить регулярные ретроспективы использования ИИ, фиксируя успешные кейсы и зоны риска.

## Коммуникация и дальнейшие шаги
- Команда уведомлена о свежем статусе документа; план используется как основной источник правды при декомпозиции следующих задач.
