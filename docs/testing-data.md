# Тестовые данные CRM 2.0

## Назначение

Набор тестовых данных помогает быстро воспроизводить ключевые бизнес-процессы (инициация сделки, расчёт полиса, фиксация платежей, напоминания по задачам) в локальной среде и на стендах QA. Файлы предназначены для ручной валидации пользовательских сценариев и smoke-проверок после обновлений схемы БД.

## Состав стандартного набора

Каталог `backups/postgres/seeds` хранит идемпотентные SQL- и XML-файлы seed-миграций. Названия следуют шаблону `seed_YYYYMMDD_<домен>.sql` или `seed_YYYYMMDD_<домен>.xml`, что позволяет отслеживать хронологию изменений.

| Домен | Содержимое | Назначение |
| --- | --- | --- |
| Auth | Пользователи внутренних ролей (администратор, продавец, исполнитель, финансовый менеджер, руководитель) с тестовыми паролями и привязками к Telegram. | Быстрый вход в приложение и проверка разграничения доступа. |
| CRM / Deals | Клиенты (физическое и юрлицо), две активные сделки, расчёты с разными страховыми компаниями, шаблонные статусы и причины закрытия. | Отработка карточки клиента, журнала сделки и маршрута согласования. |
| Payments | Плановые и фактические платежи по полисам, комиссии, скидки и выплаты исполнителям. | Проверка расчётов комиссий и дашборда платежей. |
| Documents | Метаданные файлов, связанные с папками сделок и полисов. | Демонстрация интеграции с Documents-сервисом и связей с Google Drive. |
| Tasks | Задачи с напоминаниями и историей активности для продавца и исполнителя. | Тестирование SLA и оповещений по задачам. |
| Notifications | Шаблоны уведомлений и примеры доставленных событий. | Проверка отображения уведомлений во фронтенде и Telegram-боте. |

Каждый файл начинается с блока комментариев: ссылка на задачу, краткое описание и список зависимых справочников. Если seed затрагивает несколько доменов, в каталоге хранится отдельный README с инструкциями по порядку применения.

## Процедура загрузки

1. Подготовьте окружение согласно [docs/local-setup.md](local-setup.md): создайте `.env`, поднимите инфраструктурные контейнеры и примените миграции сервисов (`alembic upgrade head`, `liquibase update` и т.д.).
2. Проверьте, что в `.env` заполнены переменные подключения к PostgreSQL (`POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`).
3. Выполните загрузку seed-файлов в нужном порядке (как правило, `auth` → `crm` → `payments` → `documents` → `tasks` → `notifications`). Пример для Linux/macOS:
   ```bash
   export PGPASSWORD="$POSTGRES_PASSWORD"
   for file in backups/postgres/seeds/seed_*.sql; do
     [ -e "$file" ] || continue
     psql -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -v ON_ERROR_STOP=1 -f "$file"
   done
   unset PGPASSWORD
   ```
   Для XML-файлов Liquibase используйте команду сервиса-владельца (см. README соответствующего сервиса).
4. При необходимости добавьте локальные правки в отдельный файл `seed_<дата>_local.sql` и держите его вне git (например, в `.gitignore`), чтобы не повлиять на общий набор.

## Проверка корректности

После загрузки выполните контрольные запросы:

* `SELECT COUNT(*) FROM auth.users WHERE email LIKE '%@example.com';` — убедитесь, что созданы тестовые аккаунты.
* `SELECT COUNT(*) FROM crm.deals WHERE status = 'in_progress';` — должны присутствовать активные сделки.
* `SELECT COUNT(*) FROM payments.payments WHERE status IN ('planned', 'received');` — проверка финансовых записей.

Если значения отличаются от ожидаемых, пересмотрите применённые миграции и порядок seed-файлов. Повторный запуск процедуры должен завершаться без ошибок благодаря идемпотентности скриптов.

## Актуализация набора

* Любые изменения в тестовых данных фиксируйте отдельным seed-файлом и обновляйте комментарий с номером задачи.
* После публикации новой миграции обновите эту инструкцию, если изменился порядок применения или состав данных.
* Для QA-стендов храните список актуальных файлов в Wiki команды и синхронизируйте его с содержимым `backups/postgres/seeds`.
