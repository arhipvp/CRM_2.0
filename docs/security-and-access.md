# Правила безопасности и доступа

## Обзор ролей и операций

| Роль | Клиенты | Сделки | Журнал сделки | Документы | Полисы | Платежи | Задачи | Отчёты и метрики | Управление пользователями и ролями |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Продавец | Просмотр, создание, редактирование своих клиентов | Просмотр, создание, редактирование сделок, где он участник; удаление до запуска оформления | Просмотр и редактирование для своих сделок | Просмотр и загрузка файлов в свои папки | Просмотр и редактирование полисов своих сделок | Просмотр и создание записей по своим платежам; редактирование до подтверждения | Просмотр и выполнение задач, где он исполнитель; создание задач в своих сделках | Просмотр персональных метрик | Нет доступа |
| Исполнитель | Просмотр клиентов, назначенных через сделки | Просмотр и редактирование полей, относящихся к оформлению; создание полисов в своих сделках | Просмотр и добавление заметок о ходе исполнения | Просмотр и загрузка файлов в папки сделок, где он назначен | Просмотр, создание и редактирование полисов, где он назначен исполнителем | Просмотр платежей своих сделок и добавление служебных комментариев без изменения сумм и статусов | Просмотр и выполнение назначенных задач | Нет доступа | Нет доступа |
| Финансовый менеджер | Просмотр всех клиентов | Просмотр всех сделок | Просмотр журналов сделок | Просмотр файлов, относящихся к платежам и актам | Просмотр полисов | Создание, подтверждение и корректировка платежей без удаления: перевод статусов, фиксация отмен через редактирование с комментариями и историями; контроль распределений | Просмотр задач по платежам | Просмотр финансовых отчётов | Нет доступа |
| Руководитель | Просмотр всех клиентов | Просмотр всех сделок | Просмотр журналов сделок | Просмотр документов по сделкам | Просмотр всех полисов | Просмотр платежей | Просмотр задач | Просмотр всех отчётов и метрик | Нет доступа |
| Администратор | Просмотр всех клиентов | Просмотр, создание, редактирование и удаление любых сделок (для администрирования) | Просмотр | Управление структурами папок и доступами | Просмотр | Просмотр | Просмотр | Просмотр | Полное управление пользователями, ролями и настройками |

**Примечания:**
- Удаление сделок допускается только администратором (для исправления ошибок) или продавцом до перехода сделки в стадию оформления (когда нет оформленных полисов и платежей).
- Все операции журналируются в сервисе Audit.

## Доступ к ключевым ресурсам

### Папки Google Drive
- **Продавец**: автоматический доступ к корневой папке клиента и всем вложенным папкам своих сделок. Может добавлять и удалять файлы в пределах своих сделок.
- **Исполнитель**: доступ на чтение/запись к папкам сделок, где он назначен, включая дочерние папки полисов. Не имеет доступа к папкам других сделок.
- **Финансовый менеджер**: доступ на чтение к папкам разделов «Платежи», актов и отчётности по всем сделкам; не может изменять структуру.
- **Руководитель**: доступ на чтение к полным структурам папок всех сделок для контроля, без права удаления.
- **Администратор**: полный доступ ко всем папкам, управление правами совместного доступа и шаблонами структуры.

### Журнал сделки
- **Продавец**: может создавать, редактировать и просматривать записи в журналах сделок, где он участник.
- **Исполнитель**: может просматривать и дополнять журнал сделок, где назначен исполнителем, включая технические комментарии.
- **Финансовый менеджер**: имеет доступ на чтение ко всем журналам сделок.
- **Руководитель**: имеет доступ на чтение ко всем журналам сделок для мониторинга.
- **Администратор**: имеет доступ на чтение ко всем журналам, может скрывать или архивировать записи по запросу руководителя.

### Платежи
- **Продавец**: создаёт плановые и фактические записи о комиссионных и выплатах исполнителям в рамках своих сделок; может редактировать до подтверждения финансовым менеджером.
- **Исполнитель**: просматривает связанные платежи, добавляет служебные комментарии о готовности документов и сопроводительных действиях, но не изменяет финансовые суммы и статусы.
- **Финансовый менеджер**: управляет всеми платежами (создание, подтверждение и корректировка параметров без удаления; оформление отмен через редактирование с комментариями и историями), формирует отчёты по план/факт и контролирует распределение комиссий.
- **Руководитель**: просматривает все платежи и их статус, но не изменяет.
- **Администратор**: имеет доступ на просмотр ко всем платежам для аудита; может вмешаться по запросу руководства.

## Процедуры выдачи и отзыва доступа

1. **Назначение роли новому пользователю**
   - Администратор создаёт учетную запись, присваивает одну или несколько ролей и фиксирует это в журнале изменений.
   - Auth-сервис синхронизирует роли с Documents и другими сервисами; автоматически выдаются соответствующие права к папкам, журналам и платежам.

2. **Добавление участника в сделку**
   - Ответственный за сделку (обычно продавец) инициирует назначение исполнителя или финансового менеджера.
   - CRM/Deals уведомляет Auth и Documents о новых участниках, что запускает автоматическую выдачу доступа к папкам и журналу сделки.
   - Уведомление отправляется участнику с перечнем полученных доступов.

3. **Смена роли пользователя**
   - Администратор обновляет список ролей в Auth.
   - Система автоматически пересчитывает и выдаёт новые права:
     - новые роли -> выдача доступа к соответствующим ресурсам;
     - снятые роли -> отзыв доступа (прекращение подписок на папки Drive, журнал сделок, платежные разделы).
   - Изменения фиксируются в Audit; участник получает уведомление о новых правах.

4. **Вывод участника из сделки**
   - Ответственный за сделку инициирует действие «Удалить участника» в CRM.
   - CRM отправляет событие в Auth/Documents/Payments для немедленного прекращения доступа к журналу, папкам и платежам данной сделки.
   - История действий участника остаётся в системе, но новые записи создаёт уже другой назначенный пользователь.

5. **Отзыв прав при увольнении или блокировке**
   - Администратор блокирует пользователя в Auth, что мгновенно отключает все сессии и доступы.
   - Documents удаляет пользователя из всех общих папок в Google Drive.
   - Payments и CRM закрывают все задачи и напоминания, переназначая на руководителя или нового исполнителя.

6. **Периодический пересмотр прав**
   - Ежеквартально руководитель и администратор проводят сверку активных ролей и доступов.
   - Результаты сверки фиксируются в отчёте и в Audit.

Эти правила обеспечивают согласованное управление доступами во всех сервисах системы и минимизируют риск утечек данных.
