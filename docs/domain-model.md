# Модель данных

Документ описывает целевую модель данных CRM-решения для страхового брокера. Сущности и их связи согласованы с ключевыми бизнес-процессами: ведение клиентов, сопровождение сделок, подготовка расчётов, выпуск полисов, управление платежами и задачами.

## Клиент

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id` | UUID | да | Уникальный идентификатор клиента. |
| `type` | enum(`individual`, `corporate`) | да | Тип клиента: физическое или юридическое лицо. |
| `full_name` | string | да (для `individual`) | Полное имя физического лица. |
| `company_name` | string | да (для `corporate`) | Юридическое наименование компании. |
| `date_of_birth` | date | нет | Дата рождения физического лица. |
| `tax_id` | string | да | ИНН/УНП; уникален внутри системы. |
| `documents_folder_url` | string | нет | Ссылка на папку клиента в хранилище документов. |
| `notes` | text | нет | Внутренние примечания менеджеров. |
| `created_at` | datetime | да | Дата и время создания карточки клиента. |
| `updated_at` | datetime | да | Дата последнего изменения. |
| `deleted_at` | datetime | нет | Мягкое удаление; время деактивации записи. |

**Бизнес-правила**
- `tax_id` уникален и проверяется по формату, принятому в стране регистрации.
- Для клиентов типа `individual` заполняется `full_name`, для `corporate` — `company_name`.

## Телефон клиента

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id` | UUID | да | Уникальный идентификатор телефона. |
| `client_id` | UUID (FK → Клиент) | да | Клиент-владелец номера. |
| `phone` | string | да | Телефонный номер в международном формате. |
| `is_primary` | boolean | нет | Признак основного контактного номера. |
| `notes` | text | нет | Комментарии по номеру (например, «рабочий телефон»). |
| `created_at` | datetime | да | Дата и время добавления номера. |
| `updated_at` | datetime | да | Дата последнего изменения записи. |
| `deleted_at` | datetime | нет | Мягкое удаление номера. |

## Почтовый адрес клиента

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id` | UUID | да | Уникальный идентификатор адреса. |
| `client_id` | UUID (FK → Клиент) | да | Клиент-владелец адреса. |
| `email` | string | да | Электронная почта (формат RFC 5322). |
| `is_primary` | boolean | нет | Признак основного адреса. |
| `is_verified` | boolean | нет | Отмечает факт подтверждения адреса. |
| `notes` | text | нет | Примечания по использованию почты. |
| `created_at` | datetime | да | Дата и время добавления адреса. |
| `updated_at` | datetime | да | Дата последнего изменения записи. |
| `deleted_at` | datetime | нет | Мягкое удаление адреса. |

## Сделка

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id` | UUID | да | Уникальный идентификатор сделки. |
| `client_id` | UUID (FK → Клиент) | да | Клиент, для которого ведётся сделка. |
| `title` | string | да | Название сделки. |
| `status` | enum(`lead`, `qualification`, `proposal`, `won`, `lost`) | да | Текущая стадия сделки. |
| `product_line` | string | да | Направление/тип страхового продукта. |
| `source` | enum(`manual`, `web`, `partner`) | нет | Канал привлечения. |
| `responsible_id` | UUID | да | Сотрудник, ответственный за сделку. |
| `documents_folder_url` | string | нет | Ссылка на папку сделки в хранилище документов. |
| `notes` | text | нет | Примечания менеджера по сделке. |
| `created_at` | datetime | да | Дата и время регистрации сделки. |
| `updated_at` | datetime | да | Дата последнего изменения. |
| `deleted_at` | datetime | нет | Мягкое удаление сделки. |

## Расчёт

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id` | UUID | да | Уникальный идентификатор расчёта. |
| `deal_id` | UUID (FK → Сделка) | да | Сделка, для которой подготовлен расчёт. |
| `version` | integer | да | Номер версии расчёта для сделки. |
| `insurance_type` | string | да | Вид страхования. |
| `insurer` | string | да | Страховая компания, предоставившая расчёт. |
| `premium_amount` | decimal(18,2) | да | Страховая премия. |
| `coverage_amount` | decimal(18,2) | да | Страховая сумма. |
| `franchise_amount` | decimal(18,2) | нет | Размер франшизы. |
| `terms` | text | нет | Существенные условия предложения. |
| `notes` | text | нет | Дополнительные комментарии (например, по переговорам). |
| `created_at` | datetime | да | Дата и время расчёта. |
| `updated_at` | datetime | да | Дата последнего изменения. |
| `deleted_at` | datetime | нет | Мягкое удаление расчёта. |

**Бизнес-правила**
- `premium_amount` и `coverage_amount` не могут быть отрицательными и округляются до двух знаков.
- Для каждой сделки версии расчётов нумеруются последовательно, начиная с 1.

## Полис

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id` | UUID | да | Уникальный идентификатор полиса. |
| `deal_id` | UUID (FK → Сделка) | да | Сделка, по которой выпущен полис. |
| `policyholder_id` | UUID (FK → Клиент) | нет | Страхователь; может отличаться от клиента сделки. |
| `policy_number` | string | да | Уникальный номер полиса. |
| `status` | enum(`draft`, `active`, `suspended`, `cancelled`, `expired`) | да | Статус жизненного цикла полиса. |
| `effective_from` | date | да | Дата начала действия. |
| `effective_to` | date | да | Дата окончания действия. |
| `insurer` | string | да | Страховая компания-эмитент. |
| `issued_at` | datetime | да | Дата и время выпуска полиса. |
| `documents_folder_url` | string | нет | Ссылка на папку полиса в хранилище документов. |
| `notes` | text | нет | Внутренние комментарии по полису. |
| `created_at` | datetime | да | Дата создания записи о полисе. |
| `updated_at` | datetime | да | Дата последнего изменения. |
| `deleted_at` | datetime | нет | Мягкое удаление полиса. |

**Бизнес-правила**
- `policy_number` уникален в пределах страховой компании.
- Даты действия полиса должны обеспечивать положительную длительность (`effective_to` > `effective_from`).
- Статус `active` возможен только при наличии оплаченной первой квитанции (Платёж в статусе `paid`).

## Транспортное средство полиса

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id` | UUID | да | Уникальный идентификатор записи о транспортном средстве. |
| `policy_id` | UUID (FK → Полис) | да | Полис, к которому относится автомобиль. |
| `vin` | string | нет | VIN автомобиля. |
| `license_plate` | string | да | Государственный номер. |
| `make` | string | да | Марка автомобиля. |
| `model` | string | да | Модель автомобиля. |
| `manufacture_year` | integer | нет | Год выпуска. |
| `notes` | text | нет | Дополнительные сведения (например, модификации). |
| `created_at` | datetime | да | Дата добавления записи. |
| `updated_at` | datetime | да | Дата последнего изменения. |
| `deleted_at` | datetime | нет | Мягкое удаление записи. |

## Платёж

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id` | UUID | да | Уникальный идентификатор платежа. |
| `policy_id` | UUID (FK → Полис) | да | Полис, к которому относится платёж. |
| `amount` | decimal(18,2) | да | Сумма платежа. |
| `due_date` | date | да | Дата плановой оплаты. |
| `paid_at` | datetime | нет | Фактическая дата оплаты. |
| `status` | enum(`pending`, `partial`, `paid`, `overdue`, `cancelled`) | да | Статус платежа. |
| `notes` | text | нет | Комментарии к оплате. |
| `created_at` | datetime | да | Дата и время создания платежа. |
| `updated_at` | datetime | да | Дата последнего изменения. |
| `deleted_at` | datetime | нет | Мягкое удаление платежа. |

**Бизнес-правила**
- `amount` должна быть > 0; при частичной оплате фиксируется отдельная запись с статусом `partial`.
- При наступлении `due_date` и отсутствии `paid_at` статус автоматически меняется на `overdue`.
- Сумма оплаченных платежей по полису не может превышать сумму по графику платежей.

## Задача

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id` | UUID | да | Уникальный идентификатор задачи. |
| `entity_type` | enum(`client`, `deal`, `policy`, `payment`) | да | Сущность, к которой относится задача. |
| `entity_id` | UUID | да | Идентификатор сущности. |
| `title` | string | да | Короткое описание задачи. |
| `description` | text | нет | Детальное описание. |
| `status` | enum(`open`, `in_progress`, `done`, `cancelled`) | да | Статус задачи. |
| `priority` | enum(`low`, `medium`, `high`, `urgent`) | да | Приоритет выполнения. |
| `assignee_id` | UUID | да | Ответственный сотрудник. |
| `due_date` | datetime | да | Крайний срок выполнения. |
| `completed_at` | datetime | нет | Фактическое время завершения. |
| `notes` | text | нет | Дополнительные комментарии. |
| `created_at` | datetime | да | Дата и время создания. |
| `updated_at` | datetime | да | Дата последнего изменения. |
| `deleted_at` | datetime | нет | Мягкое удаление задачи. |

**Бизнес-правила**
- `due_date` не может быть в прошлом на момент создания задачи.
- Статус `done` требует заполнения `completed_at`.
- Для задач с приоритетом `urgent` создаётся уведомление ответственному сотруднику.

## Связи между сущностями

| От | К | Тип связи | Описание |
| --- | --- | --- | --- |
| Клиент | Сделки | 1:N | Один клиент может иметь несколько сделок. |
| Клиент | Телефоны | 1:N | Клиенту может принадлежать несколько телефонных номеров. |
| Клиент | Почтовые адреса | 1:N | Клиент может использовать несколько e-mail адресов. |
| Сделка | Расчёты | 1:N | Сделка содержит несколько версий расчётов страховых предложений. |
| Сделка | Полисы | 1:N | Из выигранной сделки может быть выпущено несколько полисов. |
| Полис | Платежи | 1:N | Один полис включает несколько платежей по графику. |
| Полис | Транспортные средства | 1:N | Полис может включать несколько автомобилей. |
| Клиент/Сделка/Полис/Платёж | Задачи | 1:N | По каждой сущности может быть назначено несколько задач. |

Текстовая диаграмма связей:

```
Клиент
  ├─ Телефон
  ├─ Почтовый адрес
  └─ Сделка ─┬─ Расчёт
             └─ Полис ─┬─ Платёж
                        └─ Транспортное средство
Задача относится к: Клиент | Сделка | Полис | Платёж
```
