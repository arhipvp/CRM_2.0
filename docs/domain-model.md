# Структура данных и доменные статусы

> Для описания физической модели (ER-диаграмм, таблиц и ограничений) см. документ [docs/data-model.md](data-model.md).

## Структура сущностей

### Клиент

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор клиента. |
| type | Enum (`individual`, `company`) | Да | Тип клиента: физическое или юридическое лицо. |
| full_name | String | Да | ФИО (для физлица) или полное наименование (для юрлица). |
| short_name | String | Нет | Краткое имя для отображения в интерфейсе и структуре папок. |
| tax_number | String | Нет | ИНН/ИНП или аналогичный идентификатор, хранится как текст без валидации формата. |
| registration_number | String | Нет | ОГРН/ОГРНИП или другой регистрационный номер. |
| segment | String | Нет | Свободное текстовое описание сегмента/категории клиента. |
| status | Enum (`potential`, `active`, `inactive`) | Да | Текущий статус взаимоотношений с клиентом. |
| contacts | Array<КонтактноеЛицо> | Нет | Список контактных лиц клиента. |
| notes | Text | Нет | Общие примечания, история договорённостей. |

**Контактное лицо клиента**

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| name | String | Да | Имя и фамилия контактного лица. |
| position | String | Нет | Должность или роль. |
| phone | String | Нет | Телефон, хранится в текстовом виде. |
| email | String | Нет | Адрес электронной почты. |
| notes | String | Нет | Дополнительные примечания по контактному лицу. |

### Сделка

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор сделки. |
| client_id | UUID | Да | Ссылка на клиента. |
| title | String | Да | Краткое название сделки (используется в структуре папок). |
| description | Text | Нет | Подробное описание объекта страхования. |
| sales_agent_id | UUID | Да | Ведущий пользователь сделки (ответственный менеджер). |
| executor_id | UUID | Нет | Назначенный пользователь, отвечающий за оформление полисов. |
| status | Enum (см. раздел «Сделки» ниже) | Да | Текущий статус сделки. |
| start_date | Date | Нет | Дата начала работы по сделке. |
| expected_close_date | Date | Нет | Плановая дата завершения/оформления. |
| next_review_at | Date (`YYYY-MM-DD`) | Да | Дата следующего обзора без времени. Используется для сортировки карточек и напоминаний; всегда заполнена валидной датой. |
| journal | Array<ЗаписьЖурнала> | Нет | Текстовые заметки и история действий. |
| documents_root | String | Нет | Относительный путь корневого каталога сделки в локальном хранилище. |

**Запись журнала сделки**

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор записи. |
| author_id | UUID | Да | Автор записи (пользователь). |
| created_at | DateTime | Да | Дата и время создания записи. |
| text | Text | Да | Содержимое заметки. |
| attachments | Array<String> | Нет | Относительные пути или опубликованные ссылки на документы из локального хранилища. |

### Расчёт

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор расчёта. |
| deal_id | UUID | Да | Ссылка на сделку. |
| insurance_company | String | Да | Название страховой компании (свободный текст). |
| program_name | String | Нет | Название страховой программы. |
| premium_amount | Decimal | Нет | Рассчитанная страховая премия. |
| coverage_sum | Decimal | Нет | Страховая сумма. |
| calculation_date | Date | Да | Дата получения расчёта. |
| validity_period | DateRange | Нет | Период актуальности расчёта. |
| files | Array<String> | Нет | Относительные пути к связанным документам или публичные ссылки из локального хранилища. |
| comments | Text | Нет | Комментарии пользователя. |

### Полис

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор полиса. |
| deal_id | UUID | Да | Ссылка на сделку. |
| client_id | UUID | Да | Ссылка на клиента (дублируется для ускорения выборок). |
| calculation_id | UUID | Нет | Связанный расчёт, если полис оформлен по конкретному предложению. |
| policy_number | String | Да | Номер полиса, текстовое поле. |
| insurer | String | Да | Название страховой компании. |
| program_name | String | Нет | Название программы страхования. |
| effective_from | Date | Да | Дата начала действия. |
| effective_to | Date | Да | Дата окончания действия. |
| premium_amount | Decimal | Да | Сумма страховой премии. |
| coverage_sum | Decimal | Нет | Страховая сумма. |
| status | Enum (см. раздел «Полисы») | Да | Текущий статус полиса. |
| documents | Array<String> | Нет | Ссылки на документы полиса. |

### Платёж

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор записи. |
| deal_id | UUID | Да | Ссылка на сделку (денормализованная связь для быстрых выборок). |
| policy_id | UUID | Да | Ссылка на полис; один полис может иметь несколько платежей, отражающих разные поступления/списания. |
| sequence | Integer | Да | Порядковый номер платежа в рамках полиса, начиная с `1`. |
| status | Enum (см. раздел «Платежи») | Да | Текущий статус платежа, вычисляемый CRM. |
| planned_date | Date | Нет | Плановая дата платежа, может отсутствовать для незапланированных движений. |
| planned_amount | Decimal | Да | Плановая сумма, фиксируемая на момент постановки платежа. |
| currency | String | Да | Валюта, код ISO 4217 (сейчас используется `RUB`). |
| actual_date | Date | Нет | Фактическая дата закрытия платежа; может оставаться пустой до подтверждения поступлений и расходов. |
| recorded_by_id | UUID | Нет | Пользователь, который вручную подтвердил факт оплаты; используется для аудита и отображения ответственного в интерфейсе. |
| incomes_total | Decimal | Да | Совокупная сумма поступлений, денормализованный агрегат. |
| expenses_total | Decimal | Да | Совокупная сумма расходов, денормализованный агрегат. |
| net_total | Decimal | Да | Разница `incomes_total - expenses_total`. |
| comment | Text | Нет | Дополнительные пояснения по оплате или источнику данных. |
| created_by_id | UUID | Да | Пользователь, который создал платёж. |
| updated_by_id | UUID | Нет | Пользователь, последним изменивший платёж. |
| created_at | DateTime | Да | Время создания записи платежа в CRM. |
| updated_at | DateTime | Да | Момент последнего редактирования записи и вложенных списков. |
| incomes | Array<ПлатёжнаяОперация> | Нет | Последние операции поступлений, упорядоченные по дате добавления. |
| expenses | Array<ПлатёжнаяОперация> | Нет | Последние операции расходов, упорядоченные по дате добавления. |

**Платёжная операция (`income`/`expense`)**

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор позиции. |
| payment_id | UUID | Да | Ссылка на платеж. |
| amount | Decimal | Да | Абсолютная сумма операции. |
| currency | String | Да | Код валюты операции (должен совпадать с валютой платежа). |
| category | String | Да | Тип статьи (например, «wire», «cash», «agency_fee», «refund»). |
| posted_at | Date | Да | Дата фиксации операции, не может быть в будущем. |
| note | Text | Нет | Комментарий с деталями расчёта. |
| created_by_id | UUID | Да | Пользователь, создавший операцию. |
| updated_by_id | UUID | Нет | Пользователь, последним изменивший операцию. |
| created_at | DateTime | Да | Момент создания записи операции. |
| updated_at | DateTime | Да | Момент последнего изменения записи. |

> **Примечания:**
> - Совокупные поля `incomes_total`, `expenses_total` и `net_total` вычисляются из фактических операций `incomes`/`expenses` и сохраняются денормализованно для ускорения отчётности.
> - Поле `actual_date` остаётся пустым, пока платёж не закрыт: дата заполняется автоматически по фактическим поступлениям или вручную ответственным пользователем.
> - При ручном закрытии платежа CRM сохраняет ссылку на пользователя (`recorded_by_id`), чтобы фиксировать ответственного за подтверждение поступления.
> - Статус (`status`) определяется бизнес-логикой CRM исходя из плановых данных, подтверждённых операций и ручных действий операторов.
> - Платёж может отражать как окончательную оплату по полису, так и промежуточные движения (частичные оплаты, возвраты, комиссии). История изменений позиций сохраняется средствами аудита CRM.
> - Таблицы `crm.payment_incomes` и `crm.payment_expenses` разделены: направление операции задаётся выбранным набором (отдельный endpoint/таблица), поэтому поле `type` в схеме отсутствует.

### Документ

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор записи документа. |
| owner_type | Enum (`client`, `deal`, `policy`, `payment`) | Да | Уровень привязки документа. |
| owner_id | UUID | Да | Идентификатор связанной сущности. |
| title | String | Да | Краткое наименование документа. |
| storage_path | String | Да | Относительный путь к файлу внутри `DOCUMENTS_STORAGE_ROOT`. |
| public_url | String | Нет | Публичная ссылка, если настроен `DOCUMENTS_STORAGE_PUBLIC_BASE_URL`. |
| directory_path | String | Нет | Подкаталог относительно корневого каталога владельца. |
| uploaded_by | UUID | Да | Пользователь, загрузивший документ. |
| uploaded_at | DateTime | Да | Дата и время загрузки. |
| document_type | String | Нет | Текстовый тип (полис, акт, расчёт и т.д.). |
| notes | Text | Нет | Дополнительные комментарии. |

### Задача

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор задачи. |
| subject | String | Да | Краткое название задачи. |
| description | Text | Да | Подробное описание действий без вложенных чек-листов. |
| deal_id | UUID | Нет | Ссылка на сделку. |
| policy_id | UUID | Нет | Ссылка на полис (если применимо). |
| payment_id | UUID | Нет | Ссылка на платеж (если применимо). |
| status | Enum (см. раздел «Задачи») | Да | Текущий статус задачи. |
| assignee_id | UUID | Да | Назначенный исполнитель. |
| author_id | UUID | Да | Постановщик задачи. |
| due_date | Date | Нет | Срок исполнения. |
| created_at | DateTime | Да | Дата и время создания. |
| updated_at | DateTime | Да | Дата и время последнего изменения. |

> Уведомления по задачам формируются автоматически в CRM и Telegram в соответствии с бизнес-процессами, ручных переключателей каналов нет.

# Доменные статусы и переходы

## Сделки

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Черновик | Создана карточка сделки, собраны исходные данные. | Создание сделки пользователем или импорт из внешнего источника. |
| На расчёте | Назначенный пользователь подбирает варианты страхования и готовит предложения. | Ведущий пользователь назначает коллегу и ставит задачу на подготовку расчётов. |
| Ожидает решения клиента | Команда представила расчёты, требуется выбор клиента. | Ответственный за расчёты пользователь завершает подготовку и помечает задачу как выполненную. |
| Оформление полиса | Клиент согласовал вариант, идёт подготовка документов и контроль оплаты. | Ведущий пользователь фиксирует выбранный вариант и создаёт задачу на оформление. |
| Активна | Полисы оформлены, как минимум один полис действует, ведётся сопровождение. | Ответственный за оформление регистрирует активный полис и подтверждённую оплату. |
| Закрыта | Сделка завершена: все полисы истекли или отменены, дальнейшие действия не планируются. | Любой пользователь с доступом закрывает сделку после истечения срока последнего полиса либо отказа клиента. |

**Переходы:**
- Черновик → На расчёте — после назначения ответственного за расчёты и постановки задачи.
- На расчёте → Ожидает решения клиента — когда расчёты добавлены и отмечены как готовые.
- Ожидает решения клиента → Оформление полиса — после согласования варианта с клиентом.
- Оформление полиса → Активна — после фиксации оплаты и регистрации полиса в системе.
- Любой активный статус → Закрыта — по завершении всех связанных полисов, письменному отказу клиента или отмене сделки.
- Закрыта → Черновик — недоступно (создаётся новая сделка вместо переоткрытия).

## Полисы

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Черновик | Полис готовится: внесены расчётные данные, но номер ещё не подтверждён. | Создание полиса назначенным пользователем или импорт из расчётов. |
| Действует | Полис оформлен, период покрытия активен. | Ответственный за оформление фиксирует дату начала действия и номер после получения подтверждения страховой. |
| Ожидает продления | Полис скоро истекает, требуется инициировать продление. | Автоматическое событие по наступлении даты напоминания или ручной перевод ответственным пользователем. |
| Закрыт | Полис истёк, отменён или заменён другим, обязательства выполнены. | Наступление даты окончания, отмена по заявлению клиента или фиксация пролонгации новым полисом. |

**Переходы:**
- Черновик → Действует — после подтверждения выпуска и ввода даты начала.
- Действует → Ожидает продления — за заданное количество дней до окончания или по решению менеджера начать продление.
- Действует → Закрыт — по досрочному расторжению или факту окончания без продления.
- Ожидает продления → Действует — при оформлении пролонгации без разрыва.
- Ожидает продления → Закрыт — если клиент отказался от продления либо срок закончился без пролонгации.
- Закрыт → Черновик — не применяется; создаётся новый полис.

## Платежи

Платёжная модель поддерживает несколько записей по одному полису: каждая запись агрегирует связанные поступления и списания, чтобы фиксировать как фактические оплаты клиента, так и комиссии, возвраты или дополнительные движения.

- Пока по полису нет ни одного платежа с заполненной датой `actual_date`, полис считается ожидающим оплаты; плановые графики не ведутся.
- Продавец или исполнитель могут добавлять новые платежи и редактировать существующие, распределяя суммы по позициям доходов и расходов. Все изменения (включая правки позиций) журналируются с указанием автора и времени.
- При изменении операций CRM автоматически пересчитывает `incomes_total`, `expenses_total` и `net_total`, чтобы интерфейс и отчёты работали без дополнительной агрегации на лету.
- Статусы `scheduled`, `partially_paid`, `paid`, `cancelled` выставляются правилами CRM на основе плановых значений, подтверждённых операций и ручных корректировок пользователей.
- Для корректировок допускается либо изменить существующий платеж (например, обновить дату и состав позиций), либо создать дополнительную запись с требуемым набором движений; история хранится в CRM и не дублируется во внешних сервисах.

## Задачи

| Код | Название | Описание | Как переводится в статус |
| --- | --- | --- | --- |
| `new` | Новая | Создана карточка задачи с назначенным исполнителем и сроком. | Автоматически при создании пользователем или системным процессом, связанным с событиями из раздела процессов. |
| `in_progress` | В работе | Назначенный исполнитель подтвердил начало выполнения и ведёт активные действия. | Назначенный исполнитель задачи (пользователь) переводит её в работу после анализа описания и принятия в работу. |
| `waiting` | В ожидании | Исполнитель зафиксировал внешнюю зависимость (клиент, партнёр, документы), из-за которой работа временно остановлена. | Исполнитель или постановщик переводит задачу, когда требуется ожидание стороннего действия; система может устанавливать статус при поступлении соответствующего события из интеграций. |
| `done` | Выполнена | Все требования задачи выполнены, результат зафиксирован в комментарии. | Назначенный исполнитель задачи помечает её как выполненную и добавляет итог в описание/комментарии; постановщик проверяет результат перед закрытием. |
| `cancelled` | Отменена | Задача более не актуальна или создана по ошибке. | Постановщик задачи (пользователь) отменяет её, указав причину, либо система отменяет задачу при закрытии связанной сделки/полиса. |

**Переходы и права:**
- Новая (`new`) → В работе (`in_progress`) — инициируется назначенным исполнителем после принятия задачи.
- Новая (`new`) → В ожидании (`waiting`) — исполнитель или постановщик фиксирует необходимость ожидания внешнего действия до фактического старта работ.
- Новая (`new`) → Отменена (`cancelled`) — доступно пользователю-постановщику до начала выполнения либо автоматически при отмене исходного события (например, отмена сделки).
- В работе (`in_progress`) ↔ В ожидании (`waiting`) — исполнитель приостанавливает выполнение при блокирующих факторах и возобновляет после получения нужных данных.
- В работе (`in_progress`) → Выполнена (`done`) — инициируется исполнителем задачи с обязательным добавлением комментария о результате; постановщик может вернуть задачу в работу, если требуется доработка.
- В ожидании (`waiting`) → Выполнена (`done`) — исполнитель завершает задачу, когда ожидание снято и дополнительные действия не требуются.
- В ожидании (`waiting`) → Отменена (`cancelled`) — постановщик закрывает задачу, если зависимость не будет устранена.
- В работе (`in_progress`) → Отменена (`cancelled`) — доступно постановщику при потере актуальности задачи (с фиксацией причины отмены).
- Выполнена (`done`) → В работе (`in_progress`) — постановщик возвращает задачу на доработку, указав необходимые правки.
- Любой статус → Новая (`new`) — недоступно; для повторных действий создаётся новая задача.

**Управление задачами и журналирование:**
- Пользователь, ведущий сделку, управляет задачами как постановщик: создаёт, отменяет, возвращает на доработку, изменяет исполнителя и срок исполнения.
- Назначенный исполнитель задачи может переводить её в работу и отмечать выполнение, но не изменяет постановщика, состав исполнителей или срок.
- Администратор имеет полный доступ к задачам: может просматривать, создавать и изменять их, включая смену исполнителей и статусов, что соответствует политике доступа из раздела «Правила безопасности и доступа».
- Изменение исполнителя или дедлайна фиксируется постановщиком через карточку задачи; система автоматически сохраняет предыдущие значения и автора изменения в [Audit](tech-stack.md#audit) и отображает запись в истории задачи.
- Автоматически созданные задачи по событиям из раздела «Управление событиями по клиентским полисам» наследуют статус «Новая» и назначаются согласно предопределённым правилам; все последующие изменения статусов выполняются в соответствии с указанными правами.

