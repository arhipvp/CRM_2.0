# Структура данных и доменные статусы

> Для описания физической модели (ER-диаграмм, таблиц и ограничений) см. документ [docs/data-model.md](data-model.md).

## Структура сущностей

### Клиент

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор клиента. |
| owner_id | UUID | Нет | Ответственный пользователь CRM, управляющий карточкой. Может быть `null`, если карточка ещё не распределена и находится в очереди без назначенного менеджера. |
| name | String | Да | Отображаемое имя клиента (организация или контактное лицо). |
| email | String | Нет | Основной email клиента. |
| phone | String | Нет | Основной телефон клиента. |
| status | String | Да | Статус взаимоотношений (по справочнику CRM, по умолчанию `active`). |
| created_at | DateTime | Да | Время создания карточки клиента. |
| updated_at | DateTime | Да | Время последнего обновления карточки клиента. |

> Дополнительные контактные данные (email, телефон) хранятся непосредственно в карточке клиента.

### Сделка

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор сделки. |
| client_id | UUID | Да | Ссылка на клиента. |
| owner_id | UUID | Нет | Ответственный пользователь сделки. Может отсутствовать, если карточка ещё не назначена менеджеру. |
| title | String | Да | Краткое название сделки. |
| description | Text | Нет | Контекст и дополнительные детали сделки. |
| status | String | Да | Текущий статус сделки (см. раздел «Сделки» ниже). |
| next_review_at | Date (`YYYY-MM-DD`) | Да | Дата следующего обзора без времени. Используется для сортировки карточек и напоминаний; всегда заполнена валидной датой. |
| created_at | DateTime | Да | Время создания записи. |
| updated_at | DateTime | Да | Время последнего изменения. |

> Денежные показатели сделки хранятся в связанных сущностях: плановые суммы фиксируются через расчёты, фактические движения — через полисы и платежи.

> Журнал сделок (`crm.deal_journal`) хранится отдельно и не вложен в представление сделки. Структура описана в [docs/data-model.md](data-model.md).

### Расчёт

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор расчёта. |
| deal_id | UUID | Да | Ссылка на сделку. |
| insurance_company | String | Да | Название страховой компании (свободный текст). |
| program_name | String | Нет | Название страховой программы. |
| premium_amount | Decimal | Нет | Рассчитанная страховая премия. |
| coverage_sum | Decimal | Нет | Страховая сумма. |
| calculation_date | Date | Да | Дата получения расчёта. |
| validity_period | DateRange | Нет | Период актуальности расчёта. |
| status | Enum (`draft`, `ready`, `confirmed`, `archived`) | Да | Текущее состояние расчёта: определяет права редактирования, отображение в фильтрах и возможность привязки к полису. |
| files | Array<String> | Нет | Относительные пути к связанным документам или публичные ссылки из локального хранилища. |
| comments | Text | Нет | Комментарии пользователя. |

### Полис

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор полиса. |
| deal_id | UUID | Нет | Связанная сделка. Может отсутствовать для полисов, заведённых вне сделки. |
| client_id | UUID | Да | Ссылка на клиента. |
| owner_id | UUID | Да | Ответственный пользователь за сопровождение полиса. |
| policy_number | String | Да | Номер полиса. |
| status | String | Да | Текущий статус полиса (см. раздел «Полисы»). |
| premium | Decimal | Нет | Страховая премия, указанная в полисе. |
| effective_from | Date | Нет | Дата начала действия. |
| effective_to | Date | Нет | Дата окончания действия. |
| created_at | DateTime | Да | Время создания записи. |
| updated_at | DateTime | Да | Время последнего изменения. |

### Платёж

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор записи. |
| deal_id | UUID | Да | Ссылка на сделку (денормализованная связь для быстрых выборок). |
| policy_id | UUID | Да | Ссылка на полис; один полис может иметь несколько платежей, отражающих разные поступления/списания. |
| sequence | Integer | Да | Порядковый номер платежа в рамках полиса, начиная с `1`. |
| status | String | Да | Текущий статус платежа (см. раздел «Платежи»). |
| planned_date | Date | Нет | Плановая дата платежа, может отсутствовать для незапланированных движений. |
| planned_amount | Decimal | Да | Плановая сумма, фиксируемая на момент постановки платежа. |
| currency | String | Да | Валюта, код ISO 4217 (сейчас используется `RUB`). |
| comment | Text | Нет | Дополнительные пояснения по оплате или источнику данных. |
| actual_date | Date | Нет | Фактическая дата закрытия платежа; может оставаться пустой до подтверждения поступлений и расходов. |
| recorded_by_id | UUID | Нет | Пользователь, который вручную подтвердил факт оплаты; используется для аудита и отображения ответственного в интерфейсе. |
| incomes_total | Decimal | Да | Совокупная сумма поступлений, денормализованный агрегат. |
| expenses_total | Decimal | Да | Совокупная сумма расходов, денормализованный агрегат. |
| net_total | Decimal | Да | Разница `incomes_total - expenses_total`. |
| created_by_id | UUID | Нет | Пользователь, который создал платёж. |
| updated_by_id | UUID | Нет | Пользователь, последним изменивший платёж. |
| created_at | DateTime | Да | Время создания записи платежа в CRM. |
| updated_at | DateTime | Да | Момент последнего редактирования записи и вложенных списков. |
| incomes | Array<ПлатёжнаяОперация> | Нет | Последние операции поступлений, упорядоченные по дате добавления. |
| expenses | Array<ПлатёжнаяОперация> | Нет | Последние операции расходов, упорядоченные по дате добавления. |

**Платёжная операция (`income`/`expense`)**

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор позиции. |
| payment_id | UUID | Да | Ссылка на платеж. |
| amount | Decimal | Да | Абсолютная сумма операции. |
| currency | String | Да | Код валюты операции (должен совпадать с валютой платежа). |
| category | String | Да | Тип статьи (например, «wire», «cash», «agency_fee», «refund»). |
| posted_at | Date | Да | Дата фиксации операции, не может быть в будущем. |
| note | Text | Нет | Комментарий с деталями расчёта. |
| created_by_id | UUID | Нет | Пользователь, создавший операцию (может отсутствовать для импортированных данных). |
| updated_by_id | UUID | Нет | Пользователь, последним изменивший операцию. |
| created_at | DateTime | Да | Момент создания записи операции. |
| updated_at | DateTime | Да | Момент последнего изменения записи. |

> **Примечания:**
> - Совокупные поля `incomes_total`, `expenses_total` и `net_total` вычисляются из фактических операций `incomes`/`expenses` и сохраняются денормализованно для ускорения отчётности.
> - Поле `actual_date` остаётся пустым, пока платёж не закрыт: дата заполняется автоматически по фактическим поступлениям или вручную ответственным пользователем.
> - При ручном закрытии платежа CRM сохраняет ссылку на пользователя (`recorded_by_id`), чтобы фиксировать ответственного за подтверждение поступления.
> - Статус (`status`) определяется бизнес-логикой CRM исходя из плановых данных, подтверждённых операций и ручных действий операторов.
> - Платёж может отражать как окончательную оплату по полису, так и промежуточные движения (частичные оплаты, возвраты, комиссии). История изменений позиций сохраняется средствами аудита CRM.
> - Таблицы `crm.payment_incomes` и `crm.payment_expenses` разделены: направление операции задаётся выбранным набором (отдельный endpoint/таблица), поэтому поле `type` в схеме отсутствует.

### Документ

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор записи документа. |
| name | String | Да | Отображаемое название документа. |
| description | String | Нет | Краткое описание содержимого. |
| metadata | JSON | Нет | Дополнительные атрибуты: идентификаторы владельцев (client/deal/policy/payment), заметки, теги и кастомные свойства. |
| storage_path | String | Нет | Относительный путь к файлу внутри `DOCUMENTS_STORAGE_ROOT` (может отсутствовать до завершения загрузки). |
| public_url | String | Нет | Публичная ссылка, если настроен `DOCUMENTS_STORAGE_PUBLIC_BASE_URL`. |
| status | Enum | Да | Текущий статус документа (см. описание состояний ниже). |
| uploaded_at | DateTime | Нет | Время успешной загрузки файла. |
| synced_at | DateTime | Нет | Время последней синхронизации с внешними системами/очередями. |
| created_at | DateTime | Да | Дата и время создания записи. |
| updated_at | DateTime | Да | Дата и время последнего обновления метаданных. |

**Состояния документа (`Document.status`):**

* `draft` — запись создана, но файл ещё не выбран.
* `pending_upload` — подготовка к загрузке завершена, ожидается отправка файла клиентом.
* `uploading` — файл загружается в хранилище.
* `uploaded` — файл успешно загружен и доступен в локальном хранилище.
* `synced` — документ синхронизирован с внешними системами и готов к использованию в интеграциях.
* `error` — при загрузке или синхронизации произошла ошибка, требуется вмешательство оператора.

### Задача

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор задачи. |
| title | String | Да | Название задачи (поле `title`/`subject` из API). |
| description | Text | Да | Полное описание действий. |
| statusCode | Enum (см. раздел «Задачи») | Да | Текущий статус задачи (`TaskResponseDto.statusCode`). |
| statusName | String | Нет | Локализованное имя статуса для интерфейсов. |
| dueAt | DateTime | Нет | Плановый дедлайн (`TaskResponseDto.dueAt`). |
| scheduledFor | DateTime | Нет | Время активации отложенной задачи (`TaskResponseDto.scheduledFor`). |
| completedAt | DateTime | Нет | Момент фактического завершения. |
| cancelledReason | Text | Нет | Причина отмены при статусе `cancelled`. |
| payload | JSON | Нет | Исходные данные задачи. Содержит `assigneeId`, `authorId`, `priority`, контекст и дополнительные пользовательские поля. |
| assigneeId | UUID | Нет | Исполнитель, дублируется из `payload.assigneeId`/`payload.assignee_id`. |
| authorId | UUID | Нет | Автор задачи, дублируется из `payload.authorId`/`payload.author_id`, основным источником считается этот столбец. |
| priority | String | Нет | Приоритет задачи (`low`/`normal`/`high`) из `payload.priority`. |
| clientId | UUID | Нет | Клиент, указанный в `payload.clientId`/`payload.client_id`. |
| dealId | UUID | Нет | Сделка, если присутствует в `payload`. |
| context | JSON | Нет | Нормализованный объект контекста (`payload.context` с camelCase-ключами). |
| createdAt | DateTime | Да | Дата и время создания. |
| updatedAt | DateTime | Да | Дата и время последнего изменения. |

> Идентификатор автора по-прежнему дублируется в `payload.authorId`/`payload.author_id` для обратной совместимости с существующими интеграциями, однако основным источником значения является отдельный столбец `authorId`.

> Уведомления по задачам формируются автоматически в CRM и Telegram в соответствии с бизнес-процессами, ручных переключателей каналов нет.

> **Требования к БД:** миграции CRM ожидают, что пользователь базы данных владеет схемой `tasks` или, как минимум, имеет права `USAGE`/`CREATE` на неё. Если схема уже принадлежит другой роли, смена владельца в ходе миграции будет пропущена с `NOTICE`, однако создание таблиц возможно только при наличии указанных привилегий. Для первоначального развёртывания также нужны права `CREATE` на базу данных для создания схемы `tasks`.

# Доменные статусы и переходы

## Сделки

| Этап (`DealStage`) | Канонический код статуса (`Deal.status`) | Допустимые входящие значения | Человеко-понятное состояние | Как переводится в статус |
| --- | --- | --- | --- | --- |
| `qualification` | `qualification` | `draft`, `qualification` | Сбор исходных данных по сделке, назначение ответственного. | Создание сделки вручную или импорт внешнего лида; при обновлении этапа CRM нормализует статус к `qualification`. |
| `negotiation` | `in_progress` | `in_progress`, `negotiation` | Активная работа над расчётами и условиями предложения. | Назначение исполнителей и запуск задач на расчёты; при смене этапа используется код `in_progress`. |
| `proposal` | `proposal` | `proposal` | Предложение отправлено клиенту, ожидается выбор варианта. | Исполнитель отмечает расчёт как готовый и передаёт клиенту; смена этапа фиксирует статус `proposal`. |
| `closedWon` | `won` | `won`, `closed_won` | Сделка успешно завершена, полисы оформлены и оплачены. | После подтверждения оплаты и выпуска полиса этап переводится в выигранный, статус нормализуется в `won`. |
| `closedLost` | `lost` | `lost`, `closed_lost` | Сделка закрыта без результата или по отказу клиента. | Менеджер закрывает сделку при отказе, отмене полиса или невозможности продолжить; канонический статус — `lost`. |

`DealStage` и соответствующие статусы описаны в коде через перечисление `DealStage` и функции `map_stage_to_deal_status`/`map_deal_status_to_stage` (см. `backend/crm/crm/domain/schemas.py`). Это означает:

* во внешних API и фильтрах используются коды этапов `qualification` → `negotiation` → `proposal` → `closedWon`/`closedLost`;
* при записи `Deal.status` приложение всегда приводит значение к одному из канонических кодов `qualification`/`in_progress`/`proposal`/`won`/`lost`, но при чтении принимает перечисленные «синонимы» (например, `draft`, `closed_won`).

**Переходы:**
- `qualification` → `negotiation` — после назначения ответственного на расчёты и постановки задач исполнителям; статус переводится в `in_progress`.
- `negotiation` → `proposal` — когда расчёты подготовлены и отправлены клиенту, CRM фиксирует статус `proposal`.
- `proposal` → `closedWon` — после согласования варианта, получения оплаты и регистрации полиса статус становится `won`.
- `proposal` → `closedLost` — если клиент отказался или условия не согласованы, статус нормализуется в `lost`.
- `closedWon`/`closedLost` — финальные этапы; обратный перевод невозможен, вместо отката создаётся новая сделка.

## Расчёты

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Черновик | Расчёт в работе: исполнитель редактирует данные и загружает файлы, карточка видна только команде сделки. | Автоматически при создании или копировании расчёта пользователем.
| Готов | Все обязательные поля заполнены, комплект файлов проверен, карточку можно показывать клиенту. | Исполнитель нажимает «Отметить как готово»; система проверяет наличие обязательных данных и минимум одного файла. |
| Подтверждён | Клиент выбрал вариант, расчёт привязан к согласованному полису и заблокирован от редактирования. | Продавец или главный админ подтверждает расчёт и при необходимости указывает связанный полис. |
| Архив | Вариант сохранён для истории, доступен только для чтения и выводится в архивных списках. | Пользователь с правами на сделку архивирует готовый или подтверждённый расчёт после выпуска полиса либо отказа клиента. |

**Переходы:**
- Черновик → Готов — исполнитель завершает подготовку и помечает расчёт как готовый.
- Готов → Подтверждён — продавец или главный админ фиксирует выбор клиента и при необходимости привязывает полис.
- Готов → Архив — расчёт переводится в архив, если выбран другой вариант или клиент отказался.
- Подтверждён → Архив — архивирование подтверждённого расчёта после выпуска полиса или закрытия сделки.
- Архив → любой другой статус — недоступно; для повторного использования создаётся новый расчёт или копия.

## Полисы

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Черновик | Полис готовится: внесены расчётные данные, но номер ещё не подтверждён. | Создание полиса назначенным пользователем или импорт из расчётов. |
| Действует | Полис оформлен, период покрытия активен. | Ответственный за оформление фиксирует дату начала действия и номер после получения подтверждения страховой. |
| Ожидает продления | Полис скоро истекает, требуется инициировать продление. | Автоматическое событие по наступлении даты напоминания или ручной перевод ответственным пользователем. |
| Закрыт | Полис истёк, отменён или заменён другим, обязательства выполнены. | Наступление даты окончания, отмена по заявлению клиента или фиксация пролонгации новым полисом. |

**Переходы:**
- Черновик → Действует — после подтверждения выпуска и ввода даты начала.
- Действует → Ожидает продления — за заданное количество дней до окончания или по решению менеджера начать продление.
- Действует → Закрыт — по досрочному расторжению или факту окончания без продления.
- Ожидает продления → Действует — при оформлении пролонгации без разрыва.
- Ожидает продления → Закрыт — если клиент отказался от продления либо срок закончился без пролонгации.
- Закрыт → Черновик — не применяется; создаётся новый полис.

## Платежи

Платёжная модель поддерживает несколько записей по одному полису: каждая запись агрегирует связанные поступления и списания, чтобы фиксировать как фактические оплаты клиента, так и комиссии, возвраты или дополнительные движения.

- Пока по полису нет ни одного платежа с заполненной датой `actual_date`, полис считается ожидающим оплаты; плановые графики не ведутся.
- Продавец или исполнитель могут добавлять новые платежи и редактировать существующие, распределяя суммы по позициям доходов и расходов. Все изменения (включая правки позиций) журналируются с указанием автора и времени.
- При изменении операций CRM автоматически пересчитывает `incomes_total`, `expenses_total` и `net_total`, чтобы интерфейс и отчёты работали без дополнительной агрегации на лету.
- При ручном перенесении фактических данных менеджер может заполнить агрегаты `incomes_total` и `expenses_total` непосредственно в карточке платежа — приложение пересчитает `net_total` перед сохранением и передаст значения в CRM.
- Статусы `scheduled`, `partially_paid`, `paid`, `cancelled` выставляются правилами CRM на основе плановых значений, подтверждённых операций и ручных корректировок пользователей.
- Для корректировок допускается либо изменить существующий платеж (например, обновить дату и состав позиций), либо создать дополнительную запись с требуемым набором движений; история хранится в CRM и не дублируется во внешних сервисах.

## Задачи

| Код | Название | Описание | Как переводится в статус |
| --- | --- | --- | --- |
| `pending` | Ожидает выполнения | Задача создана и готова к взятию в работу. | Присваивается автоматически при создании (`TaskResponseDto.statusCode = pending`). |
| `scheduled` | Отложена | Задача запланирована на будущее время и активируется воркером отложенных задач. | Устанавливается при создании/обновлении задачи с полем `scheduledFor` в будущем. |
| `in_progress` | В работе | Исполнитель ведёт активные действия по задаче. | Исполнитель или система переводит задачу в работу через API (`PATCH /tasks/{id}` со статусом `in_progress`). |
| `completed` | Завершена | Работа успешно выполнена и подтверждена. | Исполнитель завершает задачу (`status = completed`), при необходимости передавая `completedAt`. |
| `cancelled` | Отменена | Задача утратила актуальность или отменена бизнес-процессом. | Постановщик или автоматический процесс переводит задачу в `cancelled`, обязательно указывая `cancelledReason`. |

**Переходы и права:**
- Pending (`pending`) → Scheduled (`scheduled`) — CRM переводит задачу в отложенное состояние при создании/обновлении с `scheduledFor` в будущем времени (`POST /tasks`, `PATCH /tasks/{id}`).
- Pending (`pending`) → In progress (`in_progress`) — инициируется исполнителем через `PATCH /tasks/{id}` со статусом `in_progress`.
- Pending (`pending`) → Completed (`completed`) — используется для мгновенного закрытия задач без длительного исполнения.
- Pending (`pending`) → Cancelled (`cancelled`) — постановщик отменяет задачу до начала работ, указывая `cancelledReason`.
- Scheduled (`scheduled`) → Pending (`pending`) — происходит автоматически, когда наступает `scheduledFor`, либо вручную через `PATCH /tasks/{id}` со статусом `pending`.
- Scheduled (`scheduled`) → In progress (`in_progress`) — инициируется исполнителем или автоматикой, когда задача должна стартовать сразу после активации.
- Scheduled (`scheduled`) → Cancelled (`cancelled`) — постановщик или система отменяет отложенную задачу с передачей `cancelledReason`.
- In progress (`in_progress`) → Completed (`completed`) — исполнитель фиксирует успешное завершение и при необходимости передаёт `completedAt`.
- In progress (`in_progress`) → Cancelled (`cancelled`) — постановщик прекращает выполнение при потере актуальности, обязательно с `cancelledReason`.
- Completed (`completed`) ↔ Cancelled (`cancelled`) — обратные переходы запрещены; для повторного действия создаётся новая задача.

**Управление задачами и журналирование:**
- Пользователь, ведущий сделку, управляет задачами как постановщик: создаёт, отменяет, возвращает на доработку, изменяет исполнителя и срок исполнения.
- Назначенный исполнитель задачи может переводить её в работу и отмечать выполнение, но не изменяет постановщика, состав исполнителей или срок.
- Администратор имеет полный доступ к задачам: может просматривать, создавать и изменять их, включая смену исполнителей и статусов, что соответствует политике доступа из раздела «Правила безопасности и доступа».
- Изменение исполнителя или дедлайна фиксируется постановщиком через карточку задачи; система автоматически сохраняет предыдущие значения и автора изменения в журналах CRM и отображает запись в истории задачи.
- Каждое изменение статуса, исполнителя или комментария фиксируется отдельной записью в таблице `tasks.task_activity` с указанием автора, типа события и произвольного payload.
- Автоматически созданные задачи по событиям из раздела «Управление событиями по клиентским полисам» наследуют статус `pending` и назначаются согласно предопределённым правилам; все последующие изменения статусов выполняются в соответствии с указанными правами.

