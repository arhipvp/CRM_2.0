# Доменные статусы и переходы

## Сделки

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Черновик | Создана карточка сделки, собраны исходные данные. | Создание сделки продавцом или импорт из внешнего источника. |
| На расчёте | Исполнитель подбирает варианты страхования и готовит предложения. | Продавец назначает исполнителя и ставит задачу на подготовку расчётов. |
| Ожидает решения клиента | Команда представила расчёты, требуется выбор клиента. | Исполнитель завершает расчёты и помечает задачу как выполненную. |
| Оформление полиса | Клиент согласовал вариант, идёт подготовка документов и контроль оплаты. | Продавец фиксирует выбранный вариант и создаёт задачу на оформление. |
| Активна | Полисы оформлены, как минимум один полис действует, ведётся сопровождение. | Исполнитель регистрирует активный полис и подтверждена оплата. |
| Закрыта | Сделка завершена: все полисы истекли или отменены, дальнейшие действия не планируются. | Руководитель/продавец закрывает сделку после истечения срока последнего полиса либо отказа клиента. |

**Переходы:**
- Черновик → На расчёте — после назначения исполнителя и постановки задачи на расчёт.
- На расчёте → Ожидает решения клиента — когда расчёты добавлены и отмечены как готовые.
- Ожидает решения клиента → Оформление полиса — после согласования варианта с клиентом.
- Оформление полиса → Активна — после фиксации оплаты и регистрации полиса в системе.
- Любой активный статус → Закрыта — по завершении всех связанных полисов, письменному отказу клиента или отмене сделки.
- Закрыта → Черновик — недоступно (создаётся новая сделка вместо переоткрытия).

## Полисы

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Черновик | Полис готовится: внесены расчётные данные, но номер ещё не подтверждён. | Создание полиса исполнителем или импорт из расчётов. |
| Действует | Полис оформлен, период покрытия активен. | Исполнитель фиксирует дату начала действия и номер после получения подтверждения страховой. |
| Ожидает продления | Полис скоро истекает, требуется инициировать продление. | Автоматическое событие по наступлении даты напоминания или ручной перевод исполнителем. |
| Закрыт | Полис истёк, отменён или заменён другим, обязательства выполнены. | Наступление даты окончания, отмена по заявлению клиента или фиксация пролонгации новым полисом. |

**Переходы:**
- Черновик → Действует — после подтверждения выпуска и ввода даты начала.
- Действует → Ожидает продления — за заданное количество дней до окончания или по решению менеджера начать продление.
- Действует → Закрыт — по досрочному расторжению или факту окончания без продления.
- Ожидает продления → Действует — при оформлении пролонгации без разрыва.
- Ожидает продления → Закрыт — если клиент отказался от продления либо срок закончился без пролонгации.
- Закрыт → Черновик — не применяется; создаётся новый полис.

## Платежи

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Запланирован | Платёж запланирован в графике, но ещё не выставлен клиенту/контрагенту. | Добавление строки графика платежей, импорт планов из таблицы. |
| Ожидается | Счёт выставлен, есть ожидаемая дата поступления/списания. | Продавец или исполнитель фиксирует отправку счёта либо подтверждение от клиента. |
| Получен | Денежные средства поступили на счёт компании. | Финансовый менеджер вручную фиксирует подтверждение платежа в системе (ручной ввод/подтверждение пользователем). |
| Выплачен | Сумма перечислена дальше (комиссия агенту, скидка клиенту, выплата исполнителю). | Финансовый менеджер подтверждает исходящий платёж или распределение комиссии. |

Все корректировки платежей выполняются через редактирование существующей записи с обязательным сохранением истории изменений; новые записи при исправлениях не создаются.

**Переходы:**
- Запланирован → Ожидается — после отправки счёта/заявки на оплату.
- Ожидается → Получен — при подтверждении входящего платежа.
- Получен → Выплачен — при отражении исходящего платежа или распределении комиссий.
- Ожидается ↔ Запланирован — допускается возврат к предыдущему статусу при корректировке параметров платежа.
- Получен ↔ Ожидается — корректировка реквизитов или суммы выполняется через редактирование существующей записи с обязательной фиксацией истории изменений.
- Выплачен ↔ Получен — изменение распределения выплат также оформляется редактированием записи; история версий сохраняется автоматически.

## Задачи

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Новая | Создана карточка задачи с назначенным исполнителем и сроком. | Автоматически при создании продавцом или системным процессом, связанным с событиями из раздела процессов. |
| В работе | Исполнитель подтвердил начало выполнения и ведёт активные действия. | Исполнитель переводит задачу в работу после анализа описания и принятия в работу. |
| Выполнена | Все требования задачи выполнены, результат зафиксирован в комментарии. | Исполнитель помечает задачу как выполненную и добавляет итог в описание/комментарии; продавец может закрыть задачу после проверки. |
| Отменена | Задача более не актуальна или создана по ошибке. | Продавец отменяет задачу, указав причину, либо система отменяет при закрытии связанной сделки/полиса. |

**Переходы и права:**
- Новая → В работе — инициируется назначенным исполнителем после принятия задачи.
- Новая → Отменена — доступно продавцу, создавшему задачу, до начала выполнения либо автоматически при отмене исходного события (например, отмена сделки).
- В работе → Выполнена — инициируется исполнителем с обязательным добавлением комментария о результате; продавец может вернуть задачу в работу, если требуется доработка.
- В работе → Отменена — доступно продавцу при потере актуальности задачи (с фиксацией причины отмены).
- Выполнена → В работе — продавец возвращает задачу на доработку, указав необходимые правки.
- Любой статус → Новая — недоступно; для повторных действий создаётся новая задача.

**Управление задачами и журналирование:**
- Продавец управляет задачами в рамках своих сделок: создаёт, отменяет, возвращает на доработку, обновляет исполнителя и срок исполнения.
- Исполнитель может переводить назначенные задачи в работу и отмечать выполнение, но не изменяет постановщика, исполнителя или срок.
- Руководитель, финансовый менеджер и администратор имеют права только на просмотр задач, что соответствует политике доступа из раздела «Правила безопасности и доступа».
- Изменение исполнителя или дедлайна фиксируется продавцом через карточку задачи; система автоматически сохраняет предыдущие значения и автора изменения в Audit и отображает запись в истории задачи.
- Автоматически созданные задачи по событиям из раздела «Управление событиями по клиентским полисам» наследуют статус «Новая» и назначаются согласно ответственным ролям; все последующие изменения статусов выполняются в соответствии с указанными правами.

