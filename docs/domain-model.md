# Структура данных и доменные статусы

> Для описания физической модели (ER-диаграмм, таблиц и ограничений) см. документ [docs/data-model.md](data-model.md).

## Структура сущностей

### Клиент

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор клиента. |
| type | Enum (`individual`, `company`) | Да | Тип клиента: физическое или юридическое лицо. |
| full_name | String | Да | ФИО (для физлица) или полное наименование (для юрлица). |
| short_name | String | Нет | Краткое имя для отображения в интерфейсе и структуре папок. |
| tax_number | String | Нет | ИНН/ИНП или аналогичный идентификатор, хранится как текст без валидации формата. |
| registration_number | String | Нет | ОГРН/ОГРНИП или другой регистрационный номер. |
| segment | String | Нет | Свободное текстовое описание сегмента/категории клиента. |
| status | Enum (`potential`, `active`, `inactive`) | Да | Текущий статус взаимоотношений с клиентом. |
| contacts | Array<КонтактноеЛицо> | Нет | Список контактных лиц клиента. |
| notes | Text | Нет | Общие примечания, история договорённостей. |

**Контактное лицо клиента**

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| name | String | Да | Имя и фамилия контактного лица. |
| position | String | Нет | Должность или роль. |
| phone | String | Нет | Телефон, хранится в текстовом виде. |
| email | String | Нет | Адрес электронной почты. |
| notes | String | Нет | Дополнительные примечания по контактному лицу. |

### Сделка

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор сделки. |
| client_id | UUID | Да | Ссылка на клиента. |
| title | String | Да | Краткое название сделки (используется в структуре папок). |
| description | Text | Нет | Подробное описание объекта страхования. |
| sales_agent_id | UUID | Да | Ведущий пользователь сделки (ответственный менеджер). |
| executor_id | UUID | Нет | Назначенный пользователь, отвечающий за оформление полисов. |
| status | Enum (см. раздел «Сделки» ниже) | Да | Текущий статус сделки. |
| start_date | Date | Нет | Дата начала работы по сделке. |
| expected_close_date | Date | Нет | Плановая дата завершения/оформления. |
| next_review_at | Date (`YYYY-MM-DD`) | Да | Дата следующего обзора без времени. Используется для сортировки карточек и напоминаний; всегда заполнена валидной датой. |
| journal | Array<ЗаписьЖурнала> | Нет | Текстовые заметки и история действий. |
| folder_id | String | Нет | Идентификатор корневой папки сделки в Google Drive. |

**Запись журнала сделки**

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор записи. |
| author_id | UUID | Да | Автор записи (пользователь). |
| created_at | DateTime | Да | Дата и время создания записи. |
| text | Text | Да | Содержимое заметки. |
| attachments | Array<String> | Нет | Ссылки на документы или файлы Drive. |

### Расчёт

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор расчёта. |
| deal_id | UUID | Да | Ссылка на сделку. |
| insurance_company | String | Да | Название страховой компании (свободный текст). |
| program_name | String | Нет | Название страховой программы. |
| premium_amount | Decimal | Нет | Рассчитанная страховая премия. |
| coverage_sum | Decimal | Нет | Страховая сумма. |
| calculation_date | Date | Да | Дата получения расчёта. |
| validity_period | DateRange | Нет | Период актуальности расчёта. |
| files | Array<String> | Нет | Ссылки на связанные документы в Google Drive. |
| comments | Text | Нет | Комментарии пользователя. |

### Полис

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор полиса. |
| deal_id | UUID | Да | Ссылка на сделку. |
| client_id | UUID | Да | Ссылка на клиента (дублируется для ускорения выборок). |
| calculation_id | UUID | Нет | Связанный расчёт, если полис оформлен по конкретному предложению. |
| policy_number | String | Да | Номер полиса, текстовое поле. |
| insurer | String | Да | Название страховой компании. |
| program_name | String | Нет | Название программы страхования. |
| effective_from | Date | Да | Дата начала действия. |
| effective_to | Date | Да | Дата окончания действия. |
| premium_amount | Decimal | Да | Сумма страховой премии. |
| coverage_sum | Decimal | Нет | Страховая сумма. |
| status | Enum (см. раздел «Полисы») | Да | Текущий статус полиса. |
| documents | Array<String> | Нет | Ссылки на документы полиса. |

### Платёж

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор записи. |
| deal_id | UUID | Да | Ссылка на сделку (денормализованная связь для быстрых выборок). |
| policy_id | UUID | Да | Ссылка на полис; для каждого полиса допускается не более одной записи платежа. |
| amount | Decimal | Да | Сумма, подтверждённая продавцом. |
| currency | String | Да | Валюта, фиксированное значение `RUB` (для обратной совместимости со старыми выгрузками). |
| actual_date | Date | Да | Фактическая дата поступления оплаты; обязательна и определяет, что полис оплачен. |
| recorded_by_id | UUID | Да | Пользователь (продавец/аккаунт-менеджер), подтвердивший оплату. |
| comment | Text | Нет | Дополнительные пояснения по оплате или источнику данных. |
| created_at | DateTime | Да | Время фиксации платежа в CRM. |
| updated_at | DateTime | Да | Момент последнего редактирования записи. |

> **Примечание:** частичные оплаты и возвраты не фиксируются — при корректировках редактируется исходная запись с сохранением истории изменений.

### Документ

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор записи документа. |
| owner_type | Enum (`client`, `deal`, `policy`, `payment`) | Да | Уровень привязки документа. |
| owner_id | UUID | Да | Идентификатор связанной сущности. |
| title | String | Да | Краткое наименование документа. |
| file_url | String | Да | Ссылка на файл в Google Drive. |
| folder_id | String | Нет | Идентификатор папки в Google Drive. |
| uploaded_by | UUID | Да | Пользователь, загрузивший документ. |
| uploaded_at | DateTime | Да | Дата и время загрузки. |
| document_type | String | Нет | Текстовый тип (полис, акт, расчёт и т.д.). |
| notes | Text | Нет | Дополнительные комментарии. |

### Задача

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| id | UUID | Да | Уникальный идентификатор задачи. |
| subject | String | Да | Краткое название задачи. |
| description | Text | Да | Подробное описание действий без вложенных чек-листов. |
| deal_id | UUID | Нет | Ссылка на сделку. |
| policy_id | UUID | Нет | Ссылка на полис (если применимо). |
| payment_id | UUID | Нет | Ссылка на платеж (если применимо). |
| status | Enum (см. раздел «Задачи») | Да | Текущий статус задачи. |
| assignee_id | UUID | Да | Назначенный исполнитель. |
| author_id | UUID | Да | Постановщик задачи. |
| due_date | Date | Нет | Срок исполнения. |
| created_at | DateTime | Да | Дата и время создания. |
| updated_at | DateTime | Да | Дата и время последнего изменения. |

> Уведомления по задачам формируются автоматически в CRM и Telegram в соответствии с бизнес-процессами, ручных переключателей каналов нет.

# Доменные статусы и переходы

## Сделки

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Черновик | Создана карточка сделки, собраны исходные данные. | Создание сделки пользователем или импорт из внешнего источника. |
| На расчёте | Назначенный пользователь подбирает варианты страхования и готовит предложения. | Ведущий пользователь назначает коллегу и ставит задачу на подготовку расчётов. |
| Ожидает решения клиента | Команда представила расчёты, требуется выбор клиента. | Ответственный за расчёты пользователь завершает подготовку и помечает задачу как выполненную. |
| Оформление полиса | Клиент согласовал вариант, идёт подготовка документов и контроль оплаты. | Ведущий пользователь фиксирует выбранный вариант и создаёт задачу на оформление. |
| Активна | Полисы оформлены, как минимум один полис действует, ведётся сопровождение. | Ответственный за оформление регистрирует активный полис и подтверждённую оплату. |
| Закрыта | Сделка завершена: все полисы истекли или отменены, дальнейшие действия не планируются. | Любой пользователь с доступом закрывает сделку после истечения срока последнего полиса либо отказа клиента. |

**Переходы:**
- Черновик → На расчёте — после назначения ответственного за расчёты и постановки задачи.
- На расчёте → Ожидает решения клиента — когда расчёты добавлены и отмечены как готовые.
- Ожидает решения клиента → Оформление полиса — после согласования варианта с клиентом.
- Оформление полиса → Активна — после фиксации оплаты и регистрации полиса в системе.
- Любой активный статус → Закрыта — по завершении всех связанных полисов, письменному отказу клиента или отмене сделки.
- Закрыта → Черновик — недоступно (создаётся новая сделка вместо переоткрытия).

## Полисы

| Статус | Описание | Как переводится в статус |
| --- | --- | --- |
| Черновик | Полис готовится: внесены расчётные данные, но номер ещё не подтверждён. | Создание полиса назначенным пользователем или импорт из расчётов. |
| Действует | Полис оформлен, период покрытия активен. | Ответственный за оформление фиксирует дату начала действия и номер после получения подтверждения страховой. |
| Ожидает продления | Полис скоро истекает, требуется инициировать продление. | Автоматическое событие по наступлении даты напоминания или ручной перевод ответственным пользователем. |
| Закрыт | Полис истёк, отменён или заменён другим, обязательства выполнены. | Наступление даты окончания, отмена по заявлению клиента или фиксация пролонгации новым полисом. |

**Переходы:**
- Черновик → Действует — после подтверждения выпуска и ввода даты начала.
- Действует → Ожидает продления — за заданное количество дней до окончания или по решению менеджера начать продление.
- Действует → Закрыт — по досрочному расторжению или факту окончания без продления.
- Ожидает продления → Действует — при оформлении пролонгации без разрыва.
- Ожидает продления → Закрыт — если клиент отказался от продления либо срок закончился без пролонгации.
- Закрыт → Черновик — не применяется; создаётся новый полис.

## Платежи

Платёж по полису фиксируется единственной записью, которая хранится внутри CRM и не дублируется во внешних сервисах. Статусы не используются: факт оплаты определяется заполнением обязательной даты `actual_date` и наличием пользователя-продавца (`recorded_by_id`), который подтвердил поступление средств.

- Пока `actual_date` не заполнена, полис считается ожидающим оплаты; плановые даты и графики не ведутся.
- После ввода даты продавец или исполнитель может обновлять только фактическую дату и рабочий комментарий (например, если в банк загрузили уточнённые реквизиты). Статусы оплаты, сумма и комиссионные записи недоступны для редактирования этими ролями. Все изменения сохраняются в аудите CRM вместе с автором и временем правки.
- При ошибочном вводе оплату разрешено отредактировать (обновив `actual_date` на корректное значение), но создавать дополнительные записи для корректировок нельзя.
- Функции распределения комиссий и исходящих платежей исключены: CRM хранит только факт входящего платежа клиента.

## Задачи

| Код | Название | Описание | Как переводится в статус |
| --- | --- | --- | --- |
| `new` | Новая | Создана карточка задачи с назначенным исполнителем и сроком. | Автоматически при создании пользователем или системным процессом, связанным с событиями из раздела процессов. |
| `in_progress` | В работе | Назначенный исполнитель подтвердил начало выполнения и ведёт активные действия. | Назначенный исполнитель задачи (пользователь) переводит её в работу после анализа описания и принятия в работу. |
| `waiting` | В ожидании | Исполнитель зафиксировал внешнюю зависимость (клиент, партнёр, документы), из-за которой работа временно остановлена. | Исполнитель или постановщик переводит задачу, когда требуется ожидание стороннего действия; система может устанавливать статус при поступлении соответствующего события из интеграций. |
| `done` | Выполнена | Все требования задачи выполнены, результат зафиксирован в комментарии. | Назначенный исполнитель задачи помечает её как выполненную и добавляет итог в описание/комментарии; постановщик проверяет результат перед закрытием. |
| `cancelled` | Отменена | Задача более не актуальна или создана по ошибке. | Постановщик задачи (пользователь) отменяет её, указав причину, либо система отменяет задачу при закрытии связанной сделки/полиса. |

**Переходы и права:**
- Новая (`new`) → В работе (`in_progress`) — инициируется назначенным исполнителем после принятия задачи.
- Новая (`new`) → В ожидании (`waiting`) — исполнитель или постановщик фиксирует необходимость ожидания внешнего действия до фактического старта работ.
- Новая (`new`) → Отменена (`cancelled`) — доступно пользователю-постановщику до начала выполнения либо автоматически при отмене исходного события (например, отмена сделки).
- В работе (`in_progress`) ↔ В ожидании (`waiting`) — исполнитель приостанавливает выполнение при блокирующих факторах и возобновляет после получения нужных данных.
- В работе (`in_progress`) → Выполнена (`done`) — инициируется исполнителем задачи с обязательным добавлением комментария о результате; постановщик может вернуть задачу в работу, если требуется доработка.
- В ожидании (`waiting`) → Выполнена (`done`) — исполнитель завершает задачу, когда ожидание снято и дополнительные действия не требуются.
- В ожидании (`waiting`) → Отменена (`cancelled`) — постановщик закрывает задачу, если зависимость не будет устранена.
- В работе (`in_progress`) → Отменена (`cancelled`) — доступно постановщику при потере актуальности задачи (с фиксацией причины отмены).
- Выполнена (`done`) → В работе (`in_progress`) — постановщик возвращает задачу на доработку, указав необходимые правки.
- Любой статус → Новая (`new`) — недоступно; для повторных действий создаётся новая задача.

**Управление задачами и журналирование:**
- Пользователь, ведущий сделку, управляет задачами как постановщик: создаёт, отменяет, возвращает на доработку, изменяет исполнителя и срок исполнения.
- Назначенный исполнитель задачи может переводить её в работу и отмечать выполнение, но не изменяет постановщика, состав исполнителей или срок.
- Администратор имеет полный доступ к задачам: может просматривать, создавать и изменять их, включая смену исполнителей и статусов, что соответствует политике доступа из раздела «Правила безопасности и доступа».
- Изменение исполнителя или дедлайна фиксируется постановщиком через карточку задачи; система автоматически сохраняет предыдущие значения и автора изменения в [Audit](tech-stack.md#audit) и отображает запись в истории задачи.
- Автоматически созданные задачи по событиям из раздела «Управление событиями по клиентским полисам» наследуют статус «Новая» и назначаются согласно предопределённым правилам; все последующие изменения статусов выполняются в соответствии с указанными правами.

