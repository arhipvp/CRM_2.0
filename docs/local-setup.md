# Локальная среда разработки

Этот документ дополняет `README.md` и описывает приёмы настройки сервисов CRM для локального запуска.
Базовые значения переменных окружения приведены в [`env.example`](../env.example), подробности по инфраструктуре — в [«Технологическом стеке»](tech-stack.md).

## Интеграции

Для большинства интеграций доступны лёгкие локальные заменители. Они ускоряют разработку и тестирование, позволяя не зависеть от внешних API.
Перед коммитом убедитесь, что нужные переменные окружения заданы, а заглушки запущены.

### Google Drive

* Заменитель: локальное файловое хранилище (например, MinIO или `localstack`), доступное по HTTP.
* Запуск: поднимите сервис командой `docker compose up minio` из корня репозитория или используйте любой совместимый S3-совместимый сервис с файловым бэкендом.
* Настройка:
  * `GOOGLE_DRIVE_EMULATOR_URL` — корень HTTP API эмулятора (по умолчанию `http://localhost:9000`).
  * `GOOGLE_DRIVE_SERVICE_ACCOUNT_JSON` и `GOOGLE_DRIVE_SHARED_DRIVE_ID` можно оставить пустыми; сервис Documents переключится на локальный драйвер, если URL эмулятора задан.
  * При необходимости укажите каталог хранения в `GOOGLE_DRIVE_EMULATOR_ROOT` (по умолчанию `./var/local-drive`).
* Использование: сервис Documents создаёт структуры каталогов и складывает файлы в локальную папку; права доступа моделируются на уровне приложения.

### Telegram webhook

* Заменитель: mock-сервер, который имитирует методы Telegram Bot API и вебхуки.
* Запуск: выполните `docker compose up telegram-mock` или любой иной контейнер/скрипт, выдающий ответы Telegram Bot API.
* Настройка:
  * `TELEGRAM_MOCK_ENABLED=true` — включает отправку запросов в заглушку и регистрирует локальный webhook.
  * `TELEGRAM_MOCK_SERVER_URL=http://localhost:8085/telegram` — адрес mock-сервиса, который принимает запросы бота.
  * `TELEGRAM_WEBHOOK_URL` можно указать как `http://gateway.local:8080/dev-webhook` для локальной отладки.
* Использование: Notifications-сервис получает апдейты через локальный webhook, mock-сервер позволяет скриптами воспроизводить сценарии (`curl`, Postman, коллекции HTTP-запросов).

### Ограничения и проверка в песочницах

| Интеграция | Ограничения локальных заглушек | Что перепроверить на боевых песочницах |
| --- | --- | --- |
| Google Drive | Нет фактических API Google: отсутствуют share-линки, версии, квоты. Ограниченная поддержка прав доступа и триггеров. | Массовая загрузка/удаление файлов, проверка прав доступа между пользователями, синхронизация с реальными shared drives. |
| Telegram | Нет проверки реальных токенов и ограничений Telegram. Отсутствуют лимиты rate limiting и антиспам. | Регистрацию и обновление webhook, рассылку массовых уведомлений, обработку медиа и вложений, реакции на rate limiting Telegram. |

> **Важно.** Прежде чем выкатывать код в dev/stage, запустите smoke-тесты против песочниц Google и Telegram и убедитесь, что токены/ключи сервисных аккаунтов не закоммичены.

Для дополнительных рекомендаций по локальному запуску сервисов смотрите соответствующие README внутри каталогов сервисов.
