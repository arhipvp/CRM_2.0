Назначение документа

Документ фиксирует базовые архитектурные принципы и технологические решения CRM-системы.
Он служит отправной точкой для команд разработки, эксплуатации и бизнес-заказчиков, помогая синхронизировать ожидания относительно сервисов и инфраструктуры.
Материал дополняет обзорные документы (README.md, docs/architecture.md, docs/security-and-access.md) и задаёт общие правила для детальных спецификаций отдельных сервисов.

Общие архитектурные принципы

Микросервисный подход. Функциональные домены выделяются в самостоятельные сервисы с чёткими API-контрактами, управляемыми через Gateway или BFF.

Единая база данных (на старте). Изначально сервисы используют одну реляционную СУБД с разграничением по схемам и правам; при росте — допускается декомпозиция по доменам.

Асинхронные коммуникации. Для обмена событиями и фоновых задач применяются очереди сообщений (RabbitMQ/Kafka) и публикация доменных событий.

Кеширование. Для ускорения чтения справочных и агрегированных данных используется Redis или аналогичный in-memory кеш с TTL и контролем согласованности.

Наблюдаемость и устойчивость. Все сервисы обязаны вести структурированные логи, метрики и трассировки (Prometheus, Grafana, OpenTelemetry), обеспечивать алерты и обработку ошибок с повторными попытками.

Управление конфигурацией и секретами. Конфигурации хранятся централизованно (Vault/SSM/Secrets Manager), секреты не попадают в репозиторий, развёртывание автоматизируется через CI/CD.

Безопасность по умолчанию. Реализованы единые механизмы аутентификации/авторизации, шифрование трафика, контроль доступа и регулярные проверки на соответствие требованиям безопасности.

Инфраструктура

Базы данных.

Основные сервисы (Auth, CRM/Deals, Payments, Tasks, Notifications) используют независимые PostgreSQL-кластеры с репликацией master–standby и резервным копированием в Backup-сервис.

Audit ведёт записи в отдельном инстансе PostgreSQL с включённым логированием длительных транзакций.

Брокеры сообщений и кэши.

RabbitMQ используется для обмена доменными событиями между сервисами (Notifications, Telegram Bot, Tasks).

Redis — для кэширования сессий Gateway и хранения краткоживущих токенов подтверждения.

Контейнеризация и оркестрация.

Для локальной разработки сервисы поднимаются через Docker Compose.

В тестовой среде используется k3s, в продакшене — управляемый Kubernetes-кластер с Helm-чартами и сетевой политикой через Istio.

Логирование и мониторинг.

Логи собираются через Promtail в Loki.

Метрики собирает Prometheus, визуализация и алерты настраиваются в Grafana.

Трейсинг ключевых операций реализован через OpenTelemetry и Tempo.

CI/CD и GitOps.

GitHub Actions выполняет сборку, тесты и публикацию контейнеров в GitHub Container Registry.

Argo CD синхронизирует Kubernetes-кластер с GitOps-репозиторием инфраструктуры после автоматических проверок качества.

Интеграции
Google Drive

Авторизация по OAuth 2.0 с сервисным аккаунтом Google Workspace; ключи хранятся в Secrets Manager.

Documents-сервис управляет OAuth-токенами, получает доступ к корневой папке проекта и создаёт вложенные каталоги по структуре из раздела «Хранение документов» в README.

Метаданные файлов (ID Drive, ссылка, владельцы-сущности, хэш, автор, временные метки) сохраняются в PostgreSQL Documents-сервиса.

Telegram-бот

Бот принимает обновления через HTTPS-webhook, терминируемый в Gateway; используется обратный прокси с автоматическим обновлением TLS-сертификатов (Let’s Encrypt).

Команды и уведомления помещаются в очередь RabbitMQ, откуда их читают Notifications и CRM/Deals. Ответы пользователям отправляются асинхронно.

Привязка Telegram-пользователя к учётной записи CRM хранится в Auth-сервисе, доступ предоставляется по gRPC-API.

Политика хранения импортируемых файлов

Файлы загружаются напрямую в Google Drive; в CRM хранятся только ссылки и метаданные.

Служебные файлы, прошедшие импорт, помечаются TTL в 90 дней; по истечении срока Documents-сервис инициирует проверку продления и при отсутствии подтверждения удаляет их из Drive.

Метаданные и события импорта фиксируются в Audit и сохраняются бессрочно для восстановления истории действий.

Дальнейшее развитие

Список технологий будет расширяться по мере детализации сервисов и инфраструктуры: выбор конкретных СУБД, брокеров сообщений, инструментов развёртывания и средств интеграции.
Все изменения документируются в соответствующих разделах docs/ и проходят ревью архитектурной комиссии проекта.