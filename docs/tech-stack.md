# Технологический стек

## Инфраструктура
- **Базы данных.** Основные сервисы (Auth, CRM/Deals, Payments, Tasks, Notifications) используют независимые PostgreSQL-кластеры с репликацией «master-standby» и резервным копированием в Backup-сервис; Audit ведёт записи в отдельном PostgreSQL-инстансе с включённым логированием длительных транзакций.
- **Брокеры сообщений и кэши.** RabbitMQ применяется для обмена доменными событиями между сервисами (Notifications, Telegram Bot, Tasks), Redis — для кэширования сессий Gateway и хранения краткоживущих токенов подтверждения.
- **Контейнеризация.** Для локальной разработки сервисы поднимаются через Docker Compose; в продакшене используется Kubernetes (k3s в тестовой среде и управляемый кластер в облаке) с Helm-чартами для развёртывания и сетевой политикой через Istio.
- **Логирование и мониторинг.** Приложения пишут структурированные логи в Loki через Promtail; метрики собираются Prometheus, визуализация и алерты настраиваются в Grafana. Трейсинг ключевых операций включён через OpenTelemetry и Tempo.
- **CI/CD.** GitHub Actions выполняет сборку, тесты и контейнеризацию образов, которые публикуются в GitHub Container Registry. Argo CD синхронизирует Kubernetes-кластер с GitOps-репозиторием инфраструктуры, применяя манифесты после прохождения автоматических проверок.

## Интеграции
### Google Drive
- Авторизация по OAuth 2.0 с сервисным аккаунтом Google Workspace; ключи хранятся в Secrets Manager облачного провайдера.
- Documents-сервис управляет OAuth-токенами, получает доступ к корневой папке проекта и создаёт вложенные каталоги по структуре из раздела «Хранение документов» в README.
- Метаданные файлов (идентификатор Drive, ссылка, владельцы-сущности, хэш контрольной суммы, автор, временные метки) сохраняются в PostgreSQL Documents-сервиса.

### Telegram-бот
- Бот принимает обновления через HTTPS-webhook, терминируемый в Gateway; в публичном сегменте используется обратный прокси с автоматическим обновлением TLS-сертификатов (Let's Encrypt).
- Команды и уведомления записываются в очередь RabbitMQ, откуда их читают Notifications и CRM/Deals для обработки сценариев. Ответы пользователям отправляются асинхронно через ту же очередь.
- Привязка пользователя Telegram к учётной записи CRM хранится в Auth-сервисе; бот запрашивает данные по gRPC-API.

### Политика хранения импортируемых файлов
- Файлы загружаются напрямую в Google Drive; в CRM хранятся только ссылки и метаданные.
- Служебные файлы, прошедшие импорт через интеграции, помечаются TTL в 90 дней; по истечении срока Documents-сервис инициирует проверку необходимости продления и автоматическое удаление в Drive при отсутствии подтверждения.
- Метаданные и события импорта записываются в Audit и сохраняются бессрочно для восстановления истории действий.
