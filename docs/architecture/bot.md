# Архитектура Telegram-бота

## Назначение сервиса
Telegram-бот обеспечивает мобильный доступ продавцов и исполнителей к ключевым функциям CRM: получение уведомлений, подтверждение задач и запуск быстрых сценариев создания сделки.

## Интеграции
- **Notifications (RabbitMQ)** — передача очереди событий и статусов доставки уведомлений через единый брокер RabbitMQ.
- **CRM/Deals** — создание черновиков сделок, дополнение журналов, запрос контекстной информации для ответов пользователю.
- **Auth** — проверка связки Telegram-аккаунта с пользователем и его ролями, выдача временных токенов для операций.

## Сценарии
1. **Быстрая сделка**: продавец вызывает команду `/new_deal`, бот запрашивает основные параметры и создаёт черновик сделки в CRM.
2. **Напоминание о задаче**: при получении события бот отправляет уведомление, пользователь может подтвердить выполнение или запросить перенос срока.
3. **Платёжный контроль**: бот сообщает о приближающихся платежах, направляет задачу продавцу с возможностью подтвердить оплату и уведомляет главного админа при необходимости эскалации.

## Технические детали
- Вебхук Telegram размещён за Gateway/BFF и передаёт события в сервис бота через защищённый канал.
- Очередь сообщений реализуется на базе брокера RabbitMQ и используется совместно с Notifications.
- Хранение состояния диалогов минимально и ограничено активными сценариями, чтобы не дублировать CRM.
- Реализация располагается в [`backend/telegram-bot`](../backend/telegram-bot/README.md) и построена на Python 3.11 + aiogram 3.
- FSM хранится в Redis, события публикуются через `aio-pika` в exchange `crm.domain`, `tasks.events` и `notifications.events` с
  заголовками CloudEvents (`ce-specversion: 1.0`).
- Команды `/new_deal`, `/confirm_task` и `/confirm_payment` вызывают CRM/Notifications и публикуют события `crm.deal.created`,
  `tasks.task.status_changed`, `crm.deal.payment.updated` для согласованности с [docs/integration-events.md](integration-events.md).
- Подписка на очередь `telegram.bot.notifications` позволяет обрабатывать события `notifications.notification.dispatched` и
  доставлять сообщения пользователям через Bot API.

