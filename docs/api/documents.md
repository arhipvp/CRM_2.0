# Documents API

## Общая информация
- **Базовый URL:** `https://documents.internal`
- **Примечание:** маршруты в разделах указаны абсолютными путями. Если путь начинается с `/api/v1`,
  он включает версию API в префиксе; эндпоинты без этого префикса доступны напрямую, например `/documents`.
- **Аутентификация:** сервисный JWT, операции загрузки требуют scope `documents.write`
- **Назначение:** управление метаданными файлов, синхронизация с серверным хранилищем (локальные каталоги или примонтированный том), контроль доступа на уровне файловой системы.

## Папки и структура

### POST `/api/v1/folders`
Создаёт каталог в файловой системе для клиента/сделки/полиса (внутри `DOCUMENTS_STORAGE_ROOT`).

> Название формируется из шаблонов `DOCUMENTS_FOLDERS_TEMPLATE_*`. Доступные плейсхолдеры: `{title}`, `{ownerId}`, `{ownerType}`. Путь строится как `<DOCUMENTS_STORAGE_ROOT>/<owner_type>/<slug по шаблону>`.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| owner_type | string | Да | `client`, `deal`, `policy`, `payment`. |
| owner_id | UUID | Да | ID сущности. |
| title | string | Да | Название папки. |
| parent_path | string | Нет | Относительный путь родительского каталога (например, `clients/uuid`). |

**Ответ 201**
```json
{
  "folder_path": "clients/uuid",
  "full_path": "/var/lib/crm/documents/clients/uuid",
  "public_url": "https://files.crm.local/clients/uuid"
}
```

`public_url` возвращается, только если настроена публикация каталога: сервис использует ссылку, полученную от драйвера хранилища, либо собирает её из `DOCUMENTS_STORAGE_PUBLIC_BASE_URL` (первый приоритет) или `DOCUMENTS_FOLDERS_WEB_BASE_URL` (резервный базовый URL). Если публичная ссылка недоступна, поле будет `null`.

**Ошибки:** `400 validation_error`, `409 folder_exists`.

> Проверка существования владельца выполняется на стороне CRM до обращения к Documents API, поэтому маршрут не возвращает `owner_not_found`.

### GET `/api/v1/folders/{owner_type}/{owner_id}`
Возвращает метаданные каталога сущности.

**Ответ 200** — `{ "folder_path": "...", "full_path": "...", "public_url": "..." }`. Поле `public_url` может быть `null`, если публичный доступ к каталогу не настроен.

**Ошибки:** `404 folder_not_found`.

## Документы

### POST `/documents`
Регистрирует документ и загружает файл через подписанный URL.

**Шаги:**
1. Сервис вызывает `/documents` для регистрации метаданных.
2. В ответе возвращается `upload_url` и `document_id`.
3. Клиент загружает файл по `upload_url` (PUT к объектному хранилищу).
4. После загрузки вызывается `/documents/{document_id}/complete`.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| owner_type | string | Да | Уровень привязки (`client`, `deal`, `policy`, `payment`). |
| owner_id | UUID | Да | ID сущности. |
| title | string | Да | Название документа. |
| document_type | string | Нет | Тип (полис, акт и т.п.). |
| notes | string | Нет | Примечание. |
| tags | array[string] | Нет | Свободные метки. |

**Ответ 201**
```json
{
  "document_id": "uuid",
  "upload_url": "https://storage/...",
  "expires_in": 900
}
```

`expires_in` совпадает со значением `DOCUMENTS_UPLOAD_URL_TTL` (в секундах). `upload_url` — подписанная ссылка для одноразовой загрузки файла в файловый шлюз (HTTP/S3 совместимый endpoint), который сохраняет данные под каталоги `DOCUMENTS_STORAGE_ROOT`.

**Ошибки:** `400 validation_error`.

> Сервис не проверяет существование владельца на этапе регистрации документа. Проверка принадлежности и прав доступа выполняется на стороне CRM до обращения к API, чтобы избежать несогласованных записей.

### POST `/documents/{document_id}/complete`
Подтверждает успешную загрузку файла.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| fileSize | integer | Да | Размер загруженного файла в байтах. |
| checksum | string | Да | Хэш файла в шестнадцатеричном виде (MD5/SHA256 — зависит от клиента). |

**Ответ 200** — документ переводится в статус `uploaded`, сохраняются размер и контрольная сумма. После подтверждения сервис ставит задачу синхронизации (`POST /documents/{document_id}/sync`), которая пересчитывает размер и контрольную сумму, а также обновляет метаданные и ссылки на каталог.

**Ошибки:**
- `404 document_not_found` — документ не найден или был помечен удалённым (`{"statusCode":404,"code":"document_not_found","message":"Документ {document_id} не найден"}`).
- `409 upload_conflict` — документ уже подтверждён/финализирован. Ответ содержит статус в деталях (`{"statusCode":409,"code":"upload_conflict","message":"Документ {document_id} уже находится в статусе {status}","details":{"status":"synced"}}`).

### GET `/documents`
Поиск документов.

**Параметры запроса**
| Имя | Тип | Описание |
| --- | --- | --- |
| owner_id | UUID | Фильтр по сущности (`metadata.ownerId`). |
| owner_type | string | Ограничение на тип (`metadata.ownerType`). |
| document_type | array[string] | Фильтр по типу документа (`metadata.documentType`). Можно передавать массив параметров `document_type[]=...` или через запятую. |
| status | string | Необязательный фильтр по статусу документа. Допустимые значения: `draft`, `pending_upload`, `uploading`, `uploaded`, `synced`, `error`. |
| search | string | Поиск по названию, описанию и заметкам (`metadata.notes`). |
| limit | integer | По умолчанию 25, максимум 200. |
| offset | integer | Смещение с начала списка (по умолчанию 0). |

Фильтр по `status` можно комбинировать с любыми другими параметрами, перечисленными выше.

**Пример запроса**

```
GET /documents?owner_type=deal&owner_id=uuid&status=synced
```

**Ответ 200** — массив документов с метаданными (мягко удалённые записи не возвращаются).

> Заголовок `X-Total-Count` содержит общее количество записей без учёта пагинации.

### GET `/documents/{document_id}`
Возвращает полные метаданные документа.

**Ответ 200** — объект, соответствующий `DocumentEntity`:

```json
{
  "id": "uuid",
  "name": "Полис ОСАГО",
  "description": "Скан от клиента",
  "metadata": {
    "ownerType": "deal",
    "ownerId": "uuid",
    "documentType": "policy",
    "notes": "Срочно",
    "tags": ["основной"]
  },
  "status": "synced",
  "storagePath": "deal/uuid/<document_id>.pdf",
  "publicUrl": "https://files.crm.local/deal/uuid/<document_id>.pdf",
  "mimeType": "application/pdf",
  "size": "524288",
  "checksumMd5": "d41d8cd98f00b204e9800998ecf8427e",
  "uploadedAt": "2024-05-12T09:32:11.231Z",
  "syncedAt": "2024-05-12T09:32:15.011Z",
  "createdAt": "2024-05-10T18:24:01.000Z",
  "updatedAt": "2024-05-12T09:32:15.011Z"
}
```

`metadata.ownerType` и `metadata.ownerId` определяют связь с сущностью CRM. Если документ не синхронизирован с хранилищем, `storagePath`, `publicUrl`, `size`, `checksumMd5`, `uploadedAt` и `syncedAt` могут быть `null`. В ответе не возвращаются документы, помеченные как удалённые.

**Ошибки:** `404 document_not_found`, `409 already_deleted`.

### DELETE `/documents/{document_id}`
Вызывает `DocumentsService.remove`, который удаляет файл из каталога документов (если он существует) и помечает запись как удалённую (soft delete) без постановки фоновых задач и без изменений ACL.

> ⚠️ Дополнительные действия — например, очистка симлинков, управление ACL или повторная индексация — должны выполняться во внешних процессах/воркерах, если они требуются в конкретной интеграции. API не инициирует эти шаги, чтобы ожидания оставались корректными.

**Ответ 204** — без тела. Повторная попытка удалить уже помеченный документ возвращает `409 already_deleted`.

**Ошибки:**
- `404 document_not_found` — запись не найдена (`{"statusCode":404,"code":"document_not_found","message":"Документ {document_id} не найден"}`).
- `409 already_deleted` — документ был ранее удалён (`{"statusCode":409,"code":"already_deleted","message":"Документ {document_id} уже удалён"}`).

### PATCH `/documents/{document_id}`
Частично обновляет метаданные документа. Используется DTO `UpdateDocumentDto`, наследующий все поля из `CreateDocumentDto`, но делающий их необязательными.

**Тело запроса**
| Поле | Тип | Ограничения |
| --- | --- | --- |
| ownerType | string | Значение из набора `client`, `deal`, `policy`, `payment`. Поле переносится в `metadata.ownerType`. |
| ownerId | UUID | Валидируется как `@IsUUID()`. Обновляет `metadata.ownerId`. |
| title | string | Обязателен при создании, в PATCH необязателен. Максимум 255 символов. Записывается в `name`. |
| documentType | string | Необязательное поле длиной до 255 символов. Передайте пустую строку, чтобы удалить тип из метаданных. |
| notes | string | Необязательное описание. `null` не проходит валидацию; пустая строка очищает описание (в `description` и `metadata.notes` сохраняется пустое значение). |
| tags | array[string] | Массив строк (до 50 элементов, каждый тег до 64 символов). Пустой массив очищает `metadata.tags`. |

Все поля проходят стандартные преобразования из `CreateDocumentDto`: можно использовать синонимы в snake_case (`owner_type`, `document_type`, `owner_id`). Любое поле, отсутствующее в теле запроса, остаётся без изменений.

**Ответ 200** — обновлённый документ в формате, идентичном `GET /documents/{document_id}`.

**Ошибки:** `404 document_not_found`, `409 already_deleted`, `400 validation_error`.

### POST `/documents/{document_id}/upload`

**Назначение.** Переотправляет документ на повторную обработку в очередь загрузки BullMQ (`documents.upload`) через `DocumentsQueueService`. Вызов предназначен для ручного восстановления очереди после сбоя, повторной постановки задач по документам со статусом `error` или повторного применения метаданных без выдачи новой подписанной ссылки.

**Ответ 201**
```json
{ "id": "uuid", "status": "queued" }
```

Воркер переводит документ в статус `uploading`, проверяет/создаёт путь в хранилище и копирует файл из источника (`storagePath` или `sourceUri`), затем устанавливает размер, контрольную сумму и публичный URL. Маршрут не формирует новую подписанную ссылку на загрузку — он только ставит задание в очередь повторной обработки. Подробнее о взаимодействии API и воркера см. раздел [«Фоновая обработка документов»](#фоновая-обработка-документов).

**Ошибки:** `404 document_not_found`, `409 already_deleted`.

### POST `/documents/{document_id}/sync`

**Назначение.** Принудительно ставит документ в очередь BullMQ `documents.sync` (также через `DocumentsQueueService`), чтобы вручную инициировать синхронизацию с фактическим хранилищем. Используйте маршрут для восстановления очереди, если требуется повторно обработать документ после ручного обновления файлов или восстановления из бэкапа.

**Ответ 201**
```json
{ "id": "uuid", "status": "queued" }
```

Воркер проверяет наличие файла по `storagePath`, пересчитывает размер и MD5, обновляет `publicUrl`, `syncedAt` и объединяет метаданные с результатами драйвера хранилища. После `POST /documents/{document_id}/complete` синхронизация ставится автоматически; повторный ручной вызов нужен только при внешних изменениях или диагностике ошибок. Дополнительные детали приводятся в разделе [«Фоновая обработка документов»](#фоновая-обработка-документов).

**Ошибки:** `404 document_not_found`, `409 already_deleted`.

## Фоновая обработка документов

REST-эндпоинты `POST /documents/{id}/upload` и `POST /documents/{id}/sync` используют `DocumentsQueueService`, который публикует задания BullMQ в очереди `documents.upload` и `documents.sync`. Их обрабатывает отдельный воркер, описанный в разделе [«Documents: быстрый старт»](../local-setup.md#documents-быстрый-старт); он должен быть запущен, чтобы API смогло перевести документы из статусов `uploading`/`synced` и выполнить повторную постановку задач.

## Доступы

### POST `/api/v1/permissions/sync`
Ставит задачу `documents.permissions.sync` на обновление прав каталога в файловом хранилище (POSIX-права, ACL, группы). Эндпоинт
возвращает только идентификаторы созданной задачи в очереди и соответствующей записи в БД.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| owner_type | string | Да | Тип сущности. |
| owner_id | UUID | Да | ID. |
| users | array[string] | Да | Список идентификаторов пользователей (UUID/почта), которые должны получить доступ. На их основе сервис сопоставляет системные группы/UID. |

**Ответ 202**
```json
{
  "job_id": "bullmq-job-id",
  "task_id": "permissions-task-id"
}
```

`job_id` соответствует идентификатору задания BullMQ, `task_id` — записи в таблице `permissions_sync_tasks`. Дополнительные атрибуты синхронизации (режим каталога, применённые ACL и т.п.) сохраняются в БД задач и доступны через сервис очередей. TTL задания в очереди регулируется переменной `DOCUMENTS_PERMISSIONS_SYNC_JOB_TTL` (в секундах).

**Ошибки:** `400 validation_error`, `404 folder_not_found`.

### Таблица `permissions_sync_tasks`

| Колонка | Тип | Назначение |
| --- | --- | --- |
| `id` | `uuid` | Первичный ключ, совпадает с `task_id`, возвращаемым API. Генерируется PostgreSQL (`gen_random_uuid()`). |
| `owner_type` | `varchar(32)` | Тип сущности каталога (`client`, `deal`, `policy`, `payment`). |
| `owner_id` | `uuid` | Идентификатор владельца каталога. |
| `folder_path` | `varchar(1024)` | Относительный путь каталога в `DOCUMENTS_STORAGE_ROOT`. |
| `job_id` | `varchar(255)` | Идентификатор задания BullMQ в очереди `documents.permissions.sync` (или другом имени из `DOCUMENTS_PERMISSIONS_SYNC_QUEUE_NAME`). |
| `users` | `jsonb` | Список пользователей (UUID/почты), для которых пересобираются права. |
| `created_at` | `timestamptz` | Время постановки задачи. |
| `updated_at` | `timestamptz` | Последнее обновление записи. |

Дополнительно созданы индексы по `job_id` и паре (`owner_type`, `owner_id`), чтобы быстро находить задачу по идентификатору BullMQ или сущности владельца.

**Как отследить статус.** `job_id` позволяет найти задание в очереди BullMQ, которую сервис создаёт с именем `queues.permissionsSync.name` (по умолчанию `documents.permissions.sync`) и префиксом `DOCUMENTS_REDIS_PREFIX`. Подключитесь к Redis и используйте инструменты BullMQ (`Queue.getJob(job_id)`, Bull Board, `bullmq` CLI), указав это имя очереди — статус в ней отражает текущее состояние фоновой синхронизации. Дополнительный контекст (`folder_path`, список пользователей) можно получить из строки таблицы `permissions_sync_tasks` по `task_id`.

## Стандартные ошибки Documents API

| Код | Сообщение | Описание |
| --- | --- | --- |
| 400 | `validation_error` | Ошибка входных данных. |
| 401 | `unauthorized` | Неверный токен. |
| 403 | `forbidden` | Нет прав на работу с папкой. |
| 404 | `document_not_found` | Документ не найден или удалён. |
| 409 | `upload_conflict`/`already_deleted` | Конфликт состояния (повторное подтверждение загрузки или удаление). |
| 413 | `file_too_large` | Файл превышает допустимый размер. |
| 500 | `internal_error` | Внутренняя ошибка сервиса. |
