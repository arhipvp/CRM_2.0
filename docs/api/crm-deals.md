# CRM / Deals API

## Общая информация
- **Базовый URL:** `https://crm.internal/api/v1`
- **Аутентификация:** сервисный JWT от Gateway/Auth (`Authorization: Bearer <token>`)
- **Назначение:** CRUD-операции по клиентам, сделкам, полисам и задачам первого уровня.
- **Контекст арендатора:** все запросы требуют заголовок `X-Tenant-ID` (UUID). Значение используется для политик RLS в схеме `crm` и маршрутизации фоновых задач.

## Клиенты

### GET `/clients`
Возвращает список клиентов арендатора.

**Заголовки**
- `X-Tenant-ID` *(обязательно)* — UUID арендатора.

**Параметры ответа** — массив объектов `Client`:
```json
{
  "id": "5cb2f9ae-dc0c-4dd6-8abf-50d0fa3b9c2f",
  "name": "ООО Ромашка",
  "email": "info@example.com",
  "phone": "+7-900-123-45-67",
  "status": "active",
  "owner_id": "2f6f2803-5f69-4f9a-9cb0-f7e0c6f90958",
  "tenant_id": "1c54c7ba-ea78-44ec-9f40-5861ab6b0107",
  "created_at": "2024-03-15T12:00:00Z",
  "updated_at": "2024-03-15T12:00:00Z"
}
```

### POST `/clients`
Создаёт клиента.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| name | string | Да | Имя/название клиента. |
| email | string | Нет | Контактный e-mail. |
| phone | string | Нет | Контактный телефон. |
| status | string | Нет | `active`/`inactive`/`prospect`, по умолчанию `active`. |
| owner_id | UUID | Да | Ответственный пользователь (используется для RLS). |

**Ответ 201** — объект клиента.

### PATCH `/clients/{client_id}`
Частично обновляет клиента. Допустимы поля `name`, `email`, `phone`, `status`.

## Сделки

### GET `/deals`
Возвращает список сделок арендатора, отсортированных по `next_review_at` (самые ближайшие проверки первыми) с дополнительной сортировкой по `updated_at`.

**Особенности ответа**
- Сортировка: по возрастанию `next_review_at`, затем по возрастанию `updated_at` для сделок с одинаковой датой ревизии.
- Поле `next_review_at` возвращается в формате `YYYY-MM-DD` без времени.

**Параметры запроса**
| Параметр | Тип | Обязательный | Описание |
| --- | --- | --- | --- |
| sort | string | Нет | `next_review_at` (по умолчанию), `updated_at` или `created_at`. Суффикс `:desc` переворачивает порядок. |

**Правила сортировки**
- При сортировке по `next_review_at` записи упорядочиваются по возрастанию даты ближайшего обзора; значения в прошлом идут первыми.
- Значения `null` не используются: поле обязательное и всегда заполнено валидной датой.
- Для стабилизации выдачи используется дополнительная сортировка по `updated_at ASC` внутри блоков с одинаковым `next_review_at`.

**Параметры ответа** — массив объектов `Deal`:
```json
{
  "id": "c6bd825f-6c7b-49f2-96af-5ffdc2d1d5d2",
  "client_id": "5cb2f9ae-dc0c-4dd6-8abf-50d0fa3b9c2f",
  "title": "КАСКО для автопарка",
  "status": "in_progress",
  "value": 1250000,
  "owner_id": "2f6f2803-5f69-4f9a-9cb0-f7e0c6f90958",
  "next_review_at": "2024-11-01",
  "created_at": "2024-10-12T15:23:41Z",
  "updated_at": "2024-10-18T10:12:05Z"
}
```

> **Важно:** поле `next_review_at` обязательно — оно определяет позицию сделки в «повестке» воронки и карточки деталей. Попытка передать `null` приведёт к ошибке валидации; чтобы изменить порядок, устанавливайте нужную дату обзора.

### POST `/deals`
Создаёт сделку.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| client_id | UUID | Да | Идентификатор клиента. |
| title | string | Да | Название сделки. |
| description | string | Нет | Свободный комментарий. |
| status | string | Нет | Текущий статус (по умолчанию `draft`). |
| value | number | Нет | Планируемая сумма. |
| owner_id | UUID | Да | Ответственный менеджер. |
| next_review_at | date (`YYYY-MM-DD`) | Да | Дата следующего обзора сделки. Значение обязательно и не может быть `null`. |

> `next_review_at` хранится как тип `date` без времени. При создании сделки допускается только валидная календарная дата в формате `YYYY-MM-DD`.

**Ответ 201** — объект сделки.

### PATCH `/deals/{deal_id}`
Обновляет отдельные поля сделки.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| title | string | Нет | Новое название сделки. |
| description | string | Нет | Обновлённое описание. |
| status | string | Нет | Новый статус сделки. |
| value | number | Нет | Новая планируемая сумма. |
| next_review_at | date (`YYYY-MM-DD`) | Нет | Новая дата следующего обзора. При передаче не может быть `null`; чтобы оставить дату без изменений, не указывайте поле. |

## Расчёты

### GET `/deals/{deal_id}/calculations`
Возвращает расчёты конкретной сделки. Выдача отсортирована по дате получения (`calculation_date` по убыванию) и времени создания.

**Параметры запроса**
| Параметр | Тип | Обязательный | Описание |
| --- | --- | --- | --- |
| `status[]` | array<string> | Нет | Фильтр по статусам (`draft`, `ready`, `confirmed`, `archived`). |
| `insurance_company` | string | Нет | Подстрочный поиск по названию страховой компании. |
| `calculation_date_from` | date | Нет | Нижняя граница даты получения расчёта. |
| `calculation_date_to` | date | Нет | Верхняя граница даты получения расчёта. |

**Пример ответа**
```json
[
  {
    "id": "38e47d5c-207d-4b73-8e0f-22c7c873cc26",
    "deal_id": "8b1b9c9f-987a-4c1a-b0f4-a1d88f3d1eb4",
    "tenant_id": "1c54c7ba-ea78-44ec-9f40-5861ab6b0107",
    "owner_id": "6d5c0686-7a7f-4f98-9b3c-1e1fbb44aa01",
    "insurance_company": "Ингосстрах",
    "program_name": "КАСКО Премиум",
    "premium_amount": 150000,
    "coverage_sum": 5000000,
    "calculation_date": "2025-05-18",
    "validity_period": { "start": "2025-05-18", "end": "2026-05-18" },
    "files": ["calc-001.pdf", "calc-002.pdf"],
    "comments": "Вариант для директора",
    "status": "ready",
    "linked_policy_id": null,
    "created_at": "2025-05-18T12:03:00Z",
    "updated_at": "2025-05-19T08:10:00Z"
  }
]
```

### POST `/deals/{deal_id}/calculations`
Создаёт расчёт.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| insurance_company | string | Да | Название страховой компании. |
| program_name | string | Нет | Название программы. |
| premium_amount | number | Нет | Страховая премия (положительное число). |
| coverage_sum | number | Нет | Страховая сумма. |
| calculation_date | date | Да | Дата получения расчёта. |
| validity_period | object | Нет | Диапазон действия: `{ "start": "YYYY-MM-DD", "end": "YYYY-MM-DD" }`. |
| files | array<string> | Нет | Пути или идентификаторы файлов расчёта. |
| comments | string | Нет | Внутренние комментарии. |
| owner_id | UUID | Да | Ответственный пользователь. |

Ответ возвращает объект `Calculation` со статусом `draft`.

### PATCH `/deals/{deal_id}/calculations/{calculation_id}`
Частично обновляет расчёт. Допустимы поля из тела запроса создания; отсутствие поля означает «оставить без изменений». Передача `validity_period: null` очищает диапазон действия.

### POST `/deals/{deal_id}/calculations/{calculation_id}/status`
Меняет статус расчёта. Допустимые переходы: `draft → ready`, `ready → confirmed`, `ready → archived`, `confirmed → archived`. Архивные расчёты изменить нельзя.

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| status | string | Да | Новый статус (`ready`, `confirmed`, `archived`). |
| policy_id | UUID | Нет | Требуется при подтверждении (`status=confirmed`), если расчёт привязывается к существующему полису сделки. |

При переводе в статус `ready` CRM проверяет наличие заполненных полей (`program_name`, `premium_amount`, диапазон действия) и хотя бы одного файла. При подтверждении расчёт привязывается к полису (`crm.policies.calculation_id`) и публикует событие `deal.calculation.status.confirmed`. Попытка привязать полис другой сделки или уже занятый расчётом вернёт ошибку `400` с кодом `policy_not_found`/`policy_already_linked`.

### DELETE `/deals/{deal_id}/calculations/{calculation_id}`
Помечает расчёт удалённым. Связь с полисом очищается автоматически. Повторное обращение к карточке вернёт `404`.

> **События:** при операциях над расчётами CRM публикует `deal.calculation.created`, `deal.calculation.updated`, `deal.calculation.status.<status>` и `deal.calculation.deleted` в обменник `crm.events` (тип `topic`).
## Журнал сделки

Журнал фиксирует заметки менеджеров прямо в карточке сделки. Записи упорядочиваются по времени создания и доступны в REST API.

### GET `/deals/{deal_id}/journal`
Возвращает записи журнала по сделке.

**Параметры запроса**
| Параметр | Тип | Обязательный | Описание |
| --- | --- | --- | --- |
| limit | integer | Нет | Количество записей на страницу (1–200, по умолчанию 50). |
| offset | integer | Нет | Смещение для постраничной навигации. |

**Ответ 200** — объект `DealJournalEntryList`:
```json
{
  "items": [
    {
      "id": "f4c318ad-9305-4fe9-9fc6-4c97a2e5e9a2",
      "deal_id": "c6bd825f-6c7b-49f2-96af-5ffdc2d1d5d2",
      "author_id": "2f6f2803-5f69-4f9a-9cb0-f7e0c6f90958",
      "body": "Созвонились с клиентом, договорились о встрече",
      "created_at": "2024-06-20T09:15:00Z"
    }
  ],
  "total": 1
}
```

### POST `/deals/{deal_id}/journal`
Добавляет запись журнала. Используется для фиксации действий и договорённостей в сделке.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| author_id | UUID | Да | Автор заметки. |
| body | string | Да | Текст заметки (1–5000 символов). |

**Ответ 201** — объект `DealJournalEntry`.

**События**
- `deal.journal.appended` — публикуется при создании записи. Полезная нагрузка включает `tenant_id`, `deal_id`, `entry_id`, `author_id`, `body`, `created_at`.

## Полисы

### GET `/policies`
Список полисов по арендаторам.

### POST `/policies`
Создаёт полис.

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| client_id | UUID | Да | Связанный клиент. |
| deal_id | UUID | Нет | Сделка, к которой относится полис. |
| policy_number | string | Да | Номер полиса (уникален). |
| status | string | Нет | `draft`/`active`/`closed`, по умолчанию `draft`. |
| premium | number | Нет | Сумма премии. |
| effective_from | date | Нет | Дата начала действия. |
| effective_to | date | Нет | Дата окончания действия. |
| owner_id | UUID | Да | Ответственный пользователь. |

### PATCH `/policies/{policy_id}`
Обновляет `status`, `premium`, `effective_from`, `effective_to`.

## Платежи

CRM ведёт платежи внутри сервиса; подробные сценарии описаны в [`docs/api/payments.md`](payments.md). Основные маршруты:

- `GET /deals/{deal_id}/policies/{policy_id}/payments` — список платежей полиса с агрегатами и фильтром по статусу (`status[]=paid`).
- `POST /deals/{deal_id}/policies/{policy_id}/payments` — создание платежа с плановой датой и суммой.
- `POST /deals/{deal_id}/policies/{policy_id}/payments/{payment_id}/incomes` / `/expenses` — фиксация поступлений и расходов.
- `PATCH`/`DELETE` для платежей и отдельных операций пересчитывают агрегаты (`incomes_total`, `expenses_total`, `net_total`) и публикуют события `deal.payment.*`.

## Задачи первого уровня

### GET `/tasks`
Возвращает задачи, связанные со сделками или клиентами.

### POST `/tasks`
Создаёт задачу для менеджера.

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| title | string | Да | Краткое описание задачи. |
| description | string | Нет | Детальное описание. |
| status | string | Нет | `open`/`in_progress`/`done`, по умолчанию `open`. |
| priority | string | Нет | `low`/`normal`/`high`, по умолчанию `normal`. |
| due_date | date | Нет | Плановая дата выполнения. |
| deal_id | UUID | Нет | Привязка к сделке. |
| client_id | UUID | Нет | Привязка к клиенту. |
| owner_id | UUID | Да | Исполнитель. |

### PATCH `/tasks/{task_id}`
Изменяет `title`, `description`, `status`, `priority`, `due_date`.

## Права доступа

### POST `/permissions/sync`
Создаёт задание BullMQ на синхронизацию прав пользователей с внешним сервисом документов.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| owner_type | string | Да | Тип сущности (например, `deal`, `policy`). |
| owner_id | UUID | Да | Идентификатор сущности. |
| users | array<object> | Да | Массив `{ "user_id": "uuid", "role": "viewer|editor" }`. |

**Ответ 202** — в теле находится идентификатор задания и статус `queued`.

## Интеграция с платежами
- Платёжные события обрабатываются внутри CRM: при создании или редактировании платежа (включая отдельные позиции доходов/расходов) публикуется `deal.payment.updated` в `crm.events` с агрегированными суммами и детализацией движений.
- Внешних очередей для синхронизации с модулем платежей CRM больше нет; повторные попытки редактирования выполняются на уровне REST API.
- Один полис может иметь несколько платежей; в API возвращается совокупный платёж с вложенными позициями, поэтому потребителям важно использовать `payment_id` в качестве ключа идемпотентности.
