# CRM / Deals API

## Общая информация
- **Базовый URL:** `https://crm.internal/api/v1`
- **Аутентификация:** сервисный JWT от Gateway/Auth (`Authorization: Bearer <token>`)
- **Назначение:** CRUD-операции по клиентам, сделкам, полисам и задачам первого уровня.

## Клиенты

### GET `/clients`
Возвращает список клиентов.

**Параметры ответа** — массив объектов `Client`:
```json
{
  "id": "5cb2f9ae-dc0c-4dd6-8abf-50d0fa3b9c2f",
  "name": "ООО Ромашка",
  "email": "info@example.com",
  "phone": "+7-900-123-45-67",
  "status": "active",
  "owner_id": "2f6f2803-5f69-4f9a-9cb0-f7e0c6f90958",
  "created_at": "2024-03-15T12:00:00Z",
  "updated_at": "2024-03-15T12:00:00Z"
}
```

> `owner_id` может быть `null`, если карточка клиента ещё не распределена между менеджерами (например, после первичного импорта). Такие записи доступны только администраторам или при фильтрах, явно разрешающих клиентов без владельца.

### POST `/clients`
Создаёт клиента.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| name | string | Да | Имя/название клиента. |
| email | string | Нет | Контактный e-mail. |
| phone | string | Нет | Контактный телефон. |
| status | string | Нет | `active`/`inactive`/`prospect`, по умолчанию `active`. |
| owner_id | UUID | Нет | Ответственный пользователь (используется для RLS). Если не передан, клиент создаётся без назначенного владельца. |

> Клиенты без владельца применяются в сценариях импорта или первичного распределения базы, когда карточки должны быть видны администраторам и позже вручную назначаться менеджерам.

**Ответ 201** — объект клиента.

### GET `/clients/{client_id}`
Возвращает карточку конкретного клиента по идентификатору.

**Ответ 200** — объект `Client`:
```json
{
  "id": "5cb2f9ae-dc0c-4dd6-8abf-50d0fa3b9c2f",
  "name": "ООО Ромашка",
  "email": "info@example.com",
  "phone": "+7-900-123-45-67",
  "status": "active",
  "owner_id": null,
  "created_at": "2024-03-15T12:00:00Z",
  "updated_at": "2024-03-15T12:00:00Z"
}
```

**Ошибки**
- `404 client_not_found` — клиент с указанным идентификатором не существует или удалён.

### PATCH `/clients/{client_id}`
Частично обновляет клиента. Допустимы поля `name`, `email`, `phone`, `status`.

## Сделки

### GET `/deals`
Возвращает список сделок. Выдача отсортирована по возрастанию `next_review_at`; сделки с одинаковой датой идут по `updated_at ASC`.

**Особенности ответа**
- Поле `next_review_at` возвращается в формате `YYYY-MM-DD` без времени.
- Значения `next_review_at` всегда заданы и участвуют в сортировке.

**Параметры запроса**
| Параметр | Тип | Обязательный | Описание |
| --- | --- | --- | --- |
| `stage` | string | Нет | Фильтр по стадиям воронки: `qualification`, `negotiation`, `proposal`, `closedWon`, `closedLost`. Значение `all` или отсутствие параметра отключает фильтр. |
| `manager[]` | array<string> | Нет | Список UUID-ов ответственных менеджеров. Дополнительное значение `__NO_MANAGER__` включает сделки без владельца. |
| `period` | string | Нет | Горизонт по дате обзора: `7d`, `30d`, `90d`, `all`. Значения `7d`/`30d`/`90d` ограничивают `next_review_at` ближайшими 7/30/90 днями, `all` снимает ограничение. |
| `search` | string | Нет | Подстрочный поиск по названию и описанию. Пробелы по краям обрезаются; пустые строки игнорируются. |

**Примечания по фильтрации**
- `stage=qualification` возвращает статусы `draft` и `qualification`, `stage=negotiation` — `in_progress` и `negotiation`, `stage=proposal` — `proposal`, `stage=closedWon` — `won` и `closed_won`, `stage=closedLost` — `lost` и `closed_lost`.
- Если переданы и `manager[]=<uuid>`, и `manager[]=__NO_MANAGER__`, то в ответ войдут сделки как с указанными менеджерами, так и без назначенного владельца.
- `period` применяется относительно текущей даты и не исключает просроченные сделки: карточки с `next_review_at` в прошлом остаются в выдаче.
- `search` нечувствителен к регистру и ищет совпадения в `title` и `description`.

**Параметры ответа** — массив объектов `Deal`:
```json
{
  "id": "c6bd825f-6c7b-49f2-96af-5ffdc2d1d5d2",
  "client_id": "5cb2f9ae-dc0c-4dd6-8abf-50d0fa3b9c2f",
  "title": "КАСКО для автопарка",
  "status": "in_progress",
  "owner_id": "2f6f2803-5f69-4f9a-9cb0-f7e0c6f90958",
  "next_review_at": "2024-11-01",
  "created_at": "2024-10-12T15:23:41Z",
  "updated_at": "2024-10-18T10:12:05Z"
}
```

> **Важно:** поле `next_review_at` обязательно — оно определяет позицию сделки в «повестке» воронки и карточки деталей. Попытка передать `null` приведёт к ошибке валидации; чтобы изменить порядок, устанавливайте нужную дату обзора.

> **Примечание:** `owner_id` может быть `null`, если сделка ещё не распределена между менеджерами.

> Денежная оценка сделки в API больше не хранится: финансовые показатели доступны через расчёты, полисы и платежи.

**Пример запроса**

```http
GET /deals?stage=negotiation&manager[]=72c8d85f-6e4c-4ab2-9d5a-a2c2d7c8f0b3&manager[]=__NO_MANAGER__&period=30d&search=каско HTTP/1.1
Authorization: Bearer <token>
```

Запрос вернёт сделки стадии переговоров, у которых дата ближайшего обзора наступает в течение 30 дней, а владельцы либо указанный менеджер, либо отсутствуют; поиск выполнится по ключевому слову «каско».

### GET `/deals/{deal_id}`
Возвращает карточку конкретной сделки.

- **Параметры пути:** `deal_id` — UUID сделки.
- **Ответ 200:** объект `Deal` в формате, описанном выше.
- **Ошибки:** `404 deal_not_found`, если сделка удалена или не существует.

### GET `/deals/stage-metrics`
Возвращает агрегированные показатели по стадиям воронки с учётом тех же фильтров, что и `/deals`.

**Параметры запроса** — такие же, как у `GET /deals` (`stage`, `manager[]`, `period`, `search`).

**Структура элемента `DealStageMetric`**
| Поле | Тип | Описание |
| --- | --- | --- |
| stage | string | Текущая стадия воронки (`qualification`, `negotiation`, `proposal`, `closedWon`, `closedLost`). |
| count | integer | Количество сделок в стадии с учётом фильтров. |
| total_value | number | Сумма плановых платежей сделок (без отменённых) на стадии. |
| conversion_rate | number | Доля сделок в стадии относительно общего числа найденных. |
| avg_cycle_duration_days | number\|null | Средняя длительность стадии от создания до последнего обновления, дни. |

**Ответ 200** — массив объектов `DealStageMetric`:

```json
[
  {
    "stage": "qualification",
    "count": 5,
    "total_value": 1350000.0,
    "conversion_rate": 0.25,
    "avg_cycle_duration_days": 2.4
  },
  {
    "stage": "negotiation",
    "count": 8,
    "total_value": 4200000.0,
    "conversion_rate": 0.4,
    "avg_cycle_duration_days": 5.6
  },
  {
    "stage": "proposal",
    "count": 3,
    "total_value": 1750000.0,
    "conversion_rate": 0.15,
    "avg_cycle_duration_days": 7.1
  },
  {
    "stage": "closedWon",
    "count": 2,
    "total_value": 980000.0,
    "conversion_rate": 0.1,
    "avg_cycle_duration_days": 9.3
  },
  {
    "stage": "closedLost",
    "count": 2,
    "total_value": 0.0,
    "conversion_rate": 0.1,
    "avg_cycle_duration_days": 4.8
  }
]
```

Если по фильтрам не найдено сделок, API возвращает полный список стадий с нулевыми показателями.

### PATCH `/deals/{deal_id}/stage`
Переводит сделку на новую стадию воронки.

- **Параметры пути:** `deal_id` — UUID сделки.
- **Тело запроса:** `{ "stage": "negotiation" }`, где `stage` — одно из допустимых значений (`qualification`, `negotiation`, `proposal`, `closedWon`, `closedLost`).
- **Ответ 200:** обновлённый объект `Deal`.
- **Ошибки:** `404 deal_not_found`, если сделка отсутствует; `422`, если передано недопустимое значение стадии.

> **Примечание:** CRM автоматически сопоставляет стадии со статусами сделки (например, `closedWon` → `won`, `closedLost` → `lost`).

### POST `/deals`
Создаёт сделку.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| client_id | UUID | Да | Идентификатор клиента. |
| title | string | Да | Название сделки. |
| description | string | Нет | Свободный комментарий. |
| status | string | Нет | Текущий статус (по умолчанию `draft`). |
| owner_id | UUID | Нет | Ответственный менеджер. Если поле опущено, сделка создаётся без назначенного пользователя и попадёт в фильтр `manager=__NO_MANAGER__`. |
| next_review_at | date (`YYYY-MM-DD`) | Да | Дата следующего обзора сделки. Значение обязательно и не может быть `null`. |

> `next_review_at` хранится как тип `date` без времени. При создании сделки допускается только валидная календарная дата в формате `YYYY-MM-DD`.

**Ответ 201** — объект сделки.

### PATCH `/deals/{deal_id}`
Обновляет отдельные поля сделки.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| title | string | Нет | Новое название сделки. |
| description | string | Нет | Обновлённое описание. |
| status | string | Нет | Новый статус сделки. |
| next_review_at | date (`YYYY-MM-DD`) | Нет | Новая дата следующего обзора. При передаче не может быть `null`; чтобы оставить дату без изменений, не указывайте поле. |

## Расчёты

### GET `/deals/{deal_id}/calculations`
Возвращает расчёты конкретной сделки. Выдача отсортирована по времени обновления (`updated_at` по убыванию) и, при равенстве, по времени создания.

**Параметры запроса**
| Параметр | Тип | Обязательный | Описание |
| --- | --- | --- | --- |
| `status[]` | array<string> | Нет | Фильтр по статусам (`draft`, `ready`, `confirmed`, `archived`). |
| `insurance_company` | string | Нет | Подстрочный поиск по названию страховой компании. |
| `calculation_date_from` | date | Нет | Нижняя граница даты получения расчёта. |
| `calculation_date_to` | date | Нет | Верхняя граница даты получения расчёта. |

**Пример ответа**
```json
[
  {
    "id": "38e47d5c-207d-4b73-8e0f-22c7c873cc26",
    "deal_id": "8b1b9c9f-987a-4c1a-b0f4-a1d88f3d1eb4",
    "owner_id": "6d5c0686-7a7f-4f98-9b3c-1e1fbb44aa01",
    "insurance_company": "Ингосстрах",
    "program_name": "КАСКО Премиум",
    "premium_amount": 150000,
    "coverage_sum": 5000000,
    "calculation_date": "2025-05-18",
    "validity_period": { "start": "2025-05-18", "end": "2026-05-18" },
    "files": ["calc-001.pdf", "calc-002.pdf"],
    "comments": "Вариант для директора",
    "status": "ready",
    "linked_policy_id": null,
    "created_at": "2025-05-18T12:03:00Z",
    "updated_at": "2025-05-19T08:10:00Z"
  }
]
```

### POST `/deals/{deal_id}/calculations`
Создаёт расчёт.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| insurance_company | string | Да | Название страховой компании. |
| program_name | string | Нет | Название программы. |
| premium_amount | number | Нет | Страховая премия (положительное число). |
| coverage_sum | number | Нет | Страховая сумма. |
| calculation_date | date | Да | Дата получения расчёта. |
| validity_period | object | Нет | Диапазон действия: `{ "start": "YYYY-MM-DD", "end": "YYYY-MM-DD" }`. |
| files | array<string> | Нет | Пути или идентификаторы файлов расчёта. |
| comments | string | Нет | Внутренние комментарии. |
| owner_id | UUID | Да | Ответственный пользователь. |

Ответ возвращает объект `Calculation` со статусом `draft`.

### PATCH `/deals/{deal_id}/calculations/{calculation_id}`
Частично обновляет расчёт. Допустимы поля из тела запроса создания; отсутствие поля означает «оставить без изменений». Передача `validity_period: null` очищает диапазон действия. Попытка изменить расчёт в статусе `confirmed` или `archived` завершится ошибкой `400` с кодом `calculation_update_forbidden`.

### POST `/deals/{deal_id}/calculations/{calculation_id}/status`
Меняет статус расчёта. Допустимые переходы: `draft → ready`, `ready → confirmed`, `ready → archived`, `confirmed → archived`. Архивные расчёты изменить нельзя.

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| status | string | Да | Новый статус (`ready`, `confirmed`, `archived`). |
| policy_id | UUID | Нет | Требуется при подтверждении (`status=confirmed`), если расчёт привязывается к существующему полису сделки. |

При переводе в статус `ready` CRM проверяет наличие заполненных полей (`program_name`, `premium_amount`, диапазон действия) и хотя бы одного файла. При подтверждении расчёт привязывается к полису (`crm.policies.calculation_id`) и публикует событие `deal.calculation.status.confirmed`. Попытка привязать полис другой сделки или уже занятый расчётом вернёт ошибку `400` с кодом `policy_not_found`/`policy_already_linked`.

### DELETE `/deals/{deal_id}/calculations/{calculation_id}`
Помечает расчёт удалённым. Связь с полисом очищается автоматически. Повторное обращение к карточке вернёт `404`.

> **События:** при операциях над расчётами CRM публикует `deal.calculation.created`, `deal.calculation.updated`, `deal.calculation.status.<status>` и `deal.calculation.deleted` в обменник `crm.events` (тип `topic`).
## Журнал сделки

Журнал фиксирует заметки менеджеров прямо в карточке сделки. Записи упорядочиваются по времени создания и доступны в REST API.

### GET `/deals/{deal_id}/journal`
Возвращает записи журнала по сделке.

**Параметры запроса**
| Параметр | Тип | Обязательный | Описание |
| --- | --- | --- | --- |
| limit | integer | Нет | Количество записей на страницу (1–200, по умолчанию 50). |
| offset | integer | Нет | Смещение для постраничной навигации. |

**Ответ 200** — объект `DealJournalEntryList`:
```json
{
  "items": [
    {
      "id": "f4c318ad-9305-4fe9-9fc6-4c97a2e5e9a2",
      "deal_id": "c6bd825f-6c7b-49f2-96af-5ffdc2d1d5d2",
      "author_id": "2f6f2803-5f69-4f9a-9cb0-f7e0c6f90958",
      "body": "Созвонились с клиентом, договорились о встрече",
      "created_at": "2024-06-20T09:15:00Z"
    }
  ],
  "total": 1
}
```

### POST `/deals/{deal_id}/journal`
Добавляет запись журнала. Используется для фиксации действий и договорённостей в сделке.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| author_id | UUID | Да | Автор заметки. |
| body | string | Да | Текст заметки (1–5000 символов). |

**Ответ 201** — объект `DealJournalEntry`.

**События**
- `deal.journal.appended` — публикуется при создании записи. Полезная нагрузка включает `deal_id`, `entry_id`, `author_id`, `body`, `created_at`.

## Полисы

### GET `/policies`
Список полисов.

### POST `/policies`
Создаёт полис.

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| client_id | UUID | Да | Связанный клиент. |
| deal_id | UUID | Нет | Сделка, к которой относится полис. |
| policy_number | string | Да | Номер полиса (уникален). |
| status | string | Нет | `draft`/`active`/`closed`, по умолчанию `draft`. |
| premium | number | Нет | Сумма премии. |
| effective_from | date | Нет | Дата начала действия. |
| effective_to | date | Нет | Дата окончания действия. |
| owner_id | UUID | Да | Ответственный пользователь. |

### PATCH `/policies/{policy_id}`
Обновляет `status`, `premium`, `effective_from`, `effective_to`.

### GET `/policies/{policy_id}/documents`
Возвращает список документов, привязанных к полису. Используется для отображения загруженных файлов из сервиса Documents в кар
точке полиса.

**Ответ 200** — массив объектов `PolicyDocument`:

```json
[
  {
    "id": "2f0e5ca3-7e48-4a80-8b0c-0aa5aa4001d4",
    "policy_id": "f5f66f8b-2179-4d7e-b7fa-7c4e6ad0f4a7",
    "document_id": "9a75678c-1515-4e52-8a34-2ad4c4fa20ba",
    "created_at": "2024-06-24T12:15:00Z"
  }
]
```

> Метаданные документа (название, тип, URL) получают напрямую через Documents API по `document_id`. CRM хранит только привязки, ч
то позволяет быстро выводить список и поддерживать уникальность связей.

### POST `/policies/{policy_id}/documents`
Привязывает ранее загруженный документ к полису. Документ должен существовать в сервисе Documents.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| document_id | UUID | Да | Идентификатор документа из сервиса Documents. |

**Ответ 201** — объект `PolicyDocument`.

**Ошибки**
- `404 policy_not_found` — полис не найден или удалён.
- `404 document_not_found` — Documents API не содержит указанный идентификатор.
- `409 document_already_linked` — документ уже привязан к этому полису.

### DELETE `/policies/{policy_id}/documents/{document_id}`
Удаляет связь документа с полисом (без физического удаления файла в Documents). Повторное удаление вернёт `404 document_not_linked`.

> Для получения метаданных документов CRM использует базовый URL из переменной `CRM_DOCUMENTS_BASE_URL`, настроенной на сторону
 Documents Gateway.

## Платежи

CRM ведёт платежи внутри сервиса; подробные сценарии описаны в [`docs/api/payments.md`](payments.md). Основные маршруты:

- `GET /deals/{deal_id}/policies/{policy_id}/payments` — список платежей полиса с агрегатами и фильтром по статусу (`status[]=paid`).
- `POST /deals/{deal_id}/policies/{policy_id}/payments` — создание платежа с плановой датой и суммой.
- `POST /deals/{deal_id}/policies/{policy_id}/payments/{payment_id}/incomes` / `/expenses` — фиксация поступлений и расходов.
- `PATCH`/`DELETE` для платежей и отдельных операций пересчитывают агрегаты (`incomes_total`, `expenses_total`, `net_total`) и публикуют события `deal.payment.*`.

## Задачи первого уровня

### GET `/tasks`
Возвращает задачи первого уровня с фильтрами по исполнителю, статусу, срокам и приоритету.
Полная спецификация, включая схему ответа, перечислена в [`docs/api/tasks.md`](tasks.md#get-tasks).

### GET `/tasks/{task_id}`
Возвращает подробную информацию по конкретной задаче. Структура ответа соответствует `TaskResponseDto`, описанному в [`docs/api/tasks.md`](tasks.md#get-tasks-task_id).

### POST `/tasks`
Создаёт задачу для менеджера.

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| subject | string | Да | Краткое название. |
| description | string | Да | Детальное описание. |
| assignee_id | UUID | Да | Исполнитель задачи. |
| author_id | UUID | Да | Постановщик задачи. |
| due_date | date | Нет | Плановая дата выполнения. |
| priority | string | Нет | `low`/`normal`/`high`, по умолчанию `normal`. |
| context | object | Нет | Контекст задачи, например `{ "deal_id": "uuid" }`. |
| scheduled_for | datetime | Нет | Время отложенного запуска. |
| initial_status | string | Нет | Начальный статус: `pending`, `scheduled`, `in_progress`, `completed` или `cancelled`. |

> Поддерживаемые статусы задач: `pending`, `scheduled`, `in_progress`, `completed`, `cancelled`.
> Правила переходов и дополнительные поля (`payload`, `context`) подробно описаны в [`docs/api/tasks.md`](tasks.md).

### PATCH `/tasks/{task_id}`
Позволяет обновить статус, дедлайн и фактические отметки выполнения.
Допустимые поля: `status`, `dueDate`, `completedAt`, `cancelledReason`.
Правила переходов и ограничения по статусам приведены в разделе [`PATCH /tasks/{task_id}` документа по задачам](tasks.md#patch-tasks-task_id).

### POST `/tasks/{task_id}/schedule`
Переводит задачу в отложенный статус `scheduled` до наступления указанного времени. См. подробности формата запроса в [`docs/api/tasks.md`](tasks.md#post-tasks-task_id-schedule).

### POST `/tasks/{task_id}/complete`
Отмечает задачу выполненной; при необходимости можно передать `completed_at` с пользовательской отметкой времени. Полная спецификация приведена в [`docs/api/tasks.md`](tasks.md#post-tasks-task_id-complete).

## Права доступа

### POST `/api/v1/permissions/sync`
Создаёт задание BullMQ на синхронизацию прав пользователей с внешним сервисом документов. Ответ возвращает только идентификато
ры задания в очереди и записи о синхронизации.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| owner_type | string | Да | Тип сущности (например, `deal`, `policy`). |
| owner_id | UUID | Да | Идентификатор сущности. |
| users | array<object> | Да | Массив `{ "user_id": "uuid", "role": "viewer|editor" }`. |

**Ответ 202** — тело содержит `job_id` и `task_id`.

## Интеграция с платежами
- Платёжные события обрабатываются внутри CRM: при создании или редактировании платежа (включая отдельные позиции доходов/расходов) публикуется `deal.payment.updated` в `crm.events` с агрегированными суммами и детализацией движений.
- Внешних очередей для синхронизации с модулем платежей CRM больше нет; повторные попытки редактирования выполняются на уровне REST API.
- Один полис может иметь несколько платежей; в API возвращается совокупный платёж с вложенными позициями, поэтому потребителям важно использовать `payment_id` в качестве ключа идемпотентности.
