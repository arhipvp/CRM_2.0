# Payments API

## Общая информация
- **Базовый URL:** `https://crm.internal/api/v1`
- **Аутентификация:** пользовательский JWT, выданный Auth API
- **Назначение:** фиксация фактической даты оплаты полиса и комментария продавца внутри CRM. Дополнительные статусы, очереди и экспорт не используются.

## Подтверждение оплаты полиса

### PATCH `/deals/{deal_id}/policies/{policy_id}/payment`
Обновляет запись платежа, связанную с полисом. Запрос доступен пользователям с правом редактировать сделку. Единственная запись создаётся автоматически вместе с полисом; повторные вызовы обновляют существующую запись.

**Заголовки**
- `Authorization: Bearer <JWT>` — токен аутентифицированного пользователя (продавца).
- `X-Tenant-ID` — идентификатор клиента (если включён мультиарендный режим CRM).

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| actual_date | date (`YYYY-MM-DD`) | Да | Фактическая дата поступления оплаты. Должна быть не позже текущего дня и не раньше даты создания полиса. |
| comment | string | Нет | Свободный текст до 500 символов. Сохраняется в журнале изменений сделки. |

`actual_date` обязательно при каждом вызове: очистка даты не поддерживается, вместо этого нужно передать скорректированное значение.

**Ответ 200**
```json
{
  "deal_id": "a6b3f3aa-2cb1-4a7d-8b23-45fe1cc0c4c0",
  "policy_id": "1d5c92c6-2ac6-4b1b-8f02-233ed4d744e0",
  "amount": 125000.00,
  "currency": "RUB",
  "actual_date": "2024-03-12",
  "comment": "Оплата пришла единым платежом",
  "recorded_by_id": "bd6e3c84-7a2c-4c7f-9be3-3f4f38f6d323",
  "updated_at": "2024-03-12T10:42:31Z"
}
```

- `recorded_by_id` устанавливается автоматически по текущему пользователю.
- `amount` и `currency` выводятся из CRM и доступны только для чтения.

**Ошибки**
| Код | Сообщение | Описание |
| --- | --- | --- |
| 400 | `validation_error` | Нарушены правила валидации (`actual_date` в будущем, неверный формат даты, превышена длина комментария). |
| 401 | `invalid_token` | Отсутствует или просрочен JWT. |
| 403 | `forbidden` | Пользователь не имеет прав на редактирование сделки/полиса. |
| 404 | `payment_not_found` | Полис не существует или не содержит платёжной записи. |

## Журналирование
Каждое обновление записывается в аудит CRM с фиксацией `recorded_by_id`, предыдущего и нового значения даты, а также комментария. Отдельных вебхуков, очередей RabbitMQ и SSE-каналов для платежей больше нет — фронтенд получает обновлённые данные через REST и поток `deals`.
