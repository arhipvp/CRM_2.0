# Tasks API

## Общая информация
- **Базовый URL:** `https://tasks.internal/api/v1`
- **Аутентификация:** сервисный JWT, поддержка scope `tasks.manage`
- **Назначение:** управление задачами и напоминаниями; SLA появятся на Этапе 1.1.
- **Ограничение первой поставки:** экспорт данных и WebCal-подписки не поддерживаются.

## Задачи

### GET `/tasks`
Список задач с фильтрами по исполнителю, статусу, дедлайнам и приоритету. Эндпоинт используется как источник для таблицы, канбана и календаря внутри приложения.

**Параметры запроса**
| Имя | Тип | Описание |
| --- | --- | --- |
| assigneeId | UUID | Фильтр по исполнителю (хранится в `payload`). |
| status | array[string] | Коды статусов: `pending`, `scheduled`, `in_progress`, `completed`, `cancelled`. |
| dueBefore | date | Задачи со сроком до указанной даты (не включительно). |
| dueAfter | date | Задачи со сроком после указанной даты (не включительно). |
| priority | array[string] | Приоритет `low`, `normal`, `high`. |
| limit | integer | Количество элементов на странице, по умолчанию `50`. |
| offset | integer | Смещение для пагинации. |

**Ответ 200** — список `TaskResponseDto`, отсортированный по `dueAt`, затем по `createdAt`.

### POST `/tasks`
Создание задачи.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| subject | string | Да | Краткое название. |
| description | string | Да | Детали. |
| assignee_id | UUID | Да | Исполнитель. |
| author_id | UUID | Да | Постановщик. |
| due_date | date | Нет | Срок исполнения. |
| priority | string | Нет | `low`, `normal`, `high`. |
| context | object | Нет | `{ "deal_id": "uuid", "policy_id": "uuid" }`. |

**Ответ 201** — созданная задача со статусом `new`.

**Пример запроса**
```json
{
  "subject": "Подготовить КП",
  "description": "Согласовать условия и отправить клиенту",
  "assignee_id": "uuid",
  "author_id": "uuid",
  "due_date": "2024-03-10",
  "priority": "high",
  "context": {"deal_id": "uuid"}
}
```

**Пример ответа**
```json
{
  "id": "uuid",
  "status": "new",
  "subject": "Подготовить КП",
  "assignee_id": "uuid",
  "author_id": "uuid",
  "due_date": "2024-03-10",
  "priority": "high",
  "context": {"deal_id": "uuid"},
  "created_at": "2024-03-05T11:00:00Z"
}
```

**Ошибки:** `400 validation_error`, `404 context_not_found` (если указаны несуществующие сущности).

### PATCH `/tasks/{task_id}`
Обновление статуса и фактических дат.

**Тело запроса**
| Поле | Тип | Описание |
| --- | --- | --- |
| status | string | Новый статус (`new`, `in_progress`, `waiting`, `done`, `cancelled`). |
| completed_at | datetime | Заполняется при переводе в `done` («Выполнена»). |
| cancelled_reason | string | Причина отмены, обязательна при `status = cancelled`. |
| due_date | date | Перенос срока. |

**Ответ 200** — обновлённая задача.

**Пример запроса**
```json
{
  "status": "in_progress",
  "due_date": "2024-03-12"
}
```

**Пример ответа**
```json
{
  "id": "uuid",
  "status": "in_progress",
  "subject": "Подготовить КП",
  "assignee_id": "uuid",
  "due_date": "2024-03-12",
  "updated_at": "2024-03-06T09:00:00Z"
}
```

**Ошибки:** `404 task_not_found`, `409 invalid_status_transition` (например, при попытке вернуть задачу из `done` в `new`).

### POST `/tasks/{task_id}/reminders`
Создаёт напоминание.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| remind_at | datetime | Да | Время напоминания (UTC). |
| channel | string | Нет | `sse`, `telegram`. По умолчанию `sse` (внутренний канал SSE). Telegram доступен при наличии `telegram_id`. |

**Ответ 201** — напоминание.

**Ошибки:** `400 validation_error`, `404 task_not_found`.

## SLA и автоматические переходы (Этап 1.1)

> ⚠️ Функциональность SLA исключена из первой поставки Tasks API. Контракты ниже
> остаются в роадмапе и будут реализованы на [Этапе 1.1](../delivery-plan.md#2-приоритизация-последующих-этаов).
> До выхода обновления эндпоинты недоступны.

## Экспорт и календарные подписки (Этап 1.1)

> ⚠️ Эндпоинты для экспорта задач и публикации WebCal-фидов отсутствуют в текущем релизе.
> Функциональность включена в дорожную карту [Этапа 1.1](../delivery-plan.md#2-приоритизация-последующих-этаов)
> вместе с расширенным календарём задач.

### POST `/sla/recalculate`
Запускает пересчёт SLA и дедлайнов для задач выбранного сегмента.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| scope | string | Нет | `all`, `overdue_only`, `deal` (требует `deal_id`). |
| deal_id | UUID | Нет | Требуется при `scope = deal`. |

**Ответ 202** — асинхронная задача.

**Ошибки:** `400 validation_error`, `404 deal_not_found`.

## Стандартные ошибки Tasks API

| Код | Сообщение | Описание |
| --- | --- | --- |
| 400 | `validation_error` | Ошибка валидации. |
| 401 | `unauthorized` | Неверный токен. |
| 403 | `forbidden` | Нет прав на операцию. |
| 404 | `not_found` | Ресурс не найден. |
| 409 | `conflict` | Конфликт статусов. |
| 429 | `rate_limited` | Ограничение по напоминаниям. |
| 500 | `internal_error` | Внутренняя ошибка сервиса. |
