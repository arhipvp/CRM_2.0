# CRM Notifications

## Общая информация
- **Базовый URL:** `https://crm.internal/api/v1`
- **Аутентификация:** JWT CRM.
- **Назначение:** доставка внутренних уведомлений и интеграция с Telegram-ботом; публичные события транслируются через SSE-канал `notifications`.
- **Проксирование:** CRM публикует REST-маршруты уведомлений под префиксом `settings.api_prefix` (по умолчанию `/api/v1`). Gateway пробрасывает запросы `/api/v1/...` в CRM.
- **Входящие события:** webhook `POST /api/notifications/events` используется внешними интеграциями для фиксации событий доставки и проксируется без изменения префикса.

## REST API

### `GET /api/v1/templates`
- **Назначение:** получить список шаблонов уведомлений CRM.
- **Параметры запроса:**
  - `channel` — фильтр по каналу (`sse` или `telegram`).
  - `active` — булев фильтр по активности шаблона (по умолчанию возвращаются все статусы).
- **Ответ `200 OK`:** массив объектов шаблонов:
  - `id` — UUID шаблона.
  - `key` — ключ сценария уведомления.
  - `channel` — канал доставки (`sse`/`telegram`).
  - `body` — текст шаблона.
  - `metadata` — произвольный словарь метаданных.
  - `status` — `active` или `inactive`.
  - `locale` — локаль шаблона (строка, например `ru-RU`).
  - `created_at`, `updated_at` — временные метки ISO 8601.
- **Ошибки:**
  - `401/403` — ошибки аутентификации/доступа.
  - `422` — валидационные ошибки параметров.
  - `500` — внутренние ошибки CRM.

### `POST /api/v1/templates`
- **Назначение:** создать шаблон уведомления.
- **Тело запроса:**
  - `key` — обязательный строковый идентификатор сценария.
  - `channel` — обязательный канал (`sse` или `telegram`).
  - `body` — обязательный текст шаблона.
  - `metadata` — необязательный словарь произвольных значений.
  - `status` — опциональный статус (`active`/`inactive`, по умолчанию `active`).
  - `locale` — опциональный код локали (если не передан, используется `settings.notifications_templates_default_locale`).
- **Ответ `201 Created`:** объект шаблона в формате, идентичном `GET /api/v1/templates`.
- **Ошибки:**
  - `401/403` — ошибки аутентификации/доступа.
  - `409 template_conflict` — уже существует шаблон с той же парой `key` + `channel` (и локалью).
  - `422` — ошибки валидации входных данных.
  - `500` — внутренние ошибки CRM.

### `POST /api/v1/notifications`
- **Назначение:** поставить пользовательское уведомление в очередь на доставку.
- **Тело запроса:**
  - `eventKey` — обязательный ключ события (строка до 255 символов).
  - `recipients` — обязательный список получателей. Каждый объект содержит `userId` и, при необходимости, `telegramId`.
  - `payload` — обязательный словарь данных события.
  - `channelOverrides` — опциональный список каналов, которыми следует ограничить доставку.
  - `deduplicationKey` — опциональный ключ дедупликации.
- **Ответ `202 Accepted`:** `{ "notification_id": "<UUID>" }`.
- **Ошибки:**
  - `401/403` — ошибки аутентификации/доступа.
  - `409 duplicate_notification` — уведомление с таким `deduplicationKey` находится в обработке.
  - `422` — ошибки валидации.
  - `500 notification_dispatch_failed` — ошибка публикации в очередь.

### `GET /api/v1/notifications/{notification_id}`
- **Назначение:** получить статус ранее поставленного уведомления.
- **Ответ `200 OK`:** объект статуса:
  - `id` — UUID уведомления.
  - `status` — текущее состояние (`pending`, `queued`, `processed`, `failed`).
  - `attempts` — количество попыток доставки.
  - `channels` — список каналов доставки, для которых есть записи об обработке.
  - `delivered_at` — метка времени доставки (если доступна).
- **Ошибки:**
  - `401/403` — ошибки аутентификации/доступа.
  - `404 notification_not_found` — уведомление не найдено.
  - `422` — неверный формат `notification_id`.
  - `500` — внутренняя ошибка CRM.

## Webhook `POST /api/notifications/events`
- **Назначение:** приём входящих событий доставки из внешних систем (например, Telegram-бота).
- **Тело запроса:**
  - `id` — UUID события (может переиспользоваться для идемпотентности).
  - `source` — идентификатор системы-источника.
  - `type` — тип события (часто повторяет `eventKey`).
  - `time` — отметка времени в формате ISO 8601.
  - `data` — словарь с полезной нагрузкой события (например, статус доставки).
  - `chatId` — опциональный идентификатор чата.
- **Ответ `202 Accepted`:** `{ "status": "ok" }`.
- **Ошибки:**
  - `401/403` — ошибки аутентификации/доступа.
  - `422` — ошибки валидации запроса.
  - `500 notification_event_failed` — ошибка при обработке события CRM.
- Повторная отправка события с тем же `id` допустима и завершится успешным ответом, если событие уже обработано.

## SSE `GET /streams/notifications`
Gateway проксирует поток уведомлений CRM. Канал доступен по маршруту `GET /api/v1/streams/notifications` и требует тех же заголовков, что и другие SSE-каналы (`Accept: text/event-stream`, `Authorization: Bearer <JWT>`). Поведение описано в разделе [docs/api/streams.md](streams.md#канал-notifications).

### Формат событий
Поток соответствует спецификации SSE. Каждое сообщение содержит `retry` с интервалом повторного подключения (по умолчанию 5 секунд) и два основных поля:

- `event` — ключ события уведомления. Для пользовательских уведомлений значение повторяет `eventKey`, переданный при постановке через `POST /api/v1/notifications`. Дополнительно сервис транслирует служебные события `notifications.telegram.sent`, `notifications.telegram.delivery`, `notifications.telegram.error` и `notifications.telegram.skipped`, которые отражают статус интеграции с Telegram (успешная отправка, подтверждение доставки, ошибка или пропуск отключённого канала соответственно).
- `data` — JSON с полями:
  - `eventType` — дублирует `event` для удобства клиента.
  - `payload` — полезная нагрузка события. Для пользовательских уведомлений она содержит исходные данные из `payload`, расширенные техническими полями (`notificationId`, список получателей, переопределения каналов и т. п.). Для Telegram-событий возвращаются параметры доставки (`messageId`, `status`, `reason`, `occurredAt`).

Пример события пользовательского уведомления:

```
event: deal.created
data: {
  "eventType": "deal.created",
  "payload": {
    "dealId": "deal-1",
    "title": "Test Deal",
    "notificationId": "3b0b61c9-6d6c-4f2f-9f46-9fe2e03f46f2",
    "recipients": [
      { "userId": "user-1", "telegramId": "123456" }
    ],
    "channelOverrides": ["telegram"]
  }
}
```

Пример служебного события Telegram:

```
event: notifications.telegram.delivery
data: {
  "eventType": "notifications.telegram.delivery",
  "payload": {
    "notificationId": "3b0b61c9-6d6c-4f2f-9f46-9fe2e03f46f2",
    "messageId": "587324912",
    "status": "delivered",
    "reason": null,
    "occurredAt": "2024-07-28T12:34:56.000Z"
  }
}
```

## RabbitMQ события
Модуль уведомлений использует выделенный exchange `notifications.exchange` (тип `topic`). Его параметры задаются переменными `CRM_NOTIFICATIONS_*`/`NOTIFICATIONS_*` (см. [`env.example`](../env.example)) и задействованы в двух потоках:

- **Публикация задач на доставку.** При постановке уведомления сервис отправляет сообщение с routing key `notifications.dispatch`. Полезная нагрузка включает `notificationId`, `eventKey`, исходный `payload`, список `recipients`, `channelOverrides` и (при наличии) `deduplicationKey`. Эти сообщения предназначены для рабочих процессов доставки (например, коннекторов к внешним каналам).
- **Приём внешних событий.** Сервис подписывается на очередь `notifications.events`, связанную с exchange `notifications.exchange` по шаблону `notifications.*`. Ожидаемая структура сообщения совпадает с `IncomingNotificationDto`: поля `id`, `source`, `type` (обычно повторяет `eventKey`), `time`, `data` и опционально `chatId`. Такие события записываются в журнал уведомлений, транслируются в SSE и инициируют отправку через Telegram.

## Интеграция с Telegram-ботом
CRM публикует события в очередь `telegram.bot.notifications`, которую обслуживает бот (`backend/telegram-bot`). Ответы (успешная доставка, ошибки) возвращаются в CRM по REST-вебхуку и транслируются в SSE. Если переменная окружения `CRM_NOTIFICATIONS_TELEGRAM_ENABLED=false`, модуль уведомлений фиксирует событие `notifications.telegram.skipped` и завершает обработку без попытки отправки в Telegram — статус уведомления остаётся `processed`.

## Ошибки
SSE канал возвращает стандартные ошибки Gateway (см. [docs/api/streams.md](streams.md#управление-соединением)). REST-эндоинты модуля задач/уведомлений CRM используют общий список ошибок CRM (см. [docs/api/crm-deals.md](crm-deals.md#стандартные-ошибки)).
