# Auth API

## Общая информация
- **Базовый URL:** `https://auth.internal/api/v1`
- **Аутентификация сервисов:** mTLS + заголовок `X-Service-Token`
- **Назначение:** управление пользователями, ролями, связью с Telegram, проверка токенов.

## Пользователи и роли

### GET `/users`
Возвращает список пользователей с фильтрами.

**Параметры запроса**
| Имя | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| search | string | Нет | Поиск по имени, email, телефону. |
| role | array[string] | Нет | Фильтр по ролям (`admin`, `agent`, `executor`, `financial_manager`, `manager`). |
| status | string | Нет | `active` или `blocked`. |
| limit | integer | Нет | По умолчанию 50, максимум 200. |
| offset | integer | Нет | Постраничное смещение. |

**Ответ 200**
```json
{
  "items": [
    {
      "id": "uuid",
      "full_name": "Иван Иванов",
      "email": "ivan@example.com",
      "roles": ["agent"],
      "status": "active",
      "telegram_id": "12345678",
      "last_login_at": "2024-02-18T08:10:03Z"
    }
  ],
  "total": 12
}
```

**Ошибки:** `401 unauthorized`, `403 forbidden` (недостаточно прав `admin`).

### POST `/users`
Создаёт пользователя и отправляет приглашение.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| full_name | string | Да | Полное имя пользователя. |
| email | string | Да | Уникальный email. |
| phone | string | Нет | Телефон в международном формате. |
| roles | array[string] | Да | Список ролей. |
| temporary_password | string | Нет | Если не задано, генерируется автоматически. |

**Ответ 201**
```json
{
  "id": "uuid",
  "activation_link": "https://crm.example.com/activate?token=..."
}
```

**Ошибки**
| Код | Сообщение | Условия |
| --- | --- | --- |
| 400 | `validation_error` | Неверный email, пустые роли и т.п. |
| 403 | `forbidden` | Операция доступна только роли `admin`. |
| 409 | `user_exists` | Пользователь с таким email уже существует. |

### PATCH `/users/{user_id}`
Обновляет роли, контактные данные, статус.

**Параметры пути:** `user_id` — UUID.

**Тело запроса** (любые поля опциональны)
| Поле | Тип | Описание |
| --- | --- | --- |
| full_name | string | Новое имя. |
| roles | array[string] | Полный список ролей (замещает прежний). |
| status | string | `active` или `blocked`. |
| telegram_id | string | Снятие привязки — пустая строка. |

**Ответ 200** — обновлённая карточка пользователя.

**Ошибки:** `400 validation_error`, `403 forbidden`, `404 user_not_found`.

## Токены и проверки

### POST `/tokens/issue`
Выдаёт пары access/refresh токенов для Gateway после успешной аутентификации.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| user_id | UUID | Да | Идентификатор пользователя. |
| session_context | object | Нет | Произвольный контекст (IP, user-agent). |
| scopes | array[string] | Нет | Ограничение прав токена (по умолчанию права пользователя). |
| ttl | integer | Нет | Время жизни access-токена (секунды, максимум 3600). |

**Ответ 200**
```json
{
  "access_token": "<jwt>",
  "expires_in": 900,
  "refresh_token": "<jwt>",
  "refresh_expires_in": 604800
}
```

**Ошибки:** `400 validation_error`, `404 user_not_found`.

### POST `/tokens/introspect`
Проверяет валидность access-токена, используется Gateway и сервисами для внутренних вызовов.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| token | string | Да | JWT access-токен. |
| audience | string | Нет | Проверка конкретного `aud`. |

**Ответ 200**
```json
{
  "active": true,
  "user_id": "uuid",
  "roles": ["agent"],
  "expires_at": "2024-02-18T08:25:03Z"
}
```

**Ошибки:** `400 invalid_token` (повреждён), `200` с `{"active": false}` — истёк или отозван.

### POST `/tokens/revoke`
Отзывает refresh- и access-токены пользователя.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| user_id | UUID | Да | Целевой пользователь. |
| refresh_token | string | Нет | Конкретный refresh-токен. Если не указан — все активные сессии. |
| reason | string | Нет | Причина (логируется и отправляется в Audit). |

**Ответ 204** — без тела.

**Ошибки:** `404 session_not_found` (когда указан конкретный `refresh_token`).

## Телеграм и MFA

### POST `/telegram/link`
Связывает Telegram-account c пользователем (инициируется Notifications или ботом).

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| user_id | UUID | Да | Пользователь CRM. |
| telegram_id | string | Да | Идентификатор чата. |
| confirmation_code | string | Да | Код подтверждения, выданный Auth. |

**Ответ 200** — `{ "linked": true }`.

**Ошибки:** `400 invalid_code`, `404 user_not_found`.

### POST `/mfa/challenge`
Запускает выдачу одноразового кода для включённых пользователей.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| user_id | UUID | Да | Пользователь. |
| channel | string | Да | `telegram` или `email`. |

**Ответ 202** — код отправлен.

**Ошибки:** `409 mfa_disabled` (для пользователя не активировано MFA).

## Стандартные ошибки Auth API

| Код | Сообщение | Описание |
| --- | --- | --- |
| 400 | `validation_error` | Нарушение правил валидации. |
| 401 | `unauthorized` | Отсутствует или неверный токен сервиса. |
| 403 | `forbidden` | Нет прав на операцию. |
| 404 | `not_found` | Пользователь/ресурс не найден. |
| 409 | `conflict` | Конфликт данных (например, дублирование email). |
| 429 | `rate_limited` | Превышено число попыток (актуально для MFA). |
| 500 | `internal_error` | Внутренняя ошибка сервиса. |
