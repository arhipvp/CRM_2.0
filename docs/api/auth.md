# Auth API

## Общая информация
- **Базовый URL:** `/api`
- **Аутентификация сервисов:** Bearer JWT, выданный Auth API (`Authorization: Bearer <token>`).
- **Назначение:** регистрация пользователей, управление ролями, выпуск и обновление токенов доступа.

### Структура пользователя
Во всех ответах Auth API пользователь описывается объектом следующего вида:

```json
{
  "id": "uuid",
  "email": "user@example.com",
  "enabled": true,
  "roles": [
    {
      "id": "uuid",
      "name": "ROLE_USER",
      "description": "Базовая роль"
    }
  ],
  "createdAt": "2024-02-18T08:10:03Z",
  "updatedAt": "2024-02-18T08:10:03Z"
}
```

## Реализованные эндпоинты

### POST `/api/auth/register`
Создаёт нового пользователя и назначает ему базовую роль `ROLE_USER`.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| email | string | Да | Email пользователя. Валидируется и нормализуется в нижний регистр. |
| password | string | Да | Пароль (от 8 до 72 символов). |

**Ответ 201** — объект пользователя (см. структуру выше).

**Ошибки**
| Код | Сообщение | Условия |
| --- | --- | --- |
| 400 | `Bad Request` | Нарушены правила валидации email или пароля. |
| 409 | `User already exists` | Пользователь с таким email уже зарегистрирован. |

### POST `/api/auth/token`
Возвращает пару access-/refresh-токенов для переданного email и пароля.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| email | string | Да | Email пользователя. |
| password | string | Да | Пароль пользователя. |

**Ответ 200**
```json
{
  "tokenType": "Bearer",
  "accessToken": "<jwt>",
  "expiresIn": 900,
  "refreshToken": "<uuid>",
  "refreshExpiresIn": 604800
}
```

**Ошибки**
| Код | Сообщение | Условия |
| --- | --- | --- |
| 401 | `Invalid credentials` | Неверный email или пароль. |

### POST `/api/auth/refresh`
Обновляет access-/refresh-токены по действующему refresh-токену.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| refreshToken | string | Да | Текущий refresh-токен. |

**Ответ 200** — структура идентична `/api/auth/token`.

**Ошибки**
| Код | Сообщение | Условия |
| --- | --- | --- |
| 401 | `Refresh token expired` | Токен не найден или срок действия истёк. |
| 401 | `Invalid refresh token` | Формат токена некорректен. |

### GET `/api/auth/me`
Возвращает данные текущего пользователя. Требуется действительный access-токен.

**Ответ 200** — объект пользователя.

**Ошибки:** `401 Unauthorized` — отсутствует или недействительный токен.

### GET `/api/roles`
Возвращает список всех ролей. Требуется действующий access-токен (см. `backend/auth/README.md`).

**Ответ 200**
```json
[
  {
    "id": "uuid",
    "name": "ROLE_USER",
    "description": "Базовая роль"
  }
]
```

**Ошибки**
| Код | Сообщение | Условия |
| --- | --- | --- |
| 401 | `Unauthorized` | Не передан или просрочен access-токен. |

### POST `/api/roles`
Создаёт новую роль. Доступно только пользователям с ролью `ADMIN` (см. интеграционный тест `AuthApiTest`).

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| name | string | Да | Имя роли. Нормализуется к верхнему регистру, макс. 64 символа. |
| description | string | Нет | Описание роли, до 255 символов. |

**Ответ 201**
```json
{
  "id": "uuid",
  "name": "ROLE_MANAGER",
  "description": "Менеджер"
}
```

**Ошибки**
| Код | Сообщение | Условия |
| --- | --- | --- |
| 400 | `Bad Request` | Нарушены ограничения по длине или пустое поле `name`. |
| 401 | `Unauthorized` | Не передан или просрочен access-токен. |
| 403 | `Forbidden` | У пользователя нет роли `ADMIN`. |
| 409 | `Conflict` | Роль с таким именем уже существует. |

### GET `/api/users`
Возвращает список всех пользователей. Доступно только роли `ADMIN`.

**Ответ 200**
```json
[
  {
    "id": "uuid",
    "email": "user@example.com",
    "enabled": true,
    "roles": [
      { "id": "uuid", "name": "ROLE_USER", "description": "Базовая роль" }
    ],
    "createdAt": "2024-02-18T08:10:03Z",
    "updatedAt": "2024-02-18T08:10:03Z"
  }
]
```

**Ошибки:** `403 Forbidden` — если токен не принадлежит администратору.

### POST `/api/users/{id}/roles`
Добавляет пользователю роль. Требуется роль `ADMIN`.

**Параметры пути:** `id` — UUID пользователя.

**Тело запроса**
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| roleName | string | Да | Имя роли (регистр не учитывается, автоматически нормализуется к формату `ROLE_*`). |

**Ответ 200** — обновлённый объект пользователя.

**Ошибки**
| Код | Сообщение | Условия |
| --- | --- | --- |
| 400 | `Bad Request` | Передана пустая строка или длина роли превышает 64 символа. |
| 403 | `Forbidden` | У вызывающего пользователя нет роли `ADMIN`. |
| 404 | `User not found` | Пользователь не найден. |

### DELETE `/api/users/{id}/roles/{role}`
Удаляет у пользователя указанную роль. Требуется роль `ADMIN`.

**Параметры пути**
| Имя | Тип | Описание |
| --- | --- | --- |
| id | UUID | Идентификатор пользователя. |
| role | string | Имя роли (без учёта регистра). |

**Ответ 200** — обновлённый объект пользователя.

**Ошибки**
| Код | Сообщение | Условия |
| --- | --- | --- |
| 400 | `Cannot remove default role` | Пытаемся удалить базовую роль `ROLE_USER`. |
| 403 | `Forbidden` | Нет права `ADMIN`. |
| 404 | `User not found` | Пользователь отсутствует. |
| 404 | `Role not found` | Роль не существует или не назначена пользователю. |

## Запланированные расширения
Следующие эндпоинты находятся в планах и в текущей версии не реализованы:

- `POST /api/auth/tokens/issue`
- `POST /api/auth/tokens/introspect`
- `POST /api/auth/tokens/revoke`
- `POST /api/auth/telegram/link`
- `POST /api/auth/mfa/challenge`

Об их запуске будет объявлено в отдельном роадмапе.

## Стандартные ошибки Auth API

| Код | Сообщение | Описание |
| --- | --- | --- |
| 400 | `Bad Request` | Нарушены правила валидации. |
| 401 | `Unauthorized` | Отсутствует или недействителен токен. |
| 403 | `Forbidden` | Нет прав на операцию. |
| 404 | `Not Found` | Запрашиваемый ресурс не найден. |
| 409 | `Conflict` | Конфликт данных (например, пользователь уже существует). |
| 500 | `Internal Server Error` | Непредвиденная ошибка сервиса. |
