# Экран «Воронка сделок»

- **Описание макета:** визуализация стадий сделки с дашбордом конверсий; скриншоты и схемы расположены в `docs/frontend/mockups/deal-funnel/`.
- **Текстовая спецификация состояний:** [spec.md](mockups/deal-funnel/spec.md).
- **Назначение:** управление стадиями сделки, быстрый переход к карточке клиента, контроль метрик конверсии.

![Список стадий](mockups/deal-funnel/deal-funnel-list.svg)

## Основные блоки
1. **Хедер с фильтрами и метриками (`DealFunnelHeader`):** верхняя панель отображает фильтры по стадии, менеджерам, периоду и поиску, а также переключатель режима (канбан/таблица). Метрики стадий визуализируются карточками с количественными показателями, суммарной выручкой, конверсией и средней длительностью стадии. При загрузке выводятся скелетоны, ошибки запроса подсвечиваются в шапке блока.
2. **Колонки стадий (`DealFunnelBoard`):** канбан из пяти стадий (`qualification`, `negotiation`, `proposal`, `closedWon`, `closedLost`) с сортировкой по `nextReviewAt` и fallback на `updatedAt`. Заголовки показывают количество карточек и индикатор фоновой синхронизации, карточки поддерживают чекбоксы, подсветку `dealUpdates` и drag-and-drop.
3. **Правый сайдбар предпросмотра (`DealPreviewSidebar`):** открывается по клику на карточку и содержит краткую сводку сделки, связанные активности и документы. Сайдбар остаётся видимым как с канбаном, так и с таблицей и закрывается кнопкой «Закрыть» либо программным сбросом предпросмотра.
4. **Панель массовых действий (`DealBulkActions`):** фиксируется снизу при выборе ≥1 сделки и выводит заглушку с сообщением о переносе фактических операций в релиз 1.1. Вместо набора действий показана подсказка «Массовые действия в разработке» и единственная кнопка «Понятно», которая просто очищает выбор и скрывает панель. Реализация API и UX для операций запланирована на обновление `DealBulkActions` в рамках этапа 1.1.
5. **Табличный режим (`DealFunnelTable`):** отображается при `viewMode="table"`, наследует активные фильтры и подсветку. Таблица показывает те же поля, что и канбан, подсвечивает `nextReviewAt` по тональности и использует общие панель массовых действий и сайдбар предпросмотра; до этапа 1.1 в панели остаётся заглушка.

### Особенности отображения

- **Главная страница.** Маршрут `/` отображает аналитическую сводку `HomeOverview`, состоящую из карточек `HomeFiltersPanel` и `HomeStageMetricsPanel`. Карточка фильтров использует `createDefaultDealFilters()` и управляет локальным состоянием выбора (категория, воронка, период, ответственные, сравнение), не затрагивая `uiStore` страницы сделок. Для SSR выполняется префетч `dealStageMetricsQueryOptions`, поэтому гистограмма и таблица метрик появляются без мерцаний сразу после загрузки.
- **Страница `/deals`.** Поведение управляется глобальным `viewMode`, позволяя пользователю переключаться между канбаном и таблицей.

![Предпросмотр сделки](mockups/deal-funnel/deal-funnel-preview.svg)

![Массовые действия](mockups/deal-funnel/deal-funnel-bulk-actions.svg)

## Пользовательские действия
- **Перетаскивание карт:** drag-and-drop с подсветкой целевой колонки и индикацией активной карточки; поддерживается клавиатурный перенос через `KeyboardSensor`. При ошибке оптимистичное обновление откатывается, и показывается уведомление.
- **Фильтры и поиск:** обновление `filters.stage`, `filters.managers`, `filters.period`, `filters.search` без перезагрузки страницы. Кнопки «Сбросить» в дропдауне менеджеров и в пустом состоянии возвращают дефолтные значения и очищают `selectedDealIds`.
- **Выбор стадий:** карточки метрик и кнопка «Фильтровать стадию» в колонке переключают фильтр между конкретной стадией и `all`.
- **Предпросмотр:** клик по карточке открывает сайдбар; кнопка «Закрыть» или вызов `openDealPreview(undefined)` скрывает панель. В таблице карточка также открывает предпросмотр без выхода из списка.
- **Массовые действия:** чекбоксы на карточках синхронизируются между канбаном и таблицей. Пока операции не подключены: панель показывает сообщение «Массовые действия в разработке» и кнопку «Понятно», которая очищает текущий выбор и скрывает панель.
- **Переключение вида:** кнопки в хедере управляют `viewMode`. Если передан `forceViewMode`, доска игнорирует пользовательское значение и остаётся в канбане.

## Состояния элементов
- **Загрузка данных:** хедер и карточки стадий показывают скелетоны. Канбан выводит `BoardSkeleton`, таблица — плейсхолдер с серыми строками. В метриках стадий отображается подпись «Загрузка метрик…».
- **Пустые выборки:** колонка стадий показывает текст «Нет сделок на этой стадии», таблица — блок с сообщением «Сделки не найдены» и кнопкой «Сбросить фильтры».
- **Ошибки запросов:** канбан и таблица выводят красный баннер с кнопкой «Повторить». Ошибки метрик отображаются в хедере рядом с заголовком блока.
- **Ошибки смены стадии:** под хедером канбана появляется жёлтый баннер с кнопками «Повторить» и «Скрыть», одновременно отправляется toast.
- **Успешные обновления:** после подтверждения сервером карточка остаётся в новой колонке, уведомления об ошибках очищаются, связанные запросы (`deals`, `deal`, `dealStageMetrics`) инвалидируются.
- **Подсветка обновлений:** сделки, помеченные в `uiStore.dealUpdates`, подсвечиваются, пока событие не будет сброшено (после получения обновления из CRM или вручную пользователем).

## API и данные
- **Список сделок:** `GET /crm/deals` с необязательными параметрами `stage`, `manager`, `period`, `search`, `sort`. Фронтенд очищает значение `stage=all`, пустые списки менеджеров и пробелы в строке поиска перед отправкой; `sort` по умолчанию равен `next_review_at`.
- **Метрики стадий:** `GET /crm/deals/stage-metrics` принимает те же фильтры, что и список сделок, и возвращает массив объектов `{ stage, count, totalValue, conversionRate, avgCycleDurationDays }`. Значение `conversionRate` нормализовано в диапазоне 0..1, `avgCycleDurationDays` может быть `null`, если в стадии нет сделок. В рабочем окружении данные приходят из Gateway; юнит-тесты используют `frontend/src/mocks/data.ts`, повторяя ту же структуру. После действий в карточке (заметка, документ, задача) инвалидируется `dealStageMetricsQueryKey`, чтобы хедер всегда отображал актуальные значения.
- **Real-time обновления:** поток событий CRM по сделкам подсвечивает обновлённую карточку, сбрасывает флаги `dealUpdates` и одновременно инвалидирует список сделок, карточку и метрики стадий. Если поток недоступен, те же эффекты достигаются повторными REST-запросами после действий пользователя. Благодаря общему `Promise.all` запросы отправляются параллельно, поэтому фильтры и хедер синхронно получают актуальные данные. Во время смены стадии отменяется только точный запрос `['deal', dealId]`, поэтому запущенные подзапросы карточки (задачи, заметки, документы) продолжают выполняться и обновляются целевыми инвалидациями после действий пользователя. Домашняя сводка использует тот же ключ `dealStageMetricsQueryKey`, поэтому после инвалидации график и таблица на `/` автоматически получают обновлённые значения без дополнительных действий.
- **Карточка сделки:** формы заметок, документов и обновления реквизитов карточки вызывают все связанные `invalidateQueries` через обёртку `Promise.all`, чтобы запросы (`deal`, `dealStageMetrics`, `deals`, `dealNotes`, `dealDocuments`, `dealActivity`) уходили одновременно. Это сокращает задержку между сохранением и появлением актуальных данных в сайдбаре и хедере, при этом локальные состояния (формы, композеры) сбрасываются после завершения всех инвалидиаций.
- **Настройки окружения:** переменная `NEXT_PUBLIC_API_BASE_URL` должна указывать на доступный Gateway (`http://gateway:8080/api` в Docker, `http://localhost:${GATEWAY_SERVICE_PORT}/api` вне контейнеров, в продакшене — публичный HTTPS). При недоступности URL `apiClient` выбрасывает `ApiError`, React Query показывает error-состояния, а SSE-подписки отключаются. Таймауты запросов задаются переменными `FRONTEND_PROXY_TIMEOUT` (браузер, middleware) и `FRONTEND_SERVER_TIMEOUT_MS` (SSR).
- **env.example:** актуален и продолжает содержать полный перечень необходимых переменных, дополнительных обновлений не требуется (проверено в феврале 2025).

## Загрузка данных

- **Главная страница (`/`).** Страница префетчит `dealStageMetricsQueryOptions(createDefaultDealFilters())` на сервере, гидрируя кэш React Query для `HomeStageMetricsPanel`. Клиентский запрос выполняется только при изменении фильтров.
- **Страница `/deals`.** `DealFunnelBoard`, `DealFunnelHeader` и `DealFunnelTable` продолжают выполнять запросы на клиенте и показывают скелетоны (`BoardSkeleton`, placeholders таблицы), поэтому первый рендер страницы не блокируется ожиданием REST-ответов.

## Критерии приёмки
- Перетаскивание должно обновлять стадию не позднее 500 мс после drop, при превышении времени показывается предупреждение.
- Фильтры применяются без перезагрузки страницы, отображая индикатор активности и блокируя повторное нажатие.
- Карточки с просроченным дедлайном подсвечиваются цветом согласно гайдлайну и попадают в раздел «Риски».
- Карточки с `nextReviewAt` в прошлом получают бейдж «Просрочено» и закрепляются вверху колонки до обновления даты.
- Если до `nextReviewAt` ≤24 часов, карточка подсвечивается янтарной рамкой и отображается в блоке «На контроле».
- Массовые операции доступны только при выборе ≥1 карточки; панель действий исчезает при снятии всех галочек. В текущем релизе отображается заглушка с уведомлением о переносе операций на этап 1.1; интеграция с API будет добавлена в рамках обновления `DealBulkActions`.
- Сайдбар предпросмотра закрывается кнопкой «Закрыть» или программным сбросом предпросмотра.

## Поведение фильтров и мультивыбора

### Фильтры
- **Стадия.** Переключатель стадий записывает значение в `filters.stage`. Пункт «Все» возвращает список на исходное состояние и не влияет на сохранённые выборки менеджеров.
- **Менеджеры.** Чекбоксы собирают значения в массив `filters.managers`. Список нормализуется (обрезаются пробелы, исключаются дубликаты и пустые строки) независимо от порядка выбора. Сделки без ответственного выводятся с ярлыком «Без владельца» и фильтруются через специальное значение `__NO_MANAGER__`. Кнопка «Сбросить» очищает массив без перезагрузки страницы. Перечень доступных менеджеров формируется на основе отдельного запроса со сброшенным фильтром `managers`, но с сохранением активных ограничений по стадии, периоду и поиску; полученный список объединяется с уже выбранными значениями, поэтому даже при пустой выборке по текущим фильтрам ранее отмеченные менеджеры остаются доступными для мультивыбора. Хедер подписан на обновляемый кэш React Query, поэтому после появления новых сделок (через поток CRM, оптимистичные мутации или повторные REST-запросы) соответствующие менеджеры автоматически появляются в выпадающем списке без изменения фильтров и повторного открытия панели.
- **Период.** Выпадающий список меняет `filters.period` между вариантами `7d`, `30d`, `90d`, `all`. При смене периода происходит повторный запрос данных, индикатор загрузки блокирует повторные клики.
- **Поиск.** Поле поиска обновляет `filters.search` на каждый ввод и может комбинироваться с остальными фильтрами. Поддерживает пустое значение и сбрасывается при нажатии «Сбросить».
- **Сброс фильтров.** Кнопка «Сбросить» приводит `filters` к значению по умолчанию (`stage: all`, `managers: []`, `period: 30d`, `search: ""`) и одновременно очищает текущий множественный выбор.
- **Загрузка страницы.** После перехода на `/deals` React Query выполняет запросы на клиенте, показывая скелетоны в хедере и колонках до получения данных. Значения фильтров берутся из `uiStore` (по умолчанию `stage: all`, `managers: []`, `period: 30d`, `search: ""`).
- **Сортировка.** `filters.sort` по умолчанию = `nextReviewAt` и синхронизирован с параметром API `next_review_at`; значения в прошлом отображаются выше, затем применяется `updatedAt` по возрастанию. API отдаёт `nextReviewAt` в формате `YYYY-MM-DD` и не возвращает `null`.

### Множественный выбор
- **Выбор карточек.** `toggleDealSelection` добавляет/удаляет идентификатор в `selectedDealIds` без дублирования. Команда `selectDeals` объединяет текущий выбор с переданным списком и используется для массового выделения.
- **Главная ↔ страница сделок.** `HomeOverview` не взаимодействует с `uiStore`, поэтому множественный выбор, предпросмотр и подсветки формируются только на `/deals`. Возврат с главной страницы не изменяет текущие выделения и не сбрасывает фильтры воронки.
- **Снятие выделения.** `clearSelection` обнуляет массив выбранных сделок и скрывает панель массовых действий. Метод вызывается как из UI (кнопка «Понятно» в заглушке), так и программно при глобальном сбросе фильтров.
- **Совместимость с фильтрами.** Изменение фильтров не сбрасывает выбор автоматически, чтобы сохранить контекст пользователя, однако команда `clearFilters` всегда очищает `selectedDealIds`, предотвращая применение действий к неактуальной выборке.
- **Подсветка обновлений.** `dealUpdates` сохраняет отметку об обновлении сделки и не затрагивается переключением фильтров/выбора, поэтому подсветка остаётся активной даже при навигации между стадиями.
- **Пересортировка.** Изменение `nextReviewAt` триггерит оптимистичное обновление позиции карточки согласно правилу `nextReviewAt` ↑ → `updatedAt` ↑.

## Требования к доступности
- Перетаскивание дублируется клавиатурными действиями (стрелки + Enter) и контекстным меню.
- Для каждой карточки определён `aria-label` с ключевой информацией (клиент, сумма, стадия).
- Контраст текста и фона соответствует WCAG AA.
- Toast-уведомления фокусируются и озвучиваются screen reader'ом, предоставляя кнопку закрытия.
- Табличный режим поддерживает навигацию клавиатурой и выбор чекбоксами.
