# Экран «Воронка сделок»

- **Описание макета:** визуализация стадий сделки с дашбордом конверсий; скриншоты и схемы расположены в `docs/frontend/mockups/deal-funnel/`.
- **Текстовая спецификация состояний:** [spec.md](mockups/deal-funnel/spec.md).
- **Назначение:** управление стадиями сделки, быстрый переход к карточке клиента, контроль метрик конверсии.

![Список стадий](mockups/deal-funnel/deal-funnel-list.svg)

## Основные блоки
1. **Фильтры и показатели в хедере:** фиксированная верхняя панель с выпадающими фильтрами по воронке, менеджеру, продукту и периоду. Активные фильтры отображаются тегами под панелью, а счётчики «Сделок в работе», «Сумма воронки» и «Конверсия» показывают скелетоны и блокируют кнопку «Применить» до завершения пересчёта.
2. **Колонки стадий:** карточки сделок с ключевыми атрибутами (клиент, сумма, вероятность, дедлайн, ответственный). Для длинных названий включён truncation с тултипом при наведении.
3. **Правый сайдбар предпросмотра:** раскрывается по клику на карточку без выхода из канбана, отображает краткую сводку сделки, активные задачи, историю коммуникаций и CTA «Открыть полную карточку»; в футере показана подсказка `Esc — закрыть предпросмотр`.

![Предпросмотр сделки](mockups/deal-funnel/deal-funnel-preview.svg)

## Пользовательские действия
- **Drag-and-drop:** перетаскивание карточек между стадиями с подсветкой целевой колонки, индикатором «Сохраняем изменения…» и статусом «Отменено» при ошибке, после чего карточка возвращается на исходную позицию.
- **Работа с фильтрами:** быстрый сброс фильтров через кнопку «Сбросить» и сохранение предустановок; активные фильтры подсвечиваются тегами под хедером.
- **Предпросмотр и переход:** клик по карточке открывает сайдбар, двойной клик — сразу детальную карточку в новой вкладке.
- **Массовые операции:** включаются через чекбоксы в заголовках колонок или на карточках; при выборе появляется тёмная панель в нижней части экрана с действиями «Назначить менеджера», «Изменить этап», «Добавить задачу», «Удалить» и счётчиком выбранных сделок.

![Массовые действия](mockups/deal-funnel/deal-funnel-bulk-actions.svg)

## Состояния элементов
- **Загрузка:** скелетон карточек, серый placeholder для счётчиков и спиннер в кнопке «Применить фильтры».
- **Успех:** всплывающее подтверждение с авто-скрытием через 3 с и подсветка обновлённой карточки.
- **Ошибка обновления:** инлайновое сообщение в карточке + toast с кнопкой «Повторить» и ссылкой «Подробнее» для перехода в лог ошибок; индикатор сохранения меняется на статус «Отменено».
- **Валидация фильтров:** обязательные поля подсвечиваются красной рамкой и подсказкой; некорректные диапазоны дат показывают инпут с красным фоном до исправления.
- **Пустая колонка:** выводится иллюстрация-заглушка, текст «Нет сделок на этом этапе» и кнопка «Перенести из другой стадии».

## Критерии приёмки
- Перетаскивание должно обновлять стадию не позднее 500 мс после drop, при превышении времени показывается предупреждение.
- Фильтры применяются без перезагрузки страницы, отображая индикатор активности и блокируя повторное нажатие.
- Карточки с просроченным дедлайном подсвечиваются цветом согласно гайдлайну и попадают в раздел «Риски».
- Массовые операции доступны только при выборе ≥1 карточки; панель действий исчезает при снятии всех галочек.
- Сайдбар предпросмотра закрывается по клавише `Esc` и сохраняет позицию прокрутки канбана.

## Требования к доступности
- Перетаскивание дублируется клавиатурными действиями (стрелки + Enter) и контекстным меню.
- Для каждой карточки определён `aria-label` с ключевой информацией (клиент, сумма, стадия).
- Контраст текста и фона соответствует WCAG AA.
- Toast-уведомления фокусируются и озвучиваются screen reader'ом, предоставляя кнопку закрытия.
