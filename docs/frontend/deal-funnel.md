# Экран «Воронка сделок»

- **Описание макета:** визуализация стадий сделки с дашбордом конверсий; скриншоты и схемы расположены в `docs/frontend/mockups/deal-funnel/`.
- **Текстовая спецификация состояний:** [spec.md](mockups/deal-funnel/spec.md).
- **Назначение:** управление стадиями сделки, быстрый переход к карточке клиента, контроль метрик конверсии.

![Список стадий](mockups/deal-funnel/deal-funnel-list.svg)

## Основные блоки
1. **Хедер с фильтрами и метриками (`DealFunnelHeader`):** верхняя панель отображает фильтры по стадии, менеджерам, периоду и поиску, а также переключатель режима (канбан/таблица). Метрики стадий визуализируются карточками с количественными показателями, суммарной выручкой, конверсией и средней длительностью стадии. При загрузке выводятся скелетоны, ошибки запроса подсвечиваются в шапке блока.
2. **Колонки стадий (`DealFunnelBoard`):** канбан из пяти стадий (`qualification`, `negotiation`, `proposal`, `closedWon`, `closedLost`) с сортировкой по `nextReviewAt` и fallback на `updatedAt`. Заголовки показывают количество карточек и индикатор фоновой синхронизации, карточки поддерживают чекбоксы, подсветку `dealUpdates` и drag-and-drop.
3. **Правый сайдбар предпросмотра (`DealPreviewSidebar`):** открывается по клику на карточку и содержит краткую сводку сделки, связанные активности и документы. Сайдбар остаётся видимым как с канбаном, так и с таблицей и закрывается кнопкой «Закрыть» либо программным сбросом предпросмотра.
4. **Панель массовых действий (`DealBulkActions`):** фиксируется снизу при выборе ≥1 сделки и содержит кнопки «Назначить менеджера», «Изменить этап», «Добавить задачу» и «Удалить». Любое действие сейчас отправляет toast-уведомление и очищает выделение.
5. **Табличный режим (`DealFunnelTable`):** отображается при `viewMode="table"`, наследует активные фильтры и подсветку. Таблица показывает те же поля, что и канбан, подсвечивает `nextReviewAt` по тональности и использует общие панель массовых действий и сайдбар предпросмотра.

### Особенности отображения
- **Главная страница.** Виджет обёрнут в `HomeDealFunnelBoard`, который перед сбросом сохраняет фильтры, выбор, предпросмотр и подсветку из `/deals`, затем очищает их до `createDefaultDealFilters()` и закрывает сайдбар. При размонтировании сохранённые значения возвращаются только если пользователь не менял их внутри виджета; любые новые фильтры, выбранные сделки или предпросмотр с главной автоматически переносятся в основную воронку. Компонент передаёт `forceViewMode="kanban"`, чтобы вид оставался канбаном независимо от переключателя в UI-сторе. Real-time подсветка, пришедшая во время работы виджета, не затирается при возврате на `/deals`.
- **Страница `/deals`.** Поведение управляется глобальным `viewMode`, позволяя пользователю переключаться между канбаном и таблицей.

![Предпросмотр сделки](mockups/deal-funnel/deal-funnel-preview.svg)

![Массовые действия](mockups/deal-funnel/deal-funnel-bulk-actions.svg)

## Пользовательские действия
- **Перетаскивание карт:** drag-and-drop с подсветкой целевой колонки и индикацией активной карточки; поддерживается клавиатурный перенос через `KeyboardSensor`. При ошибке оптимистичное обновление откатывается, и показывается уведомление.
- **Фильтры и поиск:** обновление `filters.stage`, `filters.managers`, `filters.period`, `filters.search` без перезагрузки страницы. Кнопки «Сбросить» в дропдауне менеджеров и в пустом состоянии возвращают дефолтные значения и очищают `selectedDealIds`.
- **Выбор стадий:** карточки метрик и кнопка «Фильтровать стадию» в колонке переключают фильтр между конкретной стадией и `all`.
- **Предпросмотр:** клик по карточке открывает сайдбар; кнопка «Закрыть» или вызов `openDealPreview(undefined)` скрывает панель. В таблице карточка также открывает предпросмотр без выхода из списка.
- **Массовые действия:** чекбоксы на карточках синхронизируются между канбаном и таблицей. При запуске действия отправляется toast с текстом из `buildBulkActionNotificationMessage`, после чего выделение очищается.
- **Переключение вида:** кнопки в хедере управляют `viewMode`. Если передан `forceViewMode`, доска игнорирует пользовательское значение и остаётся в канбане.

## Состояния элементов
- **Загрузка данных:** хедер и карточки стадий показывают скелетоны. Канбан выводит `BoardSkeleton`, таблица — плейсхолдер с серыми строками. В метриках стадий отображается подпись «Загрузка метрик…».
- **Пустые выборки:** колонка стадий показывает текст «Нет сделок на этой стадии», таблица — блок с сообщением «Сделки не найдены» и кнопкой «Сбросить фильтры».
- **Ошибки запросов:** канбан и таблица выводят красный баннер с кнопкой «Повторить». Ошибки метрик отображаются в хедере рядом с заголовком блока.
- **Ошибки смены стадии:** под хедером канбана появляется жёлтый баннер с кнопками «Повторить» и «Скрыть», одновременно отправляется toast.
- **Успешные обновления:** после подтверждения сервером карточка остаётся в новой колонке, уведомления об ошибках очищаются, связанные запросы (`deals`, `deal`, `dealStageMetrics`) инвалидируются.
- **Подсветка обновлений:** сделки, помеченные в `uiStore.dealUpdates`, подсвечиваются, пока событие не будет сброшено (через SSE или пользовательские действия).

## API и данные
- **Список сделок:** `GET /crm/deals` с необязательными параметрами `stage`, `manager`, `period`, `search`, `sort`. Фронтенд очищает значение `stage=all`, пустые списки менеджеров и пробелы в строке поиска перед отправкой; `sort` по умолчанию равен `next_review_at`.
- **Метрики стадий:** `GET /crm/deals/stage-metrics` принимает те же фильтры, что и список сделок, и возвращает массив объектов `{ stage, count, totalValue, conversionRate, avgCycleDurationDays }`. Значение `conversionRate` нормализовано в диапазоне 0..1, `avgCycleDurationDays` может быть `null`, если в стадии нет сделок. В мок-режиме фронтенд вычисляет метрики локально на основе фильтрованных сделок (см. `frontend/src/lib/api/client.ts`). После действий в карточке (заметка, документ, задача) инвалидируется `dealStageMetricsQueryKey`, чтобы хедер всегда отображал актуальные значения.
- **Real-time обновления:** события SSE из CRM и платежей подсвечивают обновлённую сделку, сбрасывают флаги `dealUpdates` и одновременно инвалидируют список сделок, карточку и метрики стадий. Даже если платёжное событие не содержит `deal_id`, фронтенд сбрасывает кэш сделок и агрегированных метрик, чтобы хедер сразу показывал изменение сумм и статусов. Благодаря общему `Promise.all` запросы отправляются параллельно, поэтому фильтры и хедер синхронно получают актуальные данные. Во время смены стадии отменяется только точный запрос `['deal', dealId]`, поэтому запущенные подзапросы карточки (задачи, заметки, документы) продолжают выполняться и обновляются целевыми инвалидациями после действий пользователя. Подсветки, полученные на главной странице, переносятся на `/deals`, если пользователь не успел изменить выделение вручную.
- **Карточка сделки:** формы заметок, документов и обновления реквизитов карточки вызывают все связанные `invalidateQueries` через обёртку `Promise.all`, чтобы запросы (`deal`, `dealStageMetrics`, `deals`, `dealNotes`, `dealDocuments`, `dealActivity`) уходили одновременно. Это сокращает задержку между сохранением и появлением актуальных данных в сайдбаре и хедере, при этом локальные состояния (формы, композеры) сбрасываются после завершения всех инвалидиаций.
- **Настройки окружения:** переменная `NEXT_PUBLIC_API_BASE_URL` должна указывать на Gateway (`http://gateway:8080/api`) или иметь значение `mock` для полностью локального режима без бэкенда. Таймауты запросов задаются через `FRONTEND_PROXY_TIMEOUT`.
- **env.example:** актуален и продолжает содержать полный перечень необходимых переменных, дополнительных обновлений не требуется (проверено в феврале 2025).

## SSR

- **Главная страница (`/`):** при серверном рендеринге префетчит `dealsQueryOptions(createDefaultDealFilters())`, чтобы React Query создавал кэш с тем же ключом, который использует `DealFunnelBoard` после гидратации (включая значение периода `30d`).
- **Страница `/deals`:** также использует `createDefaultDealFilters()` для префетча списка сделок и метрик стадий, поэтому кэш React Query единообразен между SSR и клиентским стором.

## Критерии приёмки
- Перетаскивание должно обновлять стадию не позднее 500 мс после drop, при превышении времени показывается предупреждение.
- Фильтры применяются без перезагрузки страницы, отображая индикатор активности и блокируя повторное нажатие.
- Карточки с просроченным дедлайном подсвечиваются цветом согласно гайдлайну и попадают в раздел «Риски».
- Карточки с `nextReviewAt` в прошлом получают бейдж «Просрочено» и закрепляются вверху колонки до обновления даты.
- Если до `nextReviewAt` ≤24 часов, карточка подсвечивается янтарной рамкой и отображается в блоке «На контроле».
- Массовые операции доступны только при выборе ≥1 карточки; панель действий исчезает при снятии всех галочек. До подключения API по действиям отображаются уведомления с выбранными сделками (toast через `pushNotification`).
- Сайдбар предпросмотра закрывается кнопкой «Закрыть» или программным сбросом предпросмотра.

## Поведение фильтров и мультивыбора

### Фильтры
- **Стадия.** Переключатель стадий записывает значение в `filters.stage`. Пункт «Все» возвращает список на исходное состояние и не влияет на сохранённые выборки менеджеров.
- **Менеджеры.** Чекбоксы собирают значения в массив `filters.managers`. Список нормализуется (обрезаются пробелы, исключаются дубликаты и пустые строки) независимо от порядка выбора. Сделки без ответственного выводятся с ярлыком «Без владельца» и фильтруются через специальное значение `__NO_MANAGER__`. Кнопка «Сбросить» очищает массив без перезагрузки страницы. Перечень доступных менеджеров формируется на основе отдельного запроса со сброшенным фильтром `managers`, но с сохранением активных ограничений по стадии, периоду и поиску; полученный список объединяется с уже выбранными значениями, поэтому даже при пустой выборке по текущим фильтрам ранее отмеченные менеджеры остаются доступными для мультивыбора. Хедер подписан на обновляемый кэш React Query, поэтому после появления новых сделок (через SSE, оптимистичные мутации или подтягивание данных) соответствующие менеджеры автоматически появляются в выпадающем списке без изменения фильтров и повторного открытия панели.
- **Период.** Выпадающий список меняет `filters.period` между вариантами `7d`, `30d`, `90d`, `all`. При смене периода происходит повторный запрос данных, индикатор загрузки блокирует повторные клики.
- **Поиск.** Поле поиска обновляет `filters.search` на каждый ввод и может комбинироваться с остальными фильтрами. Поддерживает пустое значение и сбрасывается при нажатии «Сбросить».
- **Сброс фильтров.** Кнопка «Сбросить» приводит `filters` к значению по умолчанию (`stage: all`, `managers: []`, `period: 30d`, `search: ""`) и одновременно очищает текущий множественный выбор.
- **Загрузка страницы.** SSR на `/deals` префетчит список сделок и метрики стадий с теми же значениями по умолчанию, что использует UI-стор (`stage: all`, `managers: []`, `period: 30d`, `search: ""`), чтобы данные в хедере и колонках совпадали сразу после гидратации.
- **Сортировка.** `filters.sort` по умолчанию = `nextReviewAt` и синхронизирован с параметром API `next_review_at`; значения в прошлом отображаются выше, затем применяется `updatedAt` по возрастанию. API отдаёт `nextReviewAt` в формате `YYYY-MM-DD` и не возвращает `null`.

### Множественный выбор
- **Выбор карточек.** `toggleDealSelection` добавляет/удаляет идентификатор в `selectedDealIds` без дублирования. Команда `selectDeals` объединяет текущий выбор с переданным списком и используется для массового выделения.
- **Главная ↔ страница сделок.** Виджет на главной сбрасывает состояние до дефолта только на время работы. Если пользователь меняет фильтры, выбирает сделки или открывает предпросмотр непосредственно на главной, эти значения переносятся в UI-стор и остаются активными после перехода на `/deals`. Чтобы вернуться к состоянию до визита на главную, достаточно не взаимодействовать с виджетом — при размонтировании восстановятся сохранённые перед входом параметры.
- **Снятие выделения.** `clearSelection` обнуляет массив выбранных сделок и скрывает панель массовых действий. Метод вызывается как из UI (кнопка «Очистить выбор»), так и программно при глобальном сбросе фильтров.
- **Совместимость с фильтрами.** Изменение фильтров не сбрасывает выбор автоматически, чтобы сохранить контекст пользователя, однако команда `clearFilters` всегда очищает `selectedDealIds`, предотвращая применение действий к неактуальной выборке.
- **Подсветка обновлений.** `dealUpdates` сохраняет отметку об обновлении сделки и не затрагивается переключением фильтров/выбора, поэтому подсветка остаётся активной даже при навигации между стадиями.
- **Пересортировка.** Изменение `nextReviewAt` триггерит оптимистичное обновление позиции карточки согласно правилу `nextReviewAt` ↑ → `updatedAt` ↑.

## Требования к доступности
- Перетаскивание дублируется клавиатурными действиями (стрелки + Enter) и контекстным меню.
- Для каждой карточки определён `aria-label` с ключевой информацией (клиент, сумма, стадия).
- Контраст текста и фона соответствует WCAG AA.
- Toast-уведомления фокусируются и озвучиваются screen reader'ом, предоставляя кнопку закрытия.
- Табличный режим поддерживает навигацию клавиатурой и выбор чекбоксами.
