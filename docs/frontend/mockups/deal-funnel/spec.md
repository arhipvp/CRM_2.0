# Спецификация: Воронка сделок

## Обзор
Экран отражает статус сделок по этапам воронки продаж и позволяет управлять перемещением сделок между этапами.

### Хедер фильтров и метрик
- Фиксированная панель с фильтрами по воронке, менеджеру, продукту и периоду.
- Активные значения подсвечиваются тегами под панелью; есть быстрый сброс фильтров.
- Счётчики «Сделок в работе», «Сумма», «Конверсия» показывают скелетоны во время загрузки и обновляются синхронно с результатами поиска.

## Основные состояния
- **Стандартный обзор**: несколько колонок этапов (новые, квалификация, предложение, закрытие). Карточки сделок отображают имя клиента, сумму, вероятность, ответственного. Доступен drag-and-drop между этапами. См. макет ![deal-funnel-list.svg](deal-funnel-list.svg).
- **Выбор фильтров**: активна панель с фильтрами по менеджерам, сегментам, типу продукта; при применении фильтров отображается индикатор активных условий под хедером.
- **Просмотр детали сделки**: при клике карточка раскрывает правую панель с информацией о сделке, задачами и историями коммуникаций. См. макет ![deal-funnel-preview.svg](deal-funnel-preview.svg).
- **Режим массовых действий** _(следующий инкремент, этап 1.1)_: чекбоксы на карточках, планируются действия «Назначить менеджера», «Изменить этап», «Добавить задачу», «Удалить». См. макет ![deal-funnel-bulk-actions.svg](deal-funnel-bulk-actions.svg), который будет актуализирован вместе с реализацией.
- **Пустой этап**: показывается заглушка с подсказкой о добавлении новых сделок и CTA «Создать сделку».
- **Ошибка синхронизации**: отображается баннер с предупреждением и кнопка «Обновить данные»; drag-and-drop временно недоступен.
- **Перетаскивание**: карточка подсвечивается, в целевой колонке появляется индикатор возможного размещения и счётчик стадий пересчитывается после успешного сохранения.

## Сценарии взаимодействия
1. **Открытие детали сделки**
   - Пользователь кликает карточку → открывается правый сайдбар поверх канбана (см. ![deal-funnel-preview.svg](deal-funnel-preview.svg)).
   - В сайдбаре отображаются блоки: «Сводка» (клиент, сумма, стадия, вероятность), «Активные задачи» (дата, исполнитель, статус), «История коммуникаций» (тип, участники, результат).
   - Доступные CTA: «Открыть карточку», «Создать задачу», «Добавить заметку». Под подсказкой зафиксирована комбинация `Esc` для закрытия.
   - При закрытии сайдбара состояние фильтров и позиция прокрутки сохраняются; фокус возвращается на исходную карточку.
2. **Обработка ошибки сохранения при drag-and-drop**
   - При неуспешном ответе API карточка возвращается в исходную колонку с анимацией отката.
   - На карточке появляется красная плашка «Не удалось обновить стадию» и кнопка «Повторить», доступная до успешного сохранения.
   - В хедере выводится toast с описанием ошибки и ссылкой на лог в модуле интеграций.
   - Индикатор «Сохраняем изменения…» сменяется статусом «Отменено».
3. **Работа с пустыми состояниями**
   - Если фильтр возвращает 0 карточек по всей воронке, показывается полноэкранная заглушка с советами по расширению фильтров и CTA «Сбросить фильтры».
   - Для отдельных пустых колонок отображается мини-заглушка с кнопкой «Перенести из другой стадии».
   - В сайдбаре предпросмотра выводится сообщение «Нет данных» с ссылкой на настройки интеграций, если история коммуникаций отсутствует.
4. **Массовые операции** _(следующий инкремент, этап 1.1)_
   - Планируется активация через чекбокс в заголовке колонки или сочетание `Shift + клик`.
   - Планируется отображение тёмной панели с действиями внизу экрана (см. ![deal-funnel-bulk-actions.svg](deal-funnel-bulk-actions.svg)); кнопки будут активироваться в зависимости от выбранных карточек (например, «Изменить этап» отключена, если выбраны сделки из разных воронок).
   - Планируется, что после применения операции показывается подтверждение, панель сворачивается автоматически, а выделение карточек сбрасывается.
   - В текущем релизе показывается лишь заглушка, информирующая о переносе действий на этап 1.1.
- **Стандартный обзор**: несколько колонок этапов (квалификация, переговоры, предложение, закрыто). Карточки отображают имя клиента, сумму, вероятность и ответственного. Drag-and-drop доступен из карточки целиком.
- **Табличный режим**: компактный список сделок с возможностью открывать превью и выбирать несколько строк для операций.
- **Выбор фильтров**: верхний хедер содержит мультивыбор менеджеров, селект периода, строку поиска и счётчики стадий; активные фильтры подсвечиваются бейджами.
- **Просмотр детали сделки**: при клике карточка открывает правую панель с быстрым описанием и ссылками; повторное нажатие скрывает панель.
- **Режим массовых действий** _(следующий инкремент, этап 1.1)_: чекбоксы на карточках и строках таблицы, планируется панель с количеством выбранных карточек и действиями.
- **Пустой этап / список**: показывается заглушка с подсказкой о сбросе фильтров и CTA «Сбросить фильтры».
- **Ошибка синхронизации**: баннер с предупреждением, кнопкой «Обновить данные» и отключённым drag-and-drop до успешного refetch.
- **Ошибка обновления стадии**: жёлтый баннер в области доски с кнопкой «Повторить» и уведомлением.

## Метрики и подсказки
- Сумма, количество и конверсия по каждому этапу в верхней панели с возможностью фильтра по клику.
- Подсказка о drag-and-drop отображается до тех пор, пока пользователь не закроет её (сохраняется в UI store).
- В сайдбаре показывается команда (менеджеры) для быстрого контекста.

## Материалы
В каталоге размещены актуальные svg-макеты и текстовые сценарии, описанные выше. Макет `deal-funnel-bulk-actions.svg` предназначен для этапа 1.1 и отражает будущий вид панели массовых действий. Актуализировано: апрель 2025.
