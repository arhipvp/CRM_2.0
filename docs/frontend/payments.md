# Экран «Платежи»

- **Описание макета:** вкладка сделки с многострочным списком платежей по каждому полису и отдельными контролами для доходов и расходов. Макеты и состояния перечислены в `docs/frontend/mockups/deal-details/spec.md`.
- **Назначение:** пользователи управляют полной историей платежей, в том числе несколькими доходами/расходами, и синхронизируют подтверждения с CRM.

## Пользовательские потоки управления платежами

### Просмотр и фильтрация
1. Пользователь открывает вкладку «Полисы» и разворачивает нужный полис.
2. Список платежей отображает доходы и расходы с фильтрами «Все», «Доходы», «Расходы», «Просроченные», а также поиском по номеру счета или категории.
3. При выборе строки раскрываются детали: источники поступлений, статьи расходов, связанные документы и история изменений (автор, дата, комментарий).
4. Сводная строка под таблицей агрегирует суммы и отображает расчёт комиссии/компенсации в реальном времени.

### Создание платежа
1. Кнопка «Добавить платёж» доступна в шапке списка и в пустом состоянии.
2. Модальное окно содержит поля:
   - «Тип» (доход/расход, обязательный переключатель);
   - «Категория» (справочник, фильтруется по выбранному типу);
   - «Плановая дата» (обязательный датапикер);
   - «Фактическая дата» (опционально, активирует чекбокс «Подтвердить сразу»);
   - «Сумма» (числовое поле с валидаторами на знак в зависимости от типа);
   - «Комментарий» (до 500 символов);
   - Дополнительный блок «Разнесение» для доходов или «Компенсация» для расходов.
3. После сохранения новый платёж появляется в начале списка, система отображает уведомление «Платёж создан» и автоматически пересчитывает агрегаты.

### Редактирование и подтверждение
1. В строке платежа доступны действия «Редактировать» и «Подтвердить».
2. Редактирование открывает то же модальное окно, дополняя его полем «Причина изменения» и перечнем предыдущих версий.
3. Подтверждение требует заполнения фактической даты и отображает превью изменений перед сохранением.
4. После подтверждения статус меняется на «Подтверждён», в блоке деталей фиксируются ФИО и роль автора, а событие отправляется в журнал сделки.

### Удаление и отмена
1. Команда «Удалить» доступна только для неподтверждённых платежей.
2. Перед удалением отображается диалог с резюме платежа и чекбоксом «Отправить уведомление исполнителю».
3. После подтверждения запись удаляется, в списке появляется тост «Платёж удалён», а в журнале фиксируется событие «Платёж отменён».
4. Для подтверждённых платежей доступна мягкая отмена: кнопка «Отменить подтверждение» сбрасывает фактическую дату и возвращает статус «Ожидает подтверждения».

### Управление доходами и расходами
- **Доходы** создают продавцы; при раскрытии отображается секция «Разнесение по счетам» с реквизитами и статусом сверки.
- **Расходы** оформляют исполнители; секция «Компенсация» содержит поля «Кто одобрил» и «Дата компенсации».
- Обе роли видят общую ленту и комментарии, но кнопки недоступных действий скрываются или отключены с подсказкой о нехватке прав.
- Агрегаты автоматически показывают разницу «Валовая прибыль» и подсвечивают отрицательное значение красным бейджем.

## Требования к доступности
- Все управляющие элементы (фильтры, раскрытие, кнопки CRUD) доступны с клавиатуры, для раскрывающихся строк используется `aria-expanded`.
- Датапикеры озвучиваются как «Плановая дата платежа» и «Фактическая дата платежа», с указанием обязательности.
- Доходы и расходы различаются не только цветом, но и текстовыми метками «Доход»/«Расход» и иконками с `aria-label`.
