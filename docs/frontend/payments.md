# Экран «Платежи»

- **Описание макета:** вкладка сделки с многострочным списком платежей по каждому полису и отдельными контролами для доходов и расходов. Макеты и состояния перечислены в `docs/frontend/mockups/deal-details/spec.md`.
- **Назначение:** пользователи управляют полной историей платежей, в том числе несколькими доходами/расходами, и синхронизируют подтверждения с CRM.

## Пользовательские потоки управления платежами

### Просмотр и фильтрация
1. Пользователь открывает вкладку «Полисы» и разворачивает нужный полис.
2. Список платежей отображает доходы и расходы с фильтрами «Все», «Доходы», «Расходы», «Просроченные», а также поиском по номеру счета или категории.
3. При выборе строки раскрываются детали: источники поступлений, статьи расходов, связанные документы и история изменений (автор, дата, комментарий).
4. Сводная строка под таблицей суммирует плановые значения и фактическую разницу по позициям доходов и расходов, отображая рассчитанную комиссию/компенсацию в реальном времени.

### Создание платежа
1. Кнопка «Добавить платёж» доступна в шапке списка и в пустом состоянии.
2. Модальное окно содержит поля для создания записи с плановыми реквизитами и контактами ответственного:
   - «Плановая дата» (обязательный датапикер);
   - «Плановая сумма» (числовое поле без требования знака);
   - «Валюта» (обязательный выпадающий список, используется для всех вложенных операций);
   - «Статус» (значение по умолчанию — «Запланирован»);
   - «Фактическая дата» (опционально, сохраняется как информация для справки);
   - «Комментарий» (до 500 символов);
   - «Ответственный за подтверждение» и «Роль или должность» (обновляют поля `recorded_by` и `recorded_by_role`).
   - Для новых записей блок сводки доходов/расходов отображается в режиме «только чтение» и пуст.
3. После сохранения новый платёж появляется в начале списка, система отображает уведомление «Платёж создан». Агрегаты пересчитываются автоматически после добавления доходов и расходов.

#### Доходы (`incomes`)

##### Создание
1. В раскрытой карточке платежа пользователь нажимает «Добавить поступление».
2. Вложенная форма содержит поля:
   - «Категория» (справочник, совпадает со списком `category` из API);
   - «Плановая дата» (обязательный датапикер, сохраняется в `planned_posted_at`);
   - «Плановая сумма» (числовое поле с абсолютным значением, валюта наследуется от платежа);
   - «Причина изменения» (выпадающий список, обязательный при редактировании позиции);
   - «Фактическая сумма» и «Фактическая дата» отображаются сразу, но заблокированы до подтверждения позиции;
   - «Комментарий» (до 300 символов, сохраняется в `note`);
   - «Новые вложения» (множественная загрузка файлов, закрепляются за позицией и видны в истории).
3. После сохранения строка поступления добавляется в список операций, уведомление «Поступление добавлено» подтверждает действие, а агрегаты обновляются по всем позициям доходов.

##### Редактирование
1. Иконка карандаша в строке операции открывает ту же форму с предзаполненными значениями.
2. Доступно изменение категории, плановых значений, причины изменения и комментария; фактические поля остаются заблокированными до подтверждения.
3. Отдельный блок отображает ранее загруженные вложения и историю корректировок.
4. После сохранения система показывает уведомление «Поступление обновлено», пересчитывая агрегаты по доходам.

##### Удаление
1. Иконка корзины запускает диалог подтверждения с указанием категории, даты и суммы.
2. После подтверждения отображается уведомление «Поступление удалено», а агрегаты перерасчитываются без удалённой позиции.

#### Расходы (`expenses`)

##### Создание
1. В карточке платежа доступна кнопка «Добавить расход» с тем же паттерном вложенной формы.
2. Поля формы синхронизированы с API `/expenses` и повторяют структуру поступлений: плановая дата и сумма, выпадающий список причины изменения, блок фактических полей (неактивен до подтверждения), комментарий и загрузка файлов.
3. После сохранения появляется уведомление «Расход добавлен», а агрегаты и сводная строка пересчитываются по всем расходным позициям.

##### Редактирование
1. В строке расхода иконка карандаша открывает вложенную форму с текущими значениями и списком уже загруженных вложений.
2. Пользователь может изменить категорию, плановые значения, причину изменения и комментарий; валюта фиксирована платежом.
3. После сохранения выводится уведомление «Расход обновлён», пересчитывающее агрегаты по расходам.

##### Удаление
1. Иконка корзины запрашивает подтверждение удаления расхода.
2. После подтверждения система показывает уведомление «Расход удалён», сводная строка и агрегаты пересчитываются без удалённой позиции.

### Редактирование и подтверждение
1. В строке платежа доступны действия «Редактировать» и «Подтвердить».
2. Редактирование открывает то же модальное окно, дополняя его полем «Причина изменения» (минимум 10 символов), блоком истории версий и сводкой текущих доходов/расходов. Пока причина пустая или короче лимита, кнопка сохранения не активна.
3. Подтверждение запускает отдельное модальное окно. Пользователь указывает фактическую сумму, фактическую дату, ответственного, роль и при необходимости комментарий. Предпросмотр показывает разницу с плановыми показателями и будущий статус.
4. После подтверждения статус меняется на «Подтверждён», в карточке платежа отображаются ФИО и роль автора подтверждения, а в истории появляется запись с причиной.

### Удаление и отмена
1. Команда «Удалить» доступна только для неподтверждённых платежей.
2. Перед удалением отображается диалог с подтверждением действия. После согласия запись удаляется и отображается тост «Платёж удалён».
3. Для подтверждённых платежей доступна мягкая отмена: кнопка «Отменить подтверждение» сбрасывает фактическую дату/сумму, возвращает статус «Ожидается» и добавляет запись в историю изменений.

### Управление доходами и расходами
- **Доходы** создают продавцы; при раскрытии отображается секция «Разнесение по счетам» с деталями по каждому поступлению и статусом сверки.
- **Расходы** оформляют исполнители; секция «Компенсация» отражает каждую позицию удержаний с указанием одобрившего и даты.
- Обе роли видят общую ленту и комментарии, но кнопки недоступных действий скрываются или отключены с подсказкой о нехватке прав.
- Агрегаты рассчитывают валовую прибыль как `∑ доходов − ∑ расходов`, подсвечивая отрицательное значение красным бейджем и обновляя сводную строку при любых изменениях позиций.

### CRUD по позициям доходов и расходов
1. **Создание позиции:**
   - Доступно из раскрытой карточки платежа через кнопки «Добавить доход»/«Добавить расход».
   - Форма содержит поля «Категория», «Плановая дата», «Плановая сумма», «Причина изменения», «Комментарий» и блок добавления файлов; фактические поля отображаются в режиме «только чтение» до подтверждения.
   - После сохранения позиция появляется в соответствующем вложенном списке, а заголовок платежа обновляет агрегаты.
2. **Редактирование позиции:**
   - Запускается из меню строки позиции, добавляет обязательное поле «Причина изменения», отображает историю корректировок и список ранее загруженных вложений.
   - При изменении плановых значений автоматически пересчитываются агрегаты платежа и сводка по полису.
3. **Подтверждение позиции:**
   - Выполняется отдельным действием «Подтвердить позицию», доступным пользователю, создавшему платёж, или администратору.
   - Требует заполнения фактической суммы и даты (валидация запрещает отрицательные значения и даты раньше плановой), выбора причины и, при необходимости, загрузки документов.
   - Перед подтверждением отображается блок «Влияние на агрегаты» с пересчётом план/факт для доходов, расходов и Netto.
4. **Удаление позиции:**
   - Доступно до подтверждения, сопровождается диалогом с указанием влияния на итоговые суммы.
   - Если удаление выполнено после подтверждения платежа, система фиксирует событие «Позиция отменена» и пересчитывает статусы платежа.

## Требования к доступности
- Все управляющие элементы (фильтры, раскрытие, кнопки CRUD) доступны с клавиатуры, для раскрывающихся строк используется `aria-expanded`.
- Датапикеры озвучиваются как «Плановая дата платежа» и «Фактическая дата платежа», с указанием обязательности.
- Доходы и расходы различаются не только цветом, но и текстовыми метками «Доход»/«Расход» и иконками с `aria-label`.
