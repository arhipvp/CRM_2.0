# Экран «Платежи»

- **Описание макета:** вкладка сделки с многострочным списком платежей по каждому полису и отдельными контролами для доходов и расходов. Макеты и состояния перечислены в `docs/frontend/mockups/deal-details/spec.md`.
- **Назначение:** пользователи управляют полной историей платежей, в том числе несколькими доходами/расходами, и синхронизируют подтверждения с CRM.

## Пользовательские потоки управления платежами

### Просмотр и фильтрация
1. Пользователь открывает вкладку «Полисы» и разворачивает нужный полис.
2. Список платежей отображает доходы и расходы с фильтрами «Все», «Доходы», «Расходы», «Просроченные», а также поиском по номеру счета или категории.
3. При выборе строки раскрываются детали: источники поступлений, статьи расходов, связанные документы и история изменений (автор, дата, комментарий).
4. Сводная строка под таблицей агрегирует суммы и отображает расчёт комиссии/компенсации в реальном времени.

### Создание платежа
1. Кнопка «Добавить платёж» доступна в шапке списка и в пустом состоянии.
2. Модальное окно описывает нейтральный платёж и содержит поля:
   - «Номер» (уникальный идентификатор в рамках полиса, автогенерация с правом ручного редактирования);
   - «Плановая дата» (обязательный датапикер);
   - «Плановая сумма» (числовое поле без знака направления, валидируется на положительное значение);
   - «Статус» (выпадающий список: «Ожидает подтверждения», «Подтверждён», «Отменён»);
   - «Комментарий» (до 500 символов, используется для общих пометок по платежу);
   - Опционально — «Фактическая дата» и «Фактическая сумма» при немедленном подтверждении.
3. После сохранения новый платёж появляется в начале списка, система отображает уведомление «Платёж создан» и автоматически пересчитывает агрегаты платежа, однако вложенные разделы доходов/расходов остаются пустыми до создания позиций.

### Редактирование и подтверждение
1. В строке платежа доступны действия «Редактировать» и «Подтвердить».
2. Редактирование открывает то же модальное окно, дополняя его полем «Причина изменения», перечнем предыдущих версий и блоком с краткой сводкой доходных/расходных позиций (только для чтения).
3. Подтверждение требует заполнения фактической даты и фактической суммы; перед сохранением отображается превью изменений для платежа и затронутых позиций.
4. После подтверждения статус меняется на «Подтверждён», в блоке деталей фиксируются ФИО и роль автора, а событие отправляется в журнал сделки.

### Удаление и отмена
1. Команда «Удалить» доступна только для неподтверждённых платежей.
2. Перед удалением отображается диалог с резюме платежа и чекбоксом «Отправить уведомление исполнителю».
3. После подтверждения запись удаляется, в списке появляется тост «Платёж удалён», а в журнале фиксируется событие «Платёж отменён».
4. Для подтверждённых платежей доступна мягкая отмена: кнопка «Отменить подтверждение» сбрасывает фактическую дату, фактическую сумму и возвращает статус «Ожидает подтверждения».

### Управление доходами и расходами
- **Доходы** создают продавцы; при раскрытии отображается секция «Разнесение по счетам» с реквизитами и статусом сверки.
- **Расходы** оформляют исполнители; секция «Компенсация» содержит поля «Кто одобрил» и «Дата компенсации».
- Обе роли видят общую ленту и комментарии, но кнопки недоступных действий скрываются или отключены с подсказкой о нехватке прав.
- Агрегаты автоматически показывают разницу «Валовая прибыль» и подсвечивают отрицательное значение красным бейджем.

### CRUD по позициям доходов и расходов
1. **Создание позиции:**
   - Доступно из раскрытой карточки платежа через кнопки «Добавить доход»/«Добавить расход».
   - Форма содержит поля «Категория», «Плановая сумма», «Фактическая сумма» (доступно после подтверждения), «Комментарий» и, при необходимости, файлы подтверждающих документов.
   - После сохранения позиция появляется в соответствующем вложенном списке, а заголовок платежа обновляет агрегаты.
2. **Редактирование позиции:**
   - Запускается из меню строки позиции, добавляет обязательное поле «Причина изменения» и отображает историю корректировок.
   - При изменении суммы автоматически пересчитываются агрегаты платежа и сводка по полису.
3. **Подтверждение позиции:**
   - Выполняется отдельным действием «Подтвердить позицию», доступным пользователю, создавшему платёж, или администратору.
   - Требует заполнения фактической суммы, указания даты и, при необходимости, загрузки документов.
4. **Удаление позиции:**
   - Доступно до подтверждения, сопровождается диалогом с указанием влияния на итоговые суммы.
   - Если удаление выполнено после подтверждения платежа, система фиксирует событие «Позиция отменена» и пересчитывает статусы платежа.

## Требования к доступности
- Все управляющие элементы (фильтры, раскрытие, кнопки CRUD) доступны с клавиатуры, для раскрывающихся строк используется `aria-expanded`.
- Датапикеры озвучиваются как «Плановая дата платежа» и «Фактическая дата платежа», с указанием обязательности.
- Доходы и расходы различаются не только цветом, но и текстовыми метками «Доход»/«Расход» и иконками с `aria-label`.
