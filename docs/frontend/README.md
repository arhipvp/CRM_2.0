# UX-документация фронтенда

Этот раздел содержит описания ключевых экранов и пользовательских сценариев CRM 2.0. Используйте материалы для согласованной реализации UX между разработчиками, аналитиками и дизайнерами.

> Актуализировано: апрель 2025. Для «Воронки сделок» доступны свежие макеты в формате SVG и сценарии, остальные экраны остаются в формате текстовых спецификаций до выхода визуальных макетов (команда UX).

## Структура
- [Воронка сделок](deal-funnel.md)
- [Детали сделки](deal-details.md)
  - [Вкладка «Полисы»](deal-details.md#полисы)
  - [Вкладка «Расчёты»](deal-details.md#расчёты)
  - [Вкладка «Задачи»](deal-details.md#задачи)
  - [Вкладка «Документы»](deal-details.md#документы)
  - [Вкладка «Финансы»](deal-details.md#финансы)
  - [Список платежей полиса](deal-details.md#список-платежей-полиса)
  - [Раскрытие доходов и расходов](deal-details.md#раскрытие-доходов-и-расходов)
  - [Действия с платежами](deal-details.md#действия-с-платежами)
- [Карточка расчёта страховой программы](calculations.md)
- [Карточка клиента и полиса](client-policy-card.md)
- [Управление платежами](payments.md)
- [Задачи и планирование](tasks.md)
- [Уведомления и журнал событий](notifications.md)
- [Пользовательские сценарии по ролям](user-scenarios.md)
- [Changelog изменений фронтенда](changelog.md)

Макеты и спецификации интерфейсов поддерживаются прямо в репозитории. Для каждого экрана создаётся подпапка в `docs/frontend/mockups`, содержащая Markdown-спецификацию и, при наличии, статичные векторные макеты (SVG) или другие без потерь форматы (например, WebP). Пока визуальные макеты находятся в разработке, поэтому в каталоге доступны только текстовые описания состояний. При добавлении нового состояния обновляйте соответствующие документы и прикладывайте актуальные артефакты в каталог макетов. Для блоков расчётов используйте [описание карточки расчёта](calculations.md) как базовый источник полей и сценариев.

## Требования к Gateway и обработка ошибок

- `NEXT_PUBLIC_API_BASE_URL` должен указывать на реальный Gateway и включать версионный префикс маршрутов: в Docker-сети — `http://gateway:8080/api/v1`, при локальной разработке вне контейнеров — `http://localhost:${GATEWAY_SERVICE_PORT}/api/v1`, в продакшене — публичный HTTPS-адрес с тем же префиксом. Пустой URL или заглушка приводят к `ApiError`, страницы показывают error-состояния, а данные не загружаются.
- SSR-страницы перехватывают `ApiError`, чтобы не падать целиком: ошибки логируются и пропускаются, как на главной (`deal-stage-metrics`). Для критичных запросов (например, карточка сделки) 404 приводит к `notFound()`, а остальные ошибки пробрасываются в Next.js error boundary.
- Клиентские мутации и формы используют текст `ApiError.message` для inline-ошибок и toast-уведомлений. При откате optimistic updates данные восстанавливаются из снепшотов Zustand/React Query.
- SSE-потоки подключаются через `SSEBridge` и `useEventStream`: при сетевой ошибке поток закрывается, ставится экспоненциальное переподключение (до 30 секунд), после успешного `onopen` задержка обнуляется. Если Gateway недоступен длительное время, подписка не возобновится до перезагрузки страницы или восстановления сети.
- Для ревью флоу используйте сценарии из `docs/local-setup.md`/`frontend/README.md`: сначала поднимите профиль `gateway`, затем фронтенд. В `.env.local` допускается только рабочий URL — mock-режим отключён.

## Макеты и визуальные артефакты
- **Где искать**: все материалы по макетам лежат в `docs/frontend/mockups`. В корне каталога есть инструкции по структуре файлов.
- **Новые материалы**: правый сайдбар сделки → `docs/frontend/mockups/deal-details/` (SVG-макеты и `spec.md`), включая вкладку «Полисы», состояния пустого списка и описание раскрывающихся списков платежей.
- **Формат хранения**: допускаются статичные изображения и Markdown-файлы с комментариями. Для каждого ключевого состояния рекомендуется краткое описание в профильном документе из раздела ниже.
- **Процесс обновления**:
 1. Добавьте новые макеты/описания (предпочтительно векторные) в соответствующую подпапку `docs/frontend/mockups/<экран>/`.
  2. Обновите тематический документ (например, `deal-funnel.md`) и перечислите изменения интерфейса.
  3. Зафиксируйте ссылку на новые артефакты в changelog команды или в задаче трекера.

## Текстовые спецификации
- **Назначение**: фиксируют сложные состояния, которые невозможно выразить одним скриншотом (например, правила валидации, таблицы).
- **Где хранить**: рядом со скриншотами (`docs/frontend/mockups/<экран>/spec.md`) или в тематическом документе.
- **Поддержка в актуальном состоянии**: при изменениях интерфейса обновляйте соответствующий раздел, добавляйте примеры и указывайте дату последнего обновления; для вкладки «Полисы» обязательно документируйте состояние пустого списка и реакции на смену статуса.

## Дизайн-токены
- **Исходники**: минимальные значения цветов, типографики и отступов находятся в `frontend/src/design-tokens/colors.json`, `typography.json`, `spacing.json`.
- **Экспорт в код**: общий интерфейс экспорта описан в `frontend/src/design-tokens/index.ts`.
- **Как обновлять**: следуйте инструкции в [`frontend/src/design-tokens/README.md`](../../frontend/src/design-tokens/README.md), чтобы синхронизировать токены с актуальным дизайном и не забыть про автоматические проверки.
