# Правый сайдбар сделки

Документ описывает структуру правого сайдбара на экране деталей сделки. Он служит для выравнивания ожиданий между дизайном и реализацией и помогает фронтенду синхронизировать состояния интерфейса с данными CRM и внешними виджетами.

## Общая структура
- **Хедер карточки:** аватар клиента, название сделки, текущая стадия и быстрые теги (уровень риска, приоритет, категория продукта).
- **Навигация по вкладкам:** горизонтальный таб-контрол, позволяющий переключаться между «Обзор», «Формы», «Журнал» и «Действия».
- **Контентная область:** динамически меняется в зависимости от выбранной вкладки; включает состояния загрузки и пустых данных.
- **Нижняя панель действий:** общие кнопки «Сохранить», «Отменить», контекстная кнопка «Создать документ» и выпадающий список дополнительных действий.

## Вкладки и их содержимое
### Обзор
- Краткая информация о сумме, вероятности закрытия, дате следующего шага и обязательной дате «Следующий просмотр» с подсветкой просрочки.
- Краткая информация о сумме, вероятности закрытия, `nextReviewAt` (дата следующего обзора сделки).
- Виджет «Последние взаимодействия» с возможностью разворачивания.
- Информационные бейджи об активных предупреждениях (например, просроченный платёж).
- Макеты: [Просмотр сделки](mockups/deal-details/deal-details-view.svg) · [Figma](https://www.figma.com/file/CRM-2-0/Deal-Details?type=design&node-id=101-1)

### Формы
- Разделён на группы: «Основные данные», «Финансовые параметры», «Дополнительные виджеты».
- Поле `nextReviewAt` находится в «Основных данных», вводится только как дата без времени и не содержит быстрых пресетов.
- Каждая группа разворачивается аккордеоном; обязательные поля помечены индикатором `*`.
- Inline-валидация подсвечивает поля и выводит сообщения под инпутом.
- Поле «Следующий просмотр» вводится в формате даты (`YYYY-MM-DD`), обязательное для сохранения и блокирует кнопку «Обновить» при пустом значении; UI не позволяет сохранить карточку без этого значения.
- Макеты: [Редактирование сделки](mockups/deal-details/deal-details-edit.svg) · [Figma](https://www.figma.com/file/CRM-2-0/Deal-Details?type=design&node-id=102-3)

### Журнал
- Лента активности (создание задач, комментарии, автоматические уведомления).
- Возможность фильтрации по типам событий и полнотекстовый поиск.
- Состояние пустой ленты отображает подсказки и CTA «Добавить событие».
- Макеты: [Пустые вкладки](mockups/deal-details/deal-details-empty-tabs.svg) · [Figma](https://www.figma.com/file/CRM-2-0/Deal-Details?type=design&node-id=103-5)

### Действия
- Быстрые кнопки: «Создать задачу», «Отправить письмо», «Запросить документы».
- Выпадающее меню с дополнительными интеграциями (например, подключение аналитики).
- Валидационные сообщения отображаются в верхней части панели при ошибках внешних сервисов.
- Макеты: [Ошибки валидации](mockups/deal-details/deal-details-errors.svg) · [Figma](https://www.figma.com/file/CRM-2-0/Deal-Details?type=design&node-id=104-7)

## Состояния и правила отображения
| Состояние | Описание | Особенности |
| --- | --- | --- |
| Загрузка | Отображается скелетон карточки и табов, пока данные сделки не получены. | Минимальное время отображения 600 мс для визуальной стабильности. |
| Просмотр | Используется по умолчанию для пользователей с правами чтения. | Заблокированы элементы редактирования; отображается кнопка «Запросить изменение». Просроченная дата «Следующий просмотр» подсвечивается акцентным цветом. |
| Редактирование | Доступно пользователям с правами «Редактирование сделок». | Несохранённые изменения подсвечиваются индикатором в табе «Формы». |
| Пустые вкладки | Активируется, если у сделки нет записей в журнале или доступных действий. | Показываются CTA и ссылки на обучение. |
| Ошибки интеграций | Когда внешние сервисы недоступны. | Отображается баннер в верхней части с повторной попыткой. |

## Поле `nextReviewAt`
- Отображается в блоке с ключевыми атрибутами сделки и в карточке «Следующий обзор» на вкладке «Обзор».
- Значения в прошлом подсвечиваются насыщенным красным бейджем «Просрочено» и остаются вверху списков задач и карточек, пока дата не обновлена.
- Если до обзора осталось ≤24 часов, отображается янтарный бейдж «Скоро» и активируется напоминание в блоке действий.
- Значение обязательно для каждой сделки; UI предотвращает сохранение пустого поля и всегда хранит дату формата `YYYY-MM-DD`.
- Редактирование поля разрешено только в режиме «Редактирование»; при сохранении отправляется PATCH-запрос к `/deals/{id}` с полем `nextReviewAt` (camelCase) и автоматическим обновлением воронки.

## Интеграции и фичи
- **Виджет рекомендаций ИИ:** включается через feature-flag `deal-sidebar-widgets`. При отключённом флаге блок «Дополнительные виджеты» скрывается.
- **Статистика платежей:** использует SSE-канал `NEXT_PUBLIC_PAYMENTS_SSE_URL` и обновляет виджет в табе «Обзор».
- **Автоматические действия:** интеграция с сервисом задач; при отключённом RabbitMQ отображается баннер с подсказкой повторить позднее.

## Связанные артефакты
- [Каталог макетов](mockups/deal-details/) содержит векторные макеты состояний (SVG) и текстовую спецификацию (`spec.md`).
- Смежные сценарии описаны в [`docs/frontend/user-scenarios.md`](user-scenarios.md) → «Агент поддержки / Работа с обращениями».

> Обновлено: 2024-10-14. Ответственные: UX-команда сделок.
