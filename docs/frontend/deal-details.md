# Правый сайдбар сделки

Документ описывает структуру правого сайдбара на экране деталей сделки. Он служит для выравнивания ожиданий между дизайном и реализацией и помогает фронтенду синхронизировать состояния интерфейса с данными CRM и внешними виджетами.

## Общая структура
- **Хедер карточки:** аватар клиента, название сделки, текущая стадия и быстрые теги (уровень риска, приоритет, категория продукта).
- **Навигация по вкладкам:** горизонтальный таб-контрол, позволяющий переключаться между «Обзор», «Формы», «Полисы», «Журнал», «Действия», «Задачи», «Документы» и «Финансы».
- **Контентная область:** динамически меняется в зависимости от выбранной вкладки; включает состояния загрузки и пустых данных.
- **Нижняя панель действий:** общие кнопки «Сохранить», «Отменить», контекстная кнопка «Создать документ» и выпадающий список дополнительных действий.

## Вкладки и их содержимое
### Обзор
- Краткая информация о сумме, вероятности закрытия, дате следующего шага и обязательной дате «Следующий просмотр» с подсветкой просрочки.
- Краткая информация о сумме, вероятности закрытия, `nextReviewAt` (дата следующего обзора сделки).
- Виджет «Последние взаимодействия» с возможностью разворачивания.
- Карточка «Текущий полис» отображает ключевой статус, сроки действия и ссылку на вкладку «Полисы»; при смене активного полиса подсвечивает обновление.
- Информационные бейджи об активных предупреждениях (например, просроченный платёж).
- Блок «Подтверждённые оплаты» выводит фактическую дату поступления (`paidAtActual`) и подпись с ФИО сотрудника, подтвердившего платёж в CRM; дата отображается в формате `DD.MM.YYYY` с учётом часового пояса CRM. Обновление блока происходит вместе с карточкой сделки — достаточно перезагрузки данных сделки или поступления события от CRM, отдельные SSE по платежам не используются.
- Макеты: [Просмотр сделки](mockups/deal-details/deal-details-view.svg) · [Figma](https://www.figma.com/file/CRM-2-0/Deal-Details?type=design&node-id=101-1)

### Формы
- Разделён на группы: «Основные данные», «Финансовые параметры», «Дополнительные виджеты».
- Поле `nextReviewAt` находится в «Основных данных», вводится только как дата без времени и не содержит быстрых пресетов.
- Каждая группа разворачивается аккордеоном; обязательные поля помечены индикатором `*`.
- Inline-валидация подсвечивает поля и выводит сообщения под инпутом.
- Поле «Следующий просмотр» вводится в формате даты (`YYYY-MM-DD`), обязательное для сохранения и блокирует кнопку «Обновить» при пустом значении; UI не позволяет сохранить карточку без этого значения.
- Макеты: [Редактирование сделки](mockups/deal-details/deal-details-edit.svg) · [Figma](https://www.figma.com/file/CRM-2-0/Deal-Details?type=design&node-id=102-3)

### Расчёты
- Отдельная вкладка с таблицей расчётов страховых программ, доступная продавцам и исполнителям.
- Колонки: «Страховая компания», «Программа», «Премия», «Период действия», «Статус», «Полис» и «Обновлено».
- Хедер карточки расчёта разворачивается в боковую панель с подробностями (см. [описание карточки](calculations.md)).
- Кнопка «Добавить расчёт» открывает модальное окно создания с обязательной загрузкой хотя бы одного файла перед сменой статуса на «Готов».
- Быстрые действия в строке: «Редактировать», «Дублировать», «Отметить как готово», «Связать с полисом» и «Перенести в архив» (при наличии прав).
- Статус «Готов» подсвечивается акцентом и добавляет бейдж «Ожидает подтверждения»; при привязке к полису отображается ссылка на карточку полиса.
- Список поддерживает фильтры «Активные», «Подтверждённые», «Архив» и поиск по названию программы; пустое состояние содержит CTA «Создать расчёт» и ссылку на инструкцию.

### Журнал
- Лента активности (создание задач, комментарии, автоматические уведомления).
- Возможность фильтрации по типам событий и полнотекстовый поиск.
- Состояние пустой ленты отображает подсказки и CTA «Добавить событие».
- Макеты: [Пустые вкладки](mockups/deal-details/deal-details-empty-tabs.svg) · [Figma](https://www.figma.com/file/CRM-2-0/Deal-Details?type=design&node-id=103-5)

### Действия
- Быстрые кнопки: «Создать задачу», «Отправить письмо», «Запросить документы».
- Выпадающее меню с дополнительными интеграциями (например, подключение аналитики).
- Валидационные сообщения отображаются в верхней части панели при ошибках внешних сервисов.
- Макеты: [Ошибки валидации](mockups/deal-details/deal-details-errors.svg) · [Figma](https://www.figma.com/file/CRM-2-0/Deal-Details?type=design&node-id=104-7)

### Задачи
- Содержит три списка по статусам: «Назначенные» (активные задачи исполнителя), «К исполнению» (ожидают принятия) и «Архив» (закрытые/отменённые).
- Верхняя панель фильтров включает переключатели по типу задачи (звонок, встреча, документ) и чекбокс «Показать чужие задачи» для ролей с расширенными правами.
- Карточка задачи отображает заголовок, дедлайн, ответственного и бейдж стадии (`todo`, `in_progress`, `done`). Внутри карточки — вложенный чеклист с подзадачами, который раскрывается inline.
- Дополнительные действия: «Отметить выполненной», «Переназначить», «Открыть подробности». Из карточки доступны быстрые комментарии и ссылка на вкладку «Журнал» с контекстным фильтром по задаче.
- Пустые состояния различаются по статусам: у «Назначенных» — CTA «Запланировать задачу», у «К исполнению» — подсказка о настройках автогенерации задач из CRM, у «Архива» — текст об отсутствии закрытых задач.

### Документы
- Зона загрузки поддерживает drag&drop и множественный выбор файлов; прогресс-бар отображает состояние отправки каждого файла отдельно.
- Файлы группируются по категориям: «Договор», «Согласия», «Дополнительные материалы». Категорию можно задать в модальном окне после загрузки или изменить из контекстного меню.
- Метаданные файла: имя, тип, размер, дата загрузки, автор и признак валидации («Проверен комплаенсом»). При успешной проверке отображается зелёный бейдж, при отклонении — красный с причиной.
- Поддерживаются версии файлов: при повторной загрузке с тем же именем система создаёт новую версию с историей изменений и возможностью отката.
- Политика хранения: в CRM хранятся ссылки на S3-объекты, сами файлы остаются доступными только при наличии прав. Удаление файла из интерфейса помечает объект как архивный и скрывает его из списка, но не удаляет физически.
- Ограничения на загрузку: до 100 МБ на файл, допустимые форматы PDF, DOCX, XLSX, JPG, PNG. При превышении лимита кнопка «Загрузить» блокируется и выводится подсказка.

### Финансы
- Блок агрегирует финансовые показатели сделки: «Всего начислено», «Получено», «Комиссия агента», «Расходы исполнителя», «Ожидает подтверждения».
- Каждая метрика связывается с платежами вкладки «Полисы»: карточка суммы содержит ссылку «Перейти к платежам», открывающую модал с фильтром по связанным платежам.
- Источник данных: агрегаты рассчитываются по подтверждённым и ожидающим подтверждения платежам (см. раздел «Список платежей полиса»). Черновые платежи не учитываются.
- Комиссии и расходы отображаются как доли от суммы платежей. При наличии нескольких валют дополнительно выводится курс и дата конвертации.
- Для пользователей с ролью финансового контролёра доступна кнопка «Экспортировать отчёт», которая выгружает CSV с деталями платежей, комиссиями и расходами.
- Состояние пустых данных показывает подсказку о необходимости добавить первый платёж и дублирует CTA «Добавить платёж» из блока платежей.

### Полисы
- Табличный список связанных полисов с колонками: номер, продукт, статус, период действия, премия, ответственный.
- Быстрые действия в строке: «Создать полис», «Пролонгировать» (для активных/архивных полисов), переход в карточку полиса в новом табе.
- Индикаторы статуса отображают цветовой маркер и текстовое пояснение; даты начала/окончания подсвечиваются, если полис истёк или истекает в ближайшие 30 дней.
- Хлебные крошки и кнопка «Назад к сделке» обеспечивают возврат после перехода в карточку полиса.
- Состояние пустого списка выводит сообщение о том, что полисы ещё не созданы, CTA «Создать полис» и ссылку на справку по процедуре оформления.
- Макеты: [Полисы сделки](mockups/deal-details/deal-details-policies.svg) · [Figma](https://www.figma.com/file/CRM-2-0/Deal-Details?type=design&node-id=105-9)

### Расчёты
- Блок располагается в правой колонке под карточкой «Текущий полис» и содержит список последних расчётов, отсортированных по дате обновления.
- Активные карточки включают ключевые поля (страховая, программа, премия, срок действия) и быстрые статусы («Черновик», «Ожидает подтверждения», «Готово»).
- Для подтверждённых расчётов доступно действие «Создать полис», для черновиков — быстрый переход к редактированию. Архивные записи свёрнуты по умолчанию.
- Полные правила отображения и формы описаны в [документе «Карточка расчёта и форма ввода»](calculations.md).

#### Список платежей полиса
- Для каждого полиса отображается вложенный список платежей с колонками «Номер», «Плановая дата», «Фактическая дата», «Сумма», «Статус подтверждения» и «Ответственный». Отдельная иконка в строке сигнализирует о наличии доходных и расходных позиций внутри платежа.
- Сводная строка под таблицей агрегирует суммы по категориям: «Всего начислено», «Получено», «Расходы исполнителя» и «Комиссия продавца», дополнительно выводя счётчики позиций доходов/расходов.
- При наличии более трёх записей список сворачивается в пагинированный блок с быстрыми фильтрами «Все», «С доходами», «С расходами», «Просроченные».
- Пустое состояние внутри полиса выводит подсказку «Добавьте первый платёж, чтобы продолжить оформление» и дублирует кнопку «Добавить платёж».

#### Раскрытие доходов и расходов
- Каждая строка платежа разворачивается в карточку с двумя вложенными списками: «Доходы» и «Расходы». Внутри каждого списка отображаются позиции с колонками «Источник/Статья», «Плановая сумма», «Фактическая сумма», «Статус» и «Документы».
- Позиции группируются по типу операции автоматически, но сам платеж остаётся нейтральным; заголовок карточки показывает итоговые суммы по доходам и расходам отдельно.
- При раскрытии отображаются таймлайн согласований и история изменений (`createdAt`, `updatedAt`, пользователь, комментарий) как для платежа, так и для отдельных позиций.
- Для доходных позиций выводится блок «Разнесение по счетам» с реквизитами и статусом сверки, для расходных — «Компенсация» с полем «Кто одобрил».
- Состояния раскрытия поддерживают быстрые теги: «Ожидает подтверждения», «Частичный платёж», «Закрыт», показываемые как для платежа в целом, так и для отдельной позиции при наведении.
- В футере раскрытой карточки присутствуют кнопки «Добавить доход» и «Добавить расход», создающие новые позиции внутри платежа без закрытия карточки.

#### Действия с платежами
- Доступные действия по правам: продавцы могут добавлять/редактировать доходные позиции, исполнители — расходные; администраторы видят оба сценария и могут корректировать базовые атрибуты платежа.
- Кнопка «Добавить платёж» открывает модальное окно с полями «Номер», «Плановая дата», «Плановая сумма», «Статус подтверждения», «Комментарий» и опциональным указанием фактической даты. Направление платежа не выбирается — оно задаётся набором вложенных позиций.
- Редактирование запускается из меню строки, сохраняет историю версий и требует указать причину изменения (выпадающий список + текстовое поле). Из раскрытой карточки также доступны отдельные формы «Добавить доход»/«Добавить расход» для создания позиций; каждая форма наследует базовый контекст платежа.
- Удаление доступно, если платёж не подтверждён: система требует двойное подтверждение и фиксирует событие в журнале сделки. Для подтверждённых платежей доступна отмена подтверждения, сбрасывающая фактическую дату и статусы позиций.
- Все CRUD-действия отображают всплывающие уведомления и синхронизируются с SSE-каналом CRM для мгновенного обновления списка у всех пользователей, включая новые позиции внутри платежа.

## Состояния и правила отображения
| Состояние | Описание | Особенности |
| --- | --- | --- |
| Загрузка | Отображается скелетон карточки и табов, пока данные сделки не получены. | Минимальное время отображения 600 мс для визуальной стабильности. |
| Просмотр | Используется по умолчанию для пользователей с правами чтения. | Заблокированы элементы редактирования; отображается кнопка «Запросить изменение». Просроченная дата «Следующий просмотр» подсвечивается акцентным цветом. |
| Редактирование | Доступно пользователям с правами «Редактирование сделок». | Несохранённые изменения подсвечиваются индикатором в табе «Формы». |
| Пустые вкладки | Активируется, если у сделки нет записей в журнале, доступных действий или полисов. | Показываются CTA и ссылки на обучение; для вкладки «Полисы» дополнительно выводится краткий гид по первому созданию. |
| Ошибки интеграций | Когда внешние сервисы недоступны. | Отображается баннер в верхней части с повторной попыткой. |

## Поле `nextReviewAt`
- Отображается в блоке с ключевыми атрибутами сделки и в карточке «Следующий обзор» на вкладке «Обзор».
- Значения в прошлом подсвечиваются насыщенным красным бейджем «Просрочено» и остаются вверху списков задач и карточек, пока дата не обновлена.
- Если до обзора осталось ≤24 часов, отображается янтарный бейдж «Скоро» и активируется напоминание в блоке действий.
- Значение обязательно для каждой сделки; UI предотвращает сохранение пустого поля и всегда хранит дату формата `YYYY-MM-DD`.
- Редактирование поля разрешено только в режиме «Редактирование»; при сохранении отправляется PATCH-запрос к `/deals/{id}` с полем `nextReviewAt` (camelCase) и автоматическим обновлением воронки.

## Интеграции и фичи
- **Виджет рекомендаций ИИ:** включается через feature-flag `deal-sidebar-widgets`. При отключённом флаге блок «Дополнительные виджеты» скрывается.
- **Подтверждённые оплаты:** отображает фактическую дату поступления средств, ФИО и должность сотрудника, подтвердившего платёж в CRM. Метка «Подтвердил(а)» содержит ссылку на карточку пользователя, а дата сопровождается тултипом с точным временем. Блок обновляется по данным CRM (через запрос карточки сделки или поток событий CRM) и не зависит от переменной `NEXT_PUBLIC_PAYMENTS_SSE_URL`.
- **Автоматические действия:** интеграция с сервисом задач; при отключённом RabbitMQ отображается баннер с подсказкой повторить позднее.
- **Полисные сервисы:** виджеты сделки получают ссылки на связанные полисы через GraphQL-шлюз; при изменении статуса полиса обновляются карточка «Текущий полис» во вкладке «Обзор» и таблица во вкладке «Полисы» без перезагрузки.

## Связанные артефакты
- [Каталог макетов](mockups/deal-details/) содержит векторные макеты состояний (SVG) и текстовую спецификацию (`spec.md`).
- Смежные сценарии описаны в [`docs/frontend/user-scenarios.md`](user-scenarios.md) → «Агент поддержки / Работа с обращениями».
- Карточка расчёта и сценарии подтверждения описаны в [`docs/frontend/calculations.md`](calculations.md).

> Обновлено: 2024-10-14. Ответственные: UX-команда сделок.
