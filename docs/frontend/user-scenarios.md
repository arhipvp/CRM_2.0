# Пользовательские сценарии по ролям

Документ описывает ключевые сценарии использования CRM 2.0 для утверждённых ролей доступа. Каждый сценарий включает бизнес-цель, последовательность действий, критерии приёмки и требования к доступности. Подробное описание ролевой модели см. в разделе «Пользовательские роли» основного README.

## Главный админ
- **Цель:** управлять пользователями, системными справочниками и аудитом.
- **Последовательность:**
  1. Перейти в раздел `/admin`, дождаться предзагруженных списков пользователей, ролей, справочников и аудита.
  2. Создать нового пользователя, назначить одну из доступных ролей и зафиксировать изменение (валидация email/ФИО выполняется сразу на форме).
  3. Обновить справочники (типы сделок, статусы задач) и проверить, что формы CRM используют новые значения.
  4. Просмотреть аудит последних операций, отфильтровать события по пользователю/важности и выгрузить отчёт в CSV или JSON.
- **Критерии приёмки:**
  - Новый пользователь появляется в списке без перезагрузки, роль применяется мгновенно. Пустые поля подсвечиваются до отправки на сервер.
  - Изменения справочников моментально отображаются в формах создания сделки и задачи. Деактивация элемента выполняется инлайн.
  - Журнал аудита поддерживает фильтры по пользователю, типу события, диапазону дат и экспорт в CSV/JSON.
  - Раздел защищён правами доступа: без разрешения `manage:users`/`manage:dictionaries` кнопки редактирования недоступны, без `export:audit` скрываются кнопки выгрузки.
- **Доступность:**
  - Формы управления пользователями и справочниками доступны с клавиатуры и имеют явные `label`.
  - Таблицы пользователей и аудита поддерживают навигацию через клавиатуру и озвучивание заголовков.

## Продавец (агент)
- **Цель:** провести сделку от создания лида до выпуска полиса.
- **Последовательность:**
  1. Создать нового клиента или открыть существующего из воронки.
  2. Завести сделку, заполнить ключевые параметры и добавить заметку в журнал.
  3. Назначить исполнителя на подготовку расчётов и создать задачу с дедлайном.
 4. В карточке сделки использовать быстрые правки (стадия, сумма, вероятность) и вкладки «Задачи/Документы/Финансы» для контроля прогресса.
 5. Перейти на вкладку «Полисы», чтобы проверить текущий статус предложения, создать новый полис или пролонгировать существующий.
  6. Развернуть список платежей полиса, добавить предоплату клиента и запланированный расход исполнителя, убедиться, что агрегаты пересчитались.
  7. После согласования расчёта с клиентом создать задачу «Оформить выбранный полис» и назначить исполнителя, привязав задачу к текущей сделке и выбранному полису.
  8. После подтверждения клиентом выбранного предложения инициировать выпуск полиса через быстрые действия и загрузить сканы документов.
- **Критерии приёмки:**
  - Сделка обновляется без перезагрузки, отображается в нужной колонке воронки.
  - Карточки в воронке сортируются по `nextReviewAt`: просроченные обзоры закреплены сверху, остальные идут по возрастанию даты, поле всегда заполнено.
  - Быстрые правки подсвечиваются и синхронизируются с журналом активности.
  - Задача «Оформить выбранный полис» автоматически появляется у назначенного исполнителя, отображается в календаре и привязывается к сделке и соответствующему полису.
  - Загруженные документы отображаются в карточке сделки, сохраняется история версий.
  - Карточка «Подтверждённые оплаты» отображает фактическую дату поступления средств из CRM и ФИО подтверждающего, подтягивая пользователя по `recorded_by_id`; данные обновляются вместе с карточкой сделки без ожидания интеграции Payments.
  - Список платежей внутри полиса поддерживает несколько записей по доходам и расходам, корректно фильтрует их и пересчитывает итоговые суммы и комиссию после каждого изменения без перезагрузки страницы.
  - Статусы сделки и полиса фиксируют дату оплаты из CRM и одновременно обновляют карточку «Текущий полис» во вкладке «Обзор» и таблицу во вкладке «Полисы».
  - Попытка удалить подтверждённый платёж недоступна для продавца; вместо этого отображается опция «Отменить подтверждение» с фиксацией события в журнале.
- **Доступность:**
  - Канбан-вью и карточки сделок управляются клавиатурой, состояние колонок озвучивается.
  - Файловые элементы имеют текстовые описания и доступны для screen reader.

## Исполнитель
- **Цель:** подготовить расчёты и оформить полис по назначенной сделке.
- **Последовательность:**
 1. Получить уведомление о новой задаче, открыть карточку сделки и ознакомиться с требованиями.
 2. Переключиться на вкладку «Документы», загрузить расчётные файлы и добавить заметку в журнал.
 3. Создать запись расчёта в блоке «Расчёты», указать страховую, программу, премию, срок действия и приложить ссылки на исходные файлы.
 4. После проверки клиентом варианта отметить расчёт как «Готов» и передать ссылку продавцу либо инициировать доработку.
 5. После выбора клиентом варианта обновить детали полиса и статус подготовки в блоке быстрого редактирования или через вкладку «Полисы» (доступ по обновлённым правам роли).
 6. Зафиксировать расходы на обследование и доставку документов, прикрепить подтверждающие файлы и отправить на компенсацию.
 7. Закрыть задачу, указав фактическое время и приложив итоговые файлы.
- **Критерии приёмки:**
  - Уведомление помечается как прочитанное и перемещается в историю.
  - Комментарии и заметки отображаются с именем автора и временной меткой.
  - Статус полиса меняется на «черновик/готов к выпуску» и фиксируется по фактической дате оплаты в CRM; изменения мгновенно отражаются во вкладке «Полисы» и в обзоре сделки вместе с указанием автора подтверждения (по `recorded_by_id`), без зависимостей от Payments.
  - Форма расчёта валидирует обязательные поля (страховая, программа, премия, срок действия) и не позволяет сохранять пересекающиеся по сроку подтверждённые расчёты с одинаковой страховой и программой.
  - Список расчётов отображает статусы «Черновик», «Ожидает подтверждения», «Готово» и «Архив», сортирует активные карточки выше архивных и подсвечивает актуальные сроки действия.
  - Расходы, созданные исполнителем, отображаются в общей ленте платежей, помечаются как «Ожидает компенсации» до подтверждения и влияют на агрегат «Валовая прибыль».
  - Закрытая задача исчезает из активного списка и попадает в архив с возможностью фильтрации.
- **Доступность:**
  - Комментарии и формы редактирования полиса доступны для ввода с клавиатуры.
  - Таблицы расчётов имеют читабельные заголовки и альтернативный текст для числовых значений.


## Будущие дополнения

* Отслеживание SLA для службы поддержки появится в [дорожной карте Tasks (Этап 1.1)](../delivery-plan.md#2-приоритизация-последующих-этапов) и будет описано после реализации автоматических напоминаний.
