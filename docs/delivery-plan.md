# План поставки и приоритизация инкрементов

Документ описывает состав первой поставки CRM и последовательность доработок в следующих релизах. Он служит рабочим ориентиром для всех команд (продукт, разработка, инфраструктура) и дополняет обзорные материалы из `README.md` и `docs/tech-stack.md`.

## 1. Область первой поставки

### Сервисы в составе первой поставки
- **Gateway / BFF** — единая точка входа для клиентов, проксирование REST и ретрансляция SSE; в первой поставке ретранслирует только каналы сделок и внутренних уведомлений.
- **Auth** — создание и управление пользователями, базовая авторизация по ролям.
- **CRM/Deals** — клиенты, сделки, расчёты, полисы, журнал активности и задачи первого уровня (ручное назначение, без SLA и автоматических сценариев). Учёт оплат ведётся внутри CRM/Deals: модуль платежей CRM публикует REST API и события `deal.payment.*`, фиксируя отдельные поступления премии, начисления комиссий и расходные выплаты со ссылкой на пользователя, подтвердившего запись. В рамках первой поставки CRM/Deals включает модуль задач, обеспечивающий ручное создание, назначение и отслеживание статусов задач без автоматических сценариев.
- **Documents** — связь сущностей CRM с серверным файловым хранилищем, хранение метаданных файлов, контроль доступа по ролям.
- **Notifications (ядро)** — генерация внутренних уведомлений и базовые каналы доставки через SSE и Telegram; интеграция с Telegram ограничена событиями «новая задача» и уведомлениями по изменению этапов сделок.
- **Reports** — FastAPI-сервис агрегированных отчётов по материализованным представлениям CRM (в первой поставке — воронка сделок).
- **Backup** — регулярные бэкапы PostgreSQL, конфигураций очередей и снапшотов метаданных файлового хранилища.
- **Инициализация каркасов сервисов** — генерация проектов на NestJS, FastAPI и Spring Boot с базовой конфигурацией окружения и сборки.

### Роли и сценарии, которые входят в первую поставку
- **Главный админ** — создание пользователей, назначение ролей, управление справочниками и контроль истории действий.
- **Продавец (агент)** — полный цикл ведения сделки: создание клиента, сделки, загрузка документов, инициирование задач, фиксация ключевых событий.
- **Исполнитель** — обработка назначенных задач, обновление расчётов, загрузка/просмотр документов в пределах назначенных сделок.

## 2. Приоритизация последующих этапов
Отдельные задачи по аналитике статусов оплат и экспортам из обособленного (архивного) Payments исключены: нужные показатели будут развиваться в отчётах CRM/Deals.
1. **Этап 1.1 (улучшения после запуска)**
   - Расширенная интеграция Notifications ↔ Telegram (быстрые ответы и дополнительные сценарии подтверждений сверх команд `/confirm_task` и `/confirm_payment`).
   - Привязка Telegram-аккаунтов в Auth и выпуск временных токенов для операций через бота.
   - <a id="notifications-export-autosubscribe"></a>Экспорт журнала событий Notifications в CSV/PDF и управление автоподписками.
   - Автоматические напоминания и SLA в модуле задач CRM/Deals (cron-триггеры, повторяющиеся задачи).
   - Экспорт задач в XLSX/CSV и публикация WebCal-подписок для общего календаря.
   - Расширенный календарь задач с масштабами «квартал/год» и агрегацией по исполнителям.
   - Полноценная реализация массовых действий в воронке сделок (API и UX) с обновлением `DealBulkActions`.
2. **Этап 2.0**
   - Расширение сервиса **Reports**: дополнительные витрины, экспорты и ETL-пайплайны для управленческих дашбордов.
   - Подключение внешних расчётных сервисов страховых компаний (API-интеграции вместо ручного ввода).
   - Расширение клиентских уведомлений: шаблонные рассылки через Telegram-бота и публикация событий в партнёрские SSE-каналы.
3. **Этап 3.0**
   - Автоматическая генерация документов на основе шаблонов.
   - Расширенные дашборды для главного админа и пользовательские отчёты.
   - Введение конструкторов бизнес-процессов для задач и сделок с настраиваемыми этапами согласования, сохраняя расчёты в валюте RUB.

## 3. Критерии готовности первого инкремента (Definition of Done)

### Минимальный функционал
- Пользователь с ролью продавца может создать клиента, завести сделку, заполнить расчёты, выбрать полис и зафиксировать статусы ключевых этапов.
- Исполнитель получает и закрывает назначенные задачи через модуль задач CRM/Deals, обновляя статусы сделок и связанные документы.
- Продавец и исполнитель фиксируют все типы платежей (премии, комиссии, скидки, выплаты) в рамках своих сделок: модуль поддерживает множество записей на полис, каждая запись хранит фактическую дату и структуру доходных и расходных позиций (категории, суммы) для распределения комиссии.
- Главный админ управляет пользователями и справочниками, просматривает встроенные журналы изменений без дополнительных ручных операций.

### Интеграции и инфраструктурные зависимости
- Настроены очереди RabbitMQ для взаимодействий CRM/Deals ↔ Notifications; параметры совпадают с `env.example` и документированы в `docs/local-setup.md`.
- Documents-сервис подключён к серверному хранилищу (локальный диск/volume/NFS/S3), создана структура каталогов для тестового клиента и проведена проверка прав доступа с учётом ролей.
- Настроены бэкапы PostgreSQL, Redis и конфигураций RabbitMQ; проверено восстановление из последнего снапшота.
- SSE-каналы (Gateway) обеспечивают поток изменений по сделкам и внутренним уведомлениям; обновления по оплатам получаются из тех же событий сделок и при необходимости запрашиваются из CRM через REST. Отдельный поток задач отложен до последующих релизов, smoke-тесты текущих каналов проходят успешно.
- Gateway работает как прозрачный REST-прокси для Auth и CRM/Deals; агрегирующие BFF-эндпоинты (дашборды, summary) отложены до следующих релизов.

### Ограничения первой версии
- Нет автоматической генерации договоров и актов — только загрузка готовых файлов.
- Отчётность ограничена предустановленным отчётом в Reports; кастомные фильтры, выгрузки и дашборды появятся в следующих релизах.
- Telegram-бот поддерживает уведомления, сценарий «быстрая сделка», а также команды `/confirm_task` и `/confirm_payment`; расширенные сценарии остаются в roadmap Этапа 1.1.
- Модуль задач CRM/Deals ограничен ручным созданием и управлением задачами; автоматические SLA, повторяющиеся задачи и cron-триггеры отложены до Этапа 1.1.
- Отсутствует экспорт задач и синхронизация календаря через WebCal; расширенный календарь с внешними подписками появится на Этапе 1.1.
- Нет интеграций с внешними биллингами и банками; платежи вводятся вручную или импортом CSV.
- Модель доступа одноуровневая: нет гибких настроек на уровне отдельных полей или операций, но Auth позволяет комбинировать базовые роли (продавец, исполнитель, главный админ), объединяя их права.
- Все расчёты ведутся только в валюте RUB; мультивалютные сделки не поддерживаются.

Документ подлежит обновлению после завершения каждого этапа.
