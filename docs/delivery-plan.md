# План поставки и приоритизация инкрементов

Документ описывает состав первой поставки CRM и последовательность доработок в следующих релизах. Он служит рабочим ориентиром для всех команд (продукт, разработка, инфраструктура) и дополняет обзорные материалы из `README.md` и `docs/tech-stack.md`.

## 1. Область первой поставки

### Сервисы в составе первой поставки
- **Gateway / BFF** — единая точка входа для фронтенда, проксирование REST и SSE, управление сессиями; в первой поставке ретранслирует только каналы сделок, платежей и внутренних уведомлений.
- **Auth** — создание и управление пользователями, базовая авторизация по ролям, привязка Telegram-аккаунтов (без обязательной двухфакторной схемы).
- **CRM/Deals** — клиенты, сделки, расчёты, полисы, журнал активности и задачи первого уровня (ручное назначение, без SLA и автоматических сценариев).
- **Tasks** — отдельный сервис задач: ручное создание и назначение задач первого уровня, фиксация статусов выполнения; SLA и автоматические сценарии не входят в первую поставку.
- **Payments** — учёт входящих платежей, комиссий и выплат, статусы план/факт, экспорт в отчёт Excel/CSV.
- **Documents** — связь сущностей CRM с Google Drive, хранение метаданных файлов, контроль доступа по ролям.
- **Notifications (ядро)** — генерация внутренних уведомлений и базовые каналы доставки через SSE и Telegram; интеграция с Telegram ограничена событиями «новая задача» и «изменение статуса платежа».
- **Reports** — FastAPI-сервис агрегированных отчётов по материализованным представлениям CRM/Audit (в первой поставке — воронка сделок).
- **Backup** — регулярные бэкапы PostgreSQL, конфигураций очередей и снапшотов Drive-метаданных.
- **Frontend (Next.js)** — рабочие сценарии для продавца и исполнителя: воронка сделок, карточка клиента, карточка сделки, платежи, документы, задачи.
- **Инициализация каркасов сервисов и фронтенда** — генерация проектов на NestJS, FastAPI, Spring Boot и Next.js с базовой конфигурацией окружения и сборки.

### Роли и сценарии, которые входят в первую поставку
- **Администратор** — создание пользователей и ролей, управление справочниками, просмотр истории действий.
- **Продавец (агент)** — полный цикл ведения сделки: создание клиента, сделки, загрузка документов, инициирование задач, фиксация ключевых событий.
- **Исполнитель** — обработка назначенных задач, обновление расчётов, загрузка/просмотр документов в пределах назначенных сделок.
- **Финансовый менеджер** — подтверждение и корректировка платежей, ведение комиссий и выплат, контроль статусов оплат.
- **Руководитель** — обзор воронки, чтение карточек клиентов/сделок и сводки по платежам (только чтение). Отчётность ограничена встроенными таблицами CRM.

## 2. Приоритизация последующих этапов
1. **Этап 1.1 (улучшения после запуска)**
   - Расширенная интеграция Notifications ↔ Telegram (подтверждение задач, быстрые ответы, подтверждение оплат).
   - <a id="notifications-export-autosubscribe"></a>Экспорт журнала событий Notifications в CSV/PDF и управление автоподписками.
   - Автоматические напоминания и SLA в Tasks (cron-триггеры, повторяющиеся задачи).
   - Экспорт задач в XLSX/CSV и публикация WebCal-подписок для общего календаря.
   - Расширенный календарь задач с масштабами «квартал/год» и агрегацией по исполнителям.
   - Улучшенная аналитика платежей (диаграммы, фильтрация по статусам и периодам).
2. **Этап 2.0**
   - Расширение сервисов **Reports** и **Audit**: дополнительные витрины, экспорты и ETL-пайплайны для управленческих дашбордов.
   - Подключение внешних расчётных сервисов страховых компаний (API-интеграции вместо ручного ввода).
   - Расширение клиентских уведомлений: шаблонные рассылки через Telegram-бота и публикация событий в партнёрские SSE-каналы.
3. **Этап 3.0**
   - Автоматическая генерация документов на основе шаблонов.
   - Расширенная роль руководителя с дашбордами и пользовательскими отчётами.
   - Введение конструкторов бизнес-процессов для задач и сделок с настраиваемыми этапами согласования, сохраняя расчёты в валюте RUB.

## 3. Критерии готовности первого инкремента (Definition of Done)

### Минимальный функционал
- Пользователь с ролью продавца может создать клиента, завести сделку, заполнить расчёты, выбрать полис и зафиксировать статусы ключевых этапов.
- Исполнитель получает и закрывает назначенные задачи через сервис Tasks, обновляя статусы сделок и связанные документы.
- Финансовый менеджер фиксирует все типы платежей (премии, комиссии, скидки, выплаты), контролирует план/факт и экспортирует список платежей.
- Руководитель просматривает консолидированную воронку и карточки сделок/платежей без права модификации.

### Интеграции и инфраструктурные зависимости
- Настроены очереди RabbitMQ для взаимодействий CRM/Deals ↔ Notifications ↔ Payments; параметры совпадают с `env.example` и документированы в `docs/local-setup.md`.
- Documents-сервис подключён к рабочему пространству Google Drive (OAuth 2.0), создана структура папок для тестового клиента и проводится проверка прав доступа.
- Настроены бэкапы PostgreSQL, Redis и конфигураций RabbitMQ; проверено восстановление из последнего снапшота.
- SSE-каналы для фронтенда (Gateway) работают для событий сделок, платежей и внутренних уведомлений; отдельный поток задач отложен до последующих релизов, smoke-тесты текущих каналов проходят успешно.

### Ограничения первой версии
- Нет автоматической генерации договоров и актов — только загрузка готовых файлов.
- Отчётность ограничена предустановленным отчётом в Reports; кастомные фильтры, выгрузки и дашборды появятся в следующих релизах.
- Telegram-бот поддерживает уведомления и сценарий «быстрая сделка»; подтверждение операций и расширенные сценарии остаются в roadmap Этапа 1.1.
- Сервис Tasks ограничен ручным созданием и управлением задачами; автоматические SLA, повторяющиеся задачи и cron-триггеры отложены до Этапа 1.1.
- Отсутствует экспорт задач и синхронизация календаря через WebCal; расширенный календарь с внешними подписками появится на Этапе 1.1.
- Нет интеграций с внешними биллингами и банками; платежи вводятся вручную или импортом CSV.
- Модель доступа одноуровневая: нет гибких настроек на уровне отдельных полей или операций.
- Все расчёты ведутся только в валюте RUB; мультивалютные сделки не поддерживаются.

Документ подлежит обновлению после завершения каждого этапа.
