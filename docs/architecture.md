# Архитектурный обзор

## 1. Общая структура сервисов

CRM состоит из набора специализированных сервисов, сгруппированных по доменам. Таблица ниже показывает основные функции и ключевые зависимости.

| Сервис | Основная ответственность | Ключевые зависимости |
| --- | --- | --- |
| Gateway / BFF | Единая точка входа для веб-клиента и Telegram-бота, оркестрация запросов, управление сессиями, агрегация данных | Redis (сессии, кеш), внутренние REST API сервисов, SSE-каналы CRM/Deals и Notifications, Consul |
| Auth | Управление пользователями, ролями, OAuth/OIDC-потоками, выдача токенов и проверка доступов | PostgreSQL (схема `auth`), Redis (одноразовые коды и токены), Gateway |
| CRM / Deals | Клиенты, сделки, расчёты, полисы, журналы и связанные задачи | PostgreSQL (схема `crm`), RabbitMQ (доменные события), Documents API |
| Payments | Учёт платежей, комиссий и взаиморасчётов, публикация финансовых событий | PostgreSQL (схема `payments`), RabbitMQ (exchange `payments.events`), внешние API курсов |
| Tasks | Планирование и исполнение задач, SLA и напоминания | PostgreSQL (схема `tasks`), RabbitMQ, Notifications |
| Notifications | Доставка уведомлений и триггеров в Telegram и внутренние уведомления CRM | RabbitMQ, Gateway (webhook Telegram), Redis (rate limiting) |
| Documents | Управление метаданными файлов и связью с Google Drive | PostgreSQL (схема `documents`), Google Drive API, Auth |
| Telegram Bot | Канал обратной связи с пользователями, поддержка быстрых сценариев | Gateway (webhook), Auth (валидация пользователей), RabbitMQ |
| Audit | Централизованный журнал действий пользователей и системных событий | PostgreSQL (схема `audit`), RabbitMQ (подписка на критичные события) |
| Backup | Резервное копирование баз, политик и конфигураций | PostgreSQL (репликации и дампы), объектное хранилище |

Детализация технологического стека сервисов Tasks и Notifications приведена в разделах [«Tasks»](tech-stack.md#tasks) и [«Notifications»](tech-stack.md#notifications) документа `docs/tech-stack.md`.

## 2. Взаимодействия и потоки данных

### 2.1 Синхронные вызовы

1. Веб-клиент обращается к Gateway/BFF, который определяет целевой сервис и обогащает ответы агрегированными данными.
2. Telegram-бот получает обновления через webhook, который завершается в Gateway; шлюз нормализует payload и инициирует внутренние запросы.
3. Gateway проксирует обращения к внутренним REST API (Auth для авторизации, CRM/Deals для операций с клиентами и сделками, Payments для финансовых операций и т.д.) и поддерживает SSE-потоки CRM/Deals и Notifications для фронтенда.
4. Для операций, требующих нескольких доменов, Gateway выполняет композицию данных и кеширует результаты в Redis.

### 2.2 Асинхронная шина RabbitMQ

RabbitMQ используется как единая шина событий и фоновых задач.

* **Exchange `payments.events`** — Payments публикует доменные события (создание, подтверждение, возврат платежей) в формате CloudEvents. На них подписаны CRM/Deals, Tasks и Notifications, которые реагируют на изменения финансовых статусов.
* **Очереди уведомлений** — Notifications формирует сообщения для Telegram-бота и внутренних уведомлений CRM. Dead-letter-очереди фиксируют недоставленные события, чтобы Audit мог разбирать инциденты.
* **Фоновые задачи** — CRM/Deals и Tasks размещают длительные операции (подготовка отчётов, пересчёт SLA) в очередях с отложенной обработкой. Celery и worker-компоненты потребляют задачи, фиксируя результаты в своих PostgreSQL-схемах.

Асинхронное взаимодействие разгружает Gateway и позволяет временно деградировать сервисам без потери данных — сообщения сохраняются до восстановления потребителей.

### 2.3 Единый PostgreSQL-кластер

Все прикладные сервисы используют общий PostgreSQL-кластер, развёрнутый в конфигурации primary–standby с репликацией и бэкапами.

* Каждому сервису выделена отдельная схема (`auth`, `crm`, `payments`, `tasks`, `documents`, `notifications`, `audit`).
* Изоляция достигается за счёт ролей с ограниченными правами и политик RLS, а общие справочники публикуются через представления только для чтения.
* Audit получает повышенные SLA на хранение и резервирование: все критичные события дублируются в отдельной партиционированной таблице.

### 2.4 Роль Gateway/BFF

Gateway — единственная точка входа для внешних клиентов (веб-клиент, Telegram-бот, интеграции).

* Выполняет аутентификацию по токенам, выданным Auth, и обогащает запросы данными о пользователе.
* Реализует политики rate limiting и кеширует агрегированные ответы в Redis.
* Маршрутизирует webhook-и (например, из Telegram) к соответствующим внутренним сервисам, обрабатывая подтверждения и обратные вызовы.
* Предоставляет fallback-сценарии: при недоступности отдельных сервисов сообщает о деградации и переключается на кэшированные данные, где это допустимо.

### 2.5 Сквозной поток данных (пример создания сделки)

1. Пользователь инициирует создание сделки во фронтенде; запрос поступает в Gateway.
2. Gateway валидирует пользователя через Auth и записывает команду в CRM/Deals.
3. CRM/Deals создаёт записи в своей схеме PostgreSQL, публикует событие `deal.created` в RabbitMQ и создаёт задачу в Tasks.
4. Notifications подписывается на событие, формирует уведомления и отправляет их в очереди Telegram-бота и внутренней CRM.
5. Telegram-бот и внутренняя CRM доставляют сообщения пользователю; подтверждения через Gateway возвращаются в CRM/Deals, обновляя статус задачи.
6. При появлении первого платежа сервис Payments записывает транзакцию, публикует событие в `payments.events`, после чего CRM/Deals и Tasks синхронизируют статусы, а Audit фиксирует факт поступления.

## 3. Диаграмма взаимодействий

```mermaid
flowchart LR
    subgraph Client Channels
        FE[Web Client]
        TG[Telegram Bot]
    end

    FE -->|REST + SSE| GW[Gateway / BFF]
    TG -->|Webhook| GW

    GW -->|AuthN/AuthZ| AUTH[Auth]
    GW -->|Domain APIs| CRM[CRM / Deals]
    GW --> PAY[Payments]
    GW --> DOCS[Documents]
    GW --> TASKS[Tasks]
    GW --> NOTI[Notifications]

    subgraph RabbitMQ Bus
        PAY -->|payments.events| EX[Exchange]
        CRM -->|domain events| EX
        NOTI -->|notifications| EX
        TASKS -->|background jobs| EX
        EX --> CRM
        EX --> TASKS
        EX --> NOTI
        EX --> AUD[Audit]
    end

    subgraph PostgreSQL Cluster
        AUTH
        CRM
        PAY
        TASKS
        DOCS
        NOTI
        AUD
    end

    GW -->|Session Cache| REDIS[(Redis)]
    DOCS -->|Metadata| AUD
    BACKUP[(Backup Service)] -->|Snapshots| PostgreSQL Cluster
```

Диаграмма подчёркивает, что все прикладные сервисы работают с единой базой данных (с изолированными схемами) и общаются через асинхронную шину RabbitMQ, а Gateway выступает координатором внешних и внутренних взаимодействий для пользовательских каналов (веб-клиента и Telegram-бота).

## 4. Связанные документы

* [README.md](../README.md) — бизнес-контекст и пользовательские сценарии.
* [docs/data-model.md](data-model.md) — физическая модель данных (ER-диаграммы, таблицы и ограничения).
* [docs/tech-stack.md](tech-stack.md) — технологический стек и инфраструктурные решения (дополняет разделы 2.2–2.4).
* [docs/security-and-access.md](security-and-access.md) — политика доступа, соответствующая ролям и границам сервисов.
