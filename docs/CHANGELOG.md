# CRM 2.0 — изменения

## [Unreleased]

### Инфраструктура
- Сценарий инициализации PostgreSQL включает расширение `pgcrypto` вместе с `uuid-ossp`, чтобы гарантировать доступность криптографических функций в локальной среде.
- Улучшен `infra/postgres/init.sh`: роли сервисов пересоздаются с правами `LOGIN` и `CREATEDB`, им выдаётся `GRANT CREATE` на базу и схемы, а схема `tasks` и перекрёстные доступы `crm` к `documents`/`auth` подготавливаются автоматически, включая `GRANT EXECUTE` на функции и соответствующие `ALTER DEFAULT PRIVILEGES`.

### Очистка клиентских артефактов
- Исключён архив с макетами и UX-описаниями Next.js-интерфейса: клиентский UI больше не поставляется вместе с backend-репозиторием.
- README и сопутствующие инструкции описывают только backend-сценарии (`bootstrap`, `dev-up`, ручной запуск сервисов, Telegram-бот).
- Навигационные документы (`docs/tech-stack.md`, `docs/local-setup.md`, `docs/ai-development-plan.md`) обновлены так, чтобы указывать на актуальные каналы работы (Gateway, Telegram-бот) и не ссылаться на удалённый UI.

### Схема данных
- В таблицу `crm.policies` добавлено поле `premium` (`numeric(12,2)`), фиксирующее страховую премию по оформленному полису.
- Миграция `2025102601_add_tasks_module` корректно работает с уже существующей схемой `tasks`: при отсутствии прав владельца операция не падает, а выводит диагностическое сообщение, позволяя продолжить bootstrap.

### Backend

#### Authentication & Authorization
- **Блокировка отключённых пользователей:** добавлена проверка `user.enabled` в методы `TokenService.issueTokens()` и `TokenService.refreshToken()`. Отключённые пользователи не могут получить токены (403 Forbidden при логине) и не могут использовать существующие refresh-токены (403 Forbidden при попытке refresh с автоматической очисткой токена из Redis).
- Документация API (`docs/api/auth.md`) обновлена с описанием новых 403-ответов для отключённых учётных записей.

#### Legacy Services
- Удалён легаси-сервис `backend/tasks`: модуль задач поддерживается только внутри CRM (`backend/crm`). Обновлены README, документация и `env.example`, чтобы отразить новое расположение и переменные окружения (`CRM_TASKS_EVENTS_SOURCE`).
- Из тестовой конфигурации CRM удалена устаревшая переменная окружения `CRM_DEFAULT_TENANT_ID`; тесты больше не полагаются на tenant-настройки.
- Миграция `2025102604_migrate_crm_tasks_to_tasks_schema` больше не копирует `tenantId` в payload и не требует `tenant_id` при откате.

### Frontend

#### Аутентификация & Авторизация
- **Нормализация ролей:** реализована система нормализации различных форматов ролей от backend (массивы строк, объекты с различными полями, comma-separated строки). Пользовательский интерфейс гарантирует `roles: string[]`, исключая необходимость проверок на `undefined`. Поддерживаются форматы от Spring Security, Keycloak, Auth0 и legacy-систем.
- **Улучшенная обработка ошибок:** добавлена функция `analyzeAuthError()` в `authApi.ts`, которая различает ошибки аутентификации (401/403) и временные сбои (сеть, 5xx). При ошибках сети/сервера токены сохраняются и пользователю показывается информативное сообщение, позволяя восстановиться без переввода учётных данных. Только при 401/403 выполняется logout.
- **Компонент NetworkErrorAlert:** новый компонент для отображения ошибок сети/сервера в top-right углу с поддержкой retry и close actions. Различает три типа ошибок: сеть (жёлтый), сервер (красный), аутентификация (оранжевый).
- **Защита от пустого refresh-токена:** в `apiClient.ts` добавлена проверка на пустое значение `refreshToken` от backend. При получении пустого токена существующий токен сохраняется, логируется warning и операция продолжает работать.
- Обновлён интерфейс `User` с гарантией `roles: string[]`. Компоненты типа `UserProfileDropdown` теперь безопасно работают со строковым массивом ролей без проверок на undefined.

#### Тестирование & Документация
- Добавлены 40+ unit-тестов для нормализации ролей в `authApi.test.ts`
- Добавлены 30+ unit-тестов для анализа ошибок в `authApi.test.ts`
- Добавлены 30+ unit-тестов для форматирования ролей в `UserProfileDropdown.test.tsx`
- Созданы 6 интерактивных Storybook-историй для компонента `NetworkErrorAlert`, демонстрирующих все типы ошибок и сценарии восстановления
- Добавлены подробные гайды в `.claude/` для документирования реализации
