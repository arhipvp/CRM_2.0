# Экран «Уведомления и журнал событий»

- **Описание макета:** лента уведомлений с фильтрами и таймлайном событий; используйте материалы в `docs/frontend/mockups/notifications-center/` для визуальных состояний.
- **Текстовая спецификация состояний:** [spec.md](mockups/notifications-center/spec.md).
- **Назначение:** централизованное управление уведомлениями, настройка каналов и просмотр журнала событий.

## Основные блоки
1. **Лента уведомлений:** список карточек с возможностью группировки и фильтрации.
2. **Панель настроек:** выбор каналов доставки (SSE, Telegram) и базовые фильтры по типам событий.
3. **Журнал событий:** аудит действий пользователей и системные события с поиском.

### Системные источники уведомлений
- **CRM** — события, связанные с карточками клиентов и сделок.
- **Платежи** — статусы и напоминания из модуля платежей CRM.
- **Уведомления** — общий канал для системных сообщений и алертов, не попадающих в специализированные категории.

## Пользовательские действия
- Маркировка уведомлений как прочитанных/важных, удаление.
- Настройка базовых правил доставки по типам событий и ролям.
- Просмотр деталей события с полным контекстом (кто, что, когда, объект).

## Состояния элементов
- **Загрузка:** общий прогресс-бар + skeleton-элементы в списке.
- **Пустые состояния:** иллюстрации и CTA «Настроить уведомления».
- **Ошибки доставки:** отображение значка предупреждения и всплывающих подсказок.
- **Пакетные операции:** индикатор процесса и возможность отмены.

## Критерии приёмки
- Изменения настроек уведомлений сохраняются мгновенно и подтверждаются уведомлением.
- Фильтры журнала поддерживают сохранённые представления и быстрый доступ.
- Уведомление считается прочитанным после открытия детали или по таймеру (5 с).

## Отложенные возможности
- Экспорт журнала событий в CSV/PDF.
- Настройка автоподписки на уведомления и события.
- Расширенные правила доставки (динамические расписания, приоритеты каналов).

> Эти возможности запланированы на [Этап 1.1](../delivery-plan.md#notifications-export-autosubscribe).

## Требования к доступности
- Журнал событий поддерживает навигацию по клавише `Tab` и `Shift+Tab`, строки имеют `aria-label`.
- Для цветовых индикаторов статусов используются дополнительные текстовые метки.
- Все уведомления попадают в `aria-live="polite"`, приоритетные — в `aria-live="assertive"`.
- Настройки имеют понятные подписи и описания, доступные screen reader'у.

## Реализация

- Страница `/notifications` рендерится без серверного префетча. Компоненты `NotificationFeed` и `EventJournal` выполняют запросы на клиенте, показывая собственные skeleton-состояния и ошибки загрузки, поэтому отдача страницы не блокируется ожиданием REST-ответов.
- Состояние ленты уведомлений и настроек доставки хранится в zustand-хранилище `useNotificationsStore`. В нём реализованы фильтры, выборка, операции «прочитано/важно», синхронизация каналов и интеграция с SSE.
- Поток SSE (`SSEBridge`) конвертирует события в типизированные элементы `NotificationFeedItem`, обновляет стор и актуализирует кэш React Query (`notificationsFeedQueryKey`), чтобы новые уведомления появлялись без перезагрузки.
- Для REST-мутаторов (`mark/read`, `important`, `delete`, `update channel`) добавлены хуки `useMarkNotificationsRead`, `useToggleNotificationsImportant`, `useDeleteNotifications`, `useUpdateNotificationChannel`, которые синхронно обновляют zustand и кэш запросов.
- UI разбит на независимые компоненты: `NotificationsHeader`, `NotificationFeed`, `DeliverySettingsPanel`, `EventJournal`. Для Storybook экспортированы состояния «загрузка», «пусто», «ошибка», чтобы демонстрировать ключевые сценарии без обращения к API.
- Журнал событий использует локальные фильтры, поддерживает пакетные действия и выводит статусные бейджи с текстовыми обозначениями для соответствия требованиям доступности.

## Changelog

- 2024-12-05 — добавлен экран «Уведомления и журнал», zustand-хранилище уведомлений и сценарии Storybook/ Vitest для основных состояний.

## Инфраструктурные зависимости и запуск backend-сервиса

- SSE-канал `/notifications/stream` обслуживается сервисом Notifications (NestJS). Для локальной разработки запустите `pnpm start:dev` в `backend/notifications` — эндпоинт отдаёт `text/event-stream` и пересылает события, поступающие из RabbitMQ или REST-хука `/notifications/events`.
- Поток подключается к фронтенду через `NEXT_PUBLIC_NOTIFICATIONS_SSE_URL`; при запуске через Gateway используйте маршрут `http://localhost:${GATEWAY_SERVICE_PORT}/api/v1/streams/notifications`. Прямое подключение к сервису (`http://localhost:${NOTIFICATIONS_SERVICE_PORT}/notifications/stream`) допустимо для отладки без Gateway.
- Доставка в Telegram настраивается переменными `NOTIFICATIONS_TELEGRAM_ENABLED`, `NOTIFICATIONS_TELEGRAM_CHAT_ID`, `NOTIFICATIONS_TELEGRAM_BOT_TOKEN` и флагом `NOTIFICATIONS_TELEGRAM_MOCK`. Значения по умолчанию включают mock-режим, поэтому фронтенд и вебхуки можно тестировать без реального бота.
- Bootstrap-скрипт (`./scripts/bootstrap-local.sh`) автоматически применяет миграции Notifications через `scripts/migrate-local.sh` и создаёт пользователей RabbitMQ на основе переменных `NOTIFICATIONS_RABBITMQ_*`, поэтому после обновления `env.example` синхронизируйте `.env` и перезапустите скрипт.
