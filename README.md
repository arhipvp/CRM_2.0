> ⚠️ GitHub Actions временно приостановлены: файлы workflow переименованы в `.github/workflows/*.yml.disabled`, поэтому автоматические пайплайны не запускаются. Интеграционные проверки выполняются только локально согласно инструкции из [`docs/local-setup.md`](docs/local-setup.md); чтобы вернуть CI/CD, уберите суффикс `.disabled` и запустите обычный PR.

**Быстрая навигация:** [План поставки](docs/delivery-plan.md), [Архитектура](docs/architecture.md#1-общая-структура-сервисов), [Технологический стек](docs/tech-stack.md), [API](docs/api/README.md), [UX-документация фронтенда](docs/frontend/README.md), [Локальная настройка](docs/local-setup.md), [Тестовые данные](docs/testing-data.md), [Бэкапы](backups/README.md)

## Быстрый старт

```bash
./scripts/bootstrap-local.sh
```

Сценарий последовательно выполняет ключевые шаги локальной подготовки, управляя инфраструктурой через Docker Compose, и печатает агрегированную таблицу статусов:

1. синхронизация `.env` через `scripts/sync-env.sh --mode=skip-existing` (создаёт файл или обновляет значения из `env.example` без пауз для уже существующих `.env`);
1. синхронизация `.env` через `scripts/sync-env.sh` (создаёт файл или обновляет значения из `env.example` и фиксирует пропуски);
2. запуск инфраструктуры `docker compose up -d` в каталоге `infra/`;
3. ожидание готовности контейнеров (`docker compose wait` либо резервный цикл с проверкой healthcheck);
4. автоматическая настройка RabbitMQ (`infra/rabbitmq/bootstrap.sh`);
5. миграции CRM/Auth через `scripts/migrate-local.sh`;
6. загрузка seed-данных, если существует `scripts/load-seeds.sh`;
7. smoke-проверка окружения `scripts/check-local-infra.sh`.

Обязательные зависимости: Docker с Compose V2, Python 3 (`python3`), Poetry и JDK 17+ (для Gradle wrapper в `backend/auth`). Отсутствие CLI `psql`, `redis-cli`, `curl` приводит только к предупреждениям — bootstrap продолжится, а для соответствующих шагов можно использовать `docker compose exec` или альтернативные инструменты. Скрипт автоматически выдаёт предупреждение о пропущенных шагах и сохраняет логи неудачных этапов во временной директории.

1. Общее представление
CRM предназначена для небольшой команды страховых агентов, которые ведут клиентов по долгосрочным страховым сделкам. Система концентрирует данные о клиентах, сделках, полисах, платежах и связанных документах, распределяет задачи между пользователями и обеспечивает контроль по ключевым событиям. Архитектурный черновик уже выделяет целевые сервисы (Gateway, Auth, CRM/Deals, Documents, Tasks, Notifications, Reports, Audit, Backup); платёжная логика работает внутри CRM/Deals без отдельного сервиса. Состав первой поставки и критерии готовности описаны в документе [`docs/delivery-plan.md`](docs/delivery-plan.md). Подробные спецификации REST/SSE интерфейсов находятся в каталоге [`docs/api`](docs/api/README.md), а форматы интеграционных событий зафиксированы в [`docs/integration-events.md`](docs/integration-events.md).

### Текущее состояние репозитория
В репозитории уже лежат рабочие сервисы и фронтенд первой волны: **Gateway/BFF** (NestJS + pnpm), **Auth** (Spring Boot + Gradle), **CRM/Deals** (FastAPI + Celery) и клиентский **Frontend** (Next.js + pnpm). Каркасы сервисов **Tasks**, **Documents**, **Notifications** и инфраструктурного набора **Backup** подготовлены вместе с миграциями и инструкциями, но прикладная логика ещё в разработке — ориентируйтесь на `docs/delivery-plan.md` и README соответствующих директорий при планировании задач. Каталог **Reports** содержит рабочий каркас FastAPI-сервиса с подключением к PostgreSQL (см. [`backend/reports/README.md`](backend/reports/README.md)), а **Audit** остаётся заглушкой до этапа [1.1](docs/delivery-plan.md#2-приоритизация-последующих-этапов). Платёжный модуль теперь входит в CRM/Deals; каталог `backend/payments` сохранён для истории и больше не используется в актуальной архитектуре, инфраструктурные скрипты больше не создают схему `payments` и не ожидают переменных `PAYMENTS_DB_*`. Детали по окружению и API остаются в `docs/tech-stack.md`, `docs/api` и `env.example`.

**Технологический стек и базовые архитектурные принципы** собраны в документе [`docs/tech-stack.md`](docs/tech-stack.md), который служит основой для детальных спецификаций сервисов и инфраструктуры.

### Структура репозитория
- [`docs/local-setup.md`](docs/local-setup.md) — карта сервисов с портами и ссылками на инструкции запуска.
- [`docs/testing-data.md`](docs/testing-data.md) — стандартный набор тестовых данных и процедура загрузки seed-миграций.
- Backend:
  - [`backend/gateway/README.md`](backend/gateway/README.md) — запуск BFF/Gateway.【F:backend/gateway/README.md†L1-L34】
  - [`backend/auth/README.md`](backend/auth/README.md) — конфигурация Auth и миграции Liquibase.【F:backend/auth/README.md†L1-L30】
  - [`backend/crm/README.md`](backend/crm/README.md) — инструкции для CRM/Deals и Celery.【F:backend/crm/README.md†L1-L32】
- [`backend/payments/README.md`](backend/payments/README.md) — архивная документация прежнего отдельного сервиса, который заменён модулем платежей CRM.
  - [`backend/documents/README.md`](backend/documents/README.md) — NestJS-сервис для серверного файлового хранилища и BullMQ.【F:backend/documents/README.md†L1-L30】
  - [`backend/notifications/README.md`](backend/notifications/README.md) — SSE, очереди и отправка уведомлений.【F:backend/notifications/README.md†L1-L30】
  - [`backend/telegram-bot/README.md`](backend/telegram-bot/README.md) — FastAPI + aiogram сервис Telegram-бота с вебхуком и интеграциями CRM/Auth/Notifications.
  - [`backend/tasks/README.md`](backend/tasks/README.md) — обработка задач и отложенных событий.【F:backend/tasks/README.md†L1-L30】
  - [`backend/reports/README.md`](backend/reports/README.md) — FastAPI-сервис Reports и инструкции по подключению к CRM/Audit.【F:backend/reports/README.md†L1-L47】
  - [`backend/audit/README.md`](backend/audit/README.md) — журналирование и агрегаты для аналитики.【F:backend/audit/README.md†L1-L30】
- Frontend: [`frontend/README.md`](frontend/README.md) — запуск Next.js и тестовые профили.【F:frontend/README.md†L1-L36】
- Backups: [`backups/README.md`](backups/README.md) — скрипты и артефакты резервного копирования.【F:backups/README.md†L1-L8】
## Запуск окружения разработки

Подробная инструкция с альтернативными ручными шагами описана в [`docs/local-setup.md`](docs/local-setup.md). Используйте её, если нужно выполнить подготовку выборочно или воспроизвести отдельный этап. Перед стартом приложений дополнительно можно выполнить smoke-check `./scripts/check-local-infra.sh`, чтобы убедиться в доступности PostgreSQL, Redis, Consul и RabbitMQ Management UI.
Для быстрого старта выполните `./scripts/bootstrap-local.sh`: скрипт проверит наличие `.env`, поднимет инфраструктуру через `docker compose`, настроит RabbitMQ и применит миграции CRM/Auth. Подробности и требования перечислены в разделе [`docs/local-setup.md`](docs/local-setup.md). Если требуется ручной контроль каждого шага, воспользуйтесь fallback-инструкцией из того же документа. Перед стартом приложений рекомендуем запустить smoke-check `./scripts/check-local-infra.sh` (при отсутствии `psql`/`redis-cli`/`curl` можно использовать `docker compose exec` и аналоги), чтобы автоматически убедиться в доступности PostgreSQL, Redis, Consul и RabbitMQ Management UI.

2. Пользовательские роли
Система использует одноуровневую модель доступа с тремя ролевыми типами. Если у роли есть доступ к сущности, то она может просматривать и изменять данные в рамках закреплённых за ней клиентов и сделок; дополнительных уровней «только чтение» или «расширенный доступ» нет для операционных ролей.

- **Главный админ** — управляет пользователями, системными справочниками и имеет полный доступ ко всем сущностям для администрирования и аудита.
- **Продавец (агент)** — инициирует сделки, ведёт коммуникацию с клиентом, управляет журналом сделки, полисами, документами и расходами в своих сделках.
- **Исполнитель** — готовит расчёты, оформляет полисы и поддерживает документооборот в сделках, где назначен, с правом вносить изменения в назначенных сущностях.

3. Основные сущности
Клиент. Физическое или юридическое лицо. Атрибуты: реквизиты, контакты, одно или несколько контактных лиц, сегмент, статус (потенциальный, активный, неактивный). У клиента может быть множество сделок.

Сделка. Объединяет страховые потребности клиента по одному объекту или группе объектов. Содержит:

описание объекта страхования (например, автомобиль, парк ТС, ипотечное имущество);

участников (ведущий пользователь, дополнительные участники);

журнал текстовых заметок (пробег авто, остаток долга и т.п.);

расчёты по страховым компаниям;

набор полисов;

привязанные задачи и документы (структура папок описана в разделе 5).

планируемую дату следующего обзора (`nextReviewAt`), которая управляет сортировкой карточек сделки и напоминаниями.

Расчёт. Результат обращения к страховой компании. Атрибуты: компания, программа, условия, тарифы, дата расчёта, комментарии, файлы. Хранится история изменений.

Полис. Конкретный договор страхования (обычно на 1 год). Атрибуты: номер, страхователь, программа, период действия, страховая сумма, премия, статус (черновик, действует, ожидает продления, закрыт). Привязан к сделке и клиенту.

Платёж. Финансовая запись, жёстко привязанная к одному полису. Для полиса допускается множество записей — так фиксируются частичные оплаты, доначисления комиссии и последующие выплаты. Базовая таблица `crm.payments` хранит реквизиты операции: агрегированную сумму, валюту, фактическую дату (`actual_date`), комментарий, пользователя, подтвердившего запись, а также предрасчитанные агрегаты по связанным позициям (`incomes_total`, `expenses_total`, `net_total`). Распределение на несколько полисов не допускается: если операция затрагивает разные полисы, создаются отдельные записи.

Структура доходов и расходов хранится отдельными позициями: доходные строки (`crm.payment_incomes`) фиксируют премии клиента и поступления комиссии, расходные (`crm.payment_expenses`) — скидки клиенту, выплаты коллегам и другие удержания. Все позиции ссылаются на базовый платёж, наследуют его метаданные и суммируются в агрегаты `incomes_total`/`expenses_total`/`net_total`, что позволяет совмещать доходы и расходы внутри одной записи без деления по направлению. Для корректировок создаются дополнительные строки с отрицательными суммами, статусных полей нет — записи отражают факт и редактируются вручную либо импортом CSV.

Документ. Файл в серверном хранилище. Типы: расчёт, заявление, договор, полис, акт, чек, переписка. Метаданные: владельцы (сделка/полис/платёж), дата загрузки, автор, заметки. Генерация документов не требуется — только хранение и структурирование.

Задача. Назначение для пользователя. Атрибуты: связанная сделка/полис/платёж, обязательное текстовое описание, срок, приоритет, напоминания, статус выполнения.

4. Ответственность сервисов

Развёрнутые обязанности и взаимодействия приводятся в документе [«Архитектурный обзор»](docs/architecture.md#2-взаимодействия-и-потоки-данных); ниже — краткое резюме доменов.
Gateway/BFF. Общая точка входа для фронтенда, управление сессиями, маршрутизация запросов к сервисам, агрегация данных (подробнее см. раздел [«Фронтенд» технологического стека](docs/tech-stack.md#фронтенд) и [`backend/gateway/README.md`](backend/gateway/README.md)).

Auth. Управление пользователями, ролями и доступами к сделкам/документам (включая разграничение каталогов хранилища); подробности и сценарии миграций — в [`backend/auth/README.md`](backend/auth/README.md).

CRM/Deals. Владеет клиентами, сделками, расчётами, полисами, журналами сделок, задачами, уведомлениями о ключевых событиях; бизнес-потоки и запуск описаны в [`backend/crm/README.md`](backend/crm/README.md).

Платежи (модуль CRM). Учёт всех финансовых движений по полисам, включая множественные записи на один полис, детализацию доходов/расходов и аудит корректировок. Модуль заменил прежний сервис Payments, публикует события `deal.payment.updated` и хранит разбиение на доходные и расходные позиции внутри схемы `crm`.

Documents. Связывает сделки и полисы с каталогами серверного хранилища, хранит метаданные файлов, управляет доступами. Генерации документов нет; подготовленные инструкции — в [`backend/documents/README.md`](backend/documents/README.md).

Tasks. Планирование и исполнение задач, напоминания назначенным пользователям. SLA и автоматические сценарии будут включены после выпуска [Этапа 1.1](docs/delivery-plan.md#2-приоритизация-последующих-этапов); текущие договорённости зафиксированы в [`backend/tasks/README.md`](backend/tasks/README.md).

Notifications. Отправка уведомлений по событиям (Telegram, внутренние SSE-уведомления CRM), интеграция с ботом для доставки и подтверждений; см. [`backend/notifications/README.md`](backend/notifications/README.md). Вебхуки доставки Telegram проверяются по HMAC-подписи (`NOTIFICATIONS_TELEGRAM_WEBHOOK_SECRET`) и принимаются на `POST /api/v1/telegram/delivery`.

Telegram Bot. Отдельный сервис, обеспечивающий персональные уведомления продавцов и исполнителей, а также быстрые сценарии: создание сделки из чат-команды, запуск напоминаний, подтверждение ключевых этапов. Архитектура и чек-листы на реализацию — в [`docs/architecture/bot.md`](docs/architecture/bot.md).

Reports. FastAPI-сервис с материализованными витринами PostgreSQL: отдаёт агрегаты по сделкам и предоставляет CLI для обновления витрин (подробности в [`backend/reports/README.md`](backend/reports/README.md)).

Audit. Централизованный журнал действий пользователей и системных событий. Подробнее см. [`backend/audit/README.md`](backend/audit/README.md) и раздел [«Audit» технологического стека](docs/tech-stack.md#audit). Для подключения к RabbitMQ учтите разницу между именем exchange (`AUDIT_EVENTS_EXCHANGE`/`AUDIT_CORE_EXCHANGE`) и очередей (`AUDIT_EVENTS_QUEUE`/`AUDIT_CORE_QUEUE`): первое определяет точку публикации событий, второе — конкретные очереди, которые привязываются к exchange для чтения сервисом.

Backup. Резервное копирование баз, метаданных и файлового хранилища документов. Описание текущих скриптов и артефактов — в [`backups/README.md`](backups/README.md) и разделе [«Backup» технологического стека](docs/tech-stack.md#backup).

5. Хранение документов
Базовая схема каталогов на серверном файловом хранилище:

Клиент {ФИО или Наименование}/
  {Документы уровня клиента}.pdf
  Сделка {Краткое имя или ID}/
    Полис {Номер}/
      {Тип документа}_YYYYMMDD_{краткое описание}.pdf
Documents-сервис создаёт и поддерживает структуру каталогов внутри выделенного корня, выдаёт относительный путь и проверяет доступы. Документы уровня клиента (анкеты, доверенности, договоры на обслуживание и т.п.) хранятся прямо в корне папки клиента. Платёжные документы сохраняются в папках соответствующей сделки или полиса, без отдельной секции.

Метаданные (тип, относительный путь, автор, дата) сохраняются в БД Documents-сервиса.

Первоначально документы загружаются вручную пользователями через CRM.

### Варианты развёртывания хранилища на VPS
- **Локальный диск VPS** — каталоги создаются на файловой системе самого сервера; подходит для пилотного запуска и небольшой команды.
- **Подключённый volume (LVM, RAID, облачный диск)** — позволяет масштабировать объём и применять отдельные политики бэкапа.
- **Сетевое хранилище NFS/SFTP** — Documents подключает удалённый ресурс как точку монтирования, а управление доступами выполняется через системные ACL.
- **Self-hosted S3-совместимое хранилище (например, MinIO)** — сервис хранит документы в виде объектов, а в базе фиксируются ключи и версии; требуется шлюз доступа через S3 API.
- **Гибридные сценарии** — комбинация локального кэша и удалённого S3/NFS для балансировки скорости доступа и долговременного хранения.

6. Сквозной бизнес-процесс
Инициация сделки. Продавец создаёт клиента (если ещё не существует), заводит новую сделку и записывает в журнал ключевые параметры (например, пробег автомобиля, остаток долга). Возможна быстрая инициация через Telegram-бота: продавец в чате выбирает команду «Новая сделка», указывает клиента и ключевые параметры, после чего бот создаёт черновик сделки в CRM и ставит продавцу задачу дополнить данные. Независимо от канала создаётся папка сделки и складываются первичные документы. Назначается задача исполнителю на подготовку расчётов.

Работа по расчётам. Пользователь, ответственный за подготовку предложений, получает задачу и доступ к сделке и её папке, подготавливает расчёты в страховых компаниях, добавляет результаты и комментарии в сделку.

Выбор варианта. Ведущий пользователь обсуждает варианты с клиентом, фиксирует итоговое решение и ставит задачу на оформление выбранного полиса.

Оформление и оплата. Клиент оплачивает полис. Продавец или исполнитель, ведущий оформление, проверяет реквизиты и фиксирует факт оплаты в разделе платежей (при необходимости главный админ подтверждает операцию в журнале платежей). После подтверждения пользователь, ведущий оформление, завершает выпуск полиса и добавляет сканы в соответствующую папку.

Комиссия и расходы. Ответственный за сделку пользователь инициирует записи о комиссионных, скидках и выплатах, после чего суммы и статусы подтверждает главный админ или назначенный продавец/исполнитель с соответствующими правами. Учёт оплат ведётся в CRM/Deals: за него отвечает модуль платежей CRM вместо прежнего сервиса Payments.

*Примечание: распределение прав между продавцом, исполнителем и главным админом задаётся в RBAC-модели Auth; главный админ может делегировать подтверждение оплат и комиссий конкретным пользователям с операционными ролями.*

Мониторинг событий. CRM/Notifications настраивают напоминания о важных датах: следующем платеже, окончании срока полиса, потребности продления или других событиях. В первой поставке задачи обновляются вручную; автоматические SLA-переходы и триггеры уведомлений запланированы на [Этап 1.1](docs/delivery-plan.md#2-приоритизация-последующих-этапов). При наступлении события отправляются уведомления в CRM и через Telegram-бота, где продавец может подтвердить обработку или инициировать быструю сделку.

7. Нефункциональные требования (минимальный набор)
RBAC и аудит действий, особенно операций с платежами и документами.

Надёжное хранение данных: ежедневные бэкапы БД, дублирование ссылок на документы.

Базовая защита доступа к персональным данным без обязательного соответствия отраслевым регуляторам; действует упрощённая модель доступа (см. docs/security-and-access.md).

Гибкая система фильтрации и поиска по сделкам, полисам, платежам и документам.

Возможность расширять бизнес-процессы (например, добавлять повторяющиеся задачи для продлений).

8. Архитектура Telegram-бота

Бот реализован как отдельный сервис, подключённый к Notifications для доставки сообщений и к CRM/Deals для создания и обновления сделок. Основные компоненты:

- шлюз Telegram API, получающий команды и подтверждения от пользователей;
- обработчик сценариев, поддерживающий шаблоны быстрых сделок (инициация, уточнение параметров, подтверждение задач);
- очередь уведомлений, в которую Notifications публикует события (новые задачи, приближающиеся дедлайны, подтверждения оплат);
- модуль аутентификации, проверяющий привязку Telegram-аккаунта к пользователю CRM через Auth.

Схема взаимодействий фиксируется в разделе `docs/architecture/bot.md` (будет обновляться по мере детализации).
