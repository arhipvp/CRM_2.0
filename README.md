1. Общее представление
CRM предназначена для небольшой команды страховых агентов, которые ведут клиентов по долгосрочным страховым сделкам. Система концентрирует данные о клиентах, сделках, полисах, платежах и связанных документах, распределяет задачи между продавцами и исполнителями и обеспечивает контроль по ключевым событиям. Архитектурный черновик уже выделяет целевые сервисы (Gateway, Auth, CRM/Deals, Payments, Documents, Tasks, Notifications, Reports, Audit, Backup) — ниже зафиксированы их бизнес-требования и взаимосвязи.

2. Пользовательские роли
Система использует упрощённую модель прав: у каждой роли один уровень разрешений на свои зоны ответственности. Если роль имеет
доступ к сущности, то она может просматривать и изменять данные в рамках назначенных ей клиентов и сделок; дополнительных уровней
«только чтение» или «расширенный доступ» нет.

- **Администратор** — управляет пользователями, системными справочниками и может просматривать любые сущности для аудита.
- **Продавец (агент)** — инициирует сделки, ведёт коммуникацию с клиентом, управляет журналом сделки и связанными расходами в своих
  сделках.
- **Исполнитель** — готовит расчёты, оформляет полисы и поддерживает документооборот в сделках, где назначен.
- **Финансовый менеджер** — фиксирует и подтверждает платежи, контролирует комиссионные и выплаты исполнителям по всем сделкам.
- **Руководитель** — наблюдает за воронкой продаж, отчётами и ключевыми метриками без права менять операционные данные.

3. Основные сущности
Клиент. Физическое или юридическое лицо. Атрибуты: реквизиты, контакты, одно или несколько контактных лиц, сегмент, статус (потенциальный, активный, неактивный). У клиента может быть множество сделок.

Сделка. Объединяет страховые потребности клиента по одному объекту или группе объектов. Содержит:

описание объекта страхования (например, автомобиль, парк ТС, ипотечное имущество);

участников (продавец, исполнитель, дополнительные роли);

журнал текстовых заметок (пробег авто, остаток долга и т.п.);

расчёты по страховым компаниям;

набор полисов;

привязанные задачи и документы (структура папок описана в разделе 5).

Расчёт. Результат обращения к страховой компании. Атрибуты: компания, программа, условия, тарифы, дата расчёта, комментарии, файлы. Хранится история изменений.

Полис. Конкретный договор страхования (обычно на 1 год). Атрибуты: номер, страхователь, программа, период действия, страховая сумма, премия, статус (черновик, действует, ожидает продления, закрыт). Привязан к сделке и клиенту.

Платёж. Любое движение денег, связанное с конкретным полисом (каждая запись обязана ссылаться ровно на один полис, распределение суммы между несколькими полисами не допускается):

премия клиента (оплата полиса);

полученная комиссия продавца;

скидка клиенту (из комиссии);

выплата исполнителю (из комиссии).
Атрибуты: сумма, валюта, даты плановая и фактическая, статус (запланирован, ожидается, получен, выплачен), связанный полис и сделка. Частичные оплаты и возвраты не фиксируются: при корректировках редактируется исходная запись. Интеграции с банками/бухгалтерией не требуются: ввод ручной или через импорт файлов пользователей.

Документ. Ссылка на файл в Google Drive. Типы: расчёт, заявление, договор, полис, акт, чек, переписка. Метаданные: владельцы (сделка/полис/платёж), дата загрузки, автор, заметки. Генерация документов не требуется — только хранение и структурирование.

Задача. Назначение для продавца или исполнителя. Атрибуты: связанная сделка/полис/платёж, описание, срок, приоритет, напоминания, статус выполнения.

4. Ответственность сервисов
Gateway/BFF. Общая точка входа для фронтенда, управление сессиями, маршрутизация запросов к сервисам, агрегация данных.

Auth. Управление пользователями, ролями и доступами к сделкам/документам (включая разграничение просмотра папок Google Drive).

CRM/Deals. Владеет клиентами, сделками, расчётами, полисами, журналами сделок, задачами, уведомлениями о ключевых событиях.

Payments. Учёт всех типов платежей, план-факт анализ, контроль комиссий и выплат.

Documents. Связывает сделки и полисы с папками Google Drive, хранит метаданные файлов, управляет доступами. Генерации документов нет.

Tasks. Планирование и исполнение задач, напоминания исполнителям и продавцам.

Notifications. Отправка уведомлений по событиям (Telegram, внутренние уведомления CRM).

Reports. На старте доступна только базовая заглушка/отложенный сервис без развитой аналитики; развитие функций планируется позднее.

Audit. Централизованный журнал действий пользователей и системных событий.

Backup. Резервное копирование баз и метаданных (документы хранятся на Google Drive).

5. Хранение документов
Базовая схема папок на Google Drive:

Клиент {ФИО или Наименование}/
  {Документы уровня клиента}.pdf
  Сделка {Краткое имя или ID}/
    Полис {Номер}/
      {Тип документа}_YYYYMMDD_{краткое описание}.pdf
Documents-сервис создаёт и поддерживает структуру папок, выдаёт ссылку, проверяет доступы. Документы уровня клиента (анкеты,
доверенности, договора на обслуживание и т.п.) хранятся прямо в корне папки клиента. Платёжные документы сохраняются в папках
соответствующей сделки или полиса, без отдельной секции.

Метаданные (тип, ссылка, автор, дата) сохраняются в БД Documents-сервиса.

Первоначально документы загружаются вручную пользователями через CRM.

6. Сквозной бизнес-процесс
Инициация сделки. Продавец создаёт клиента (если ещё не существует), заводит новую сделку, записывает в журнал ключевые параметры (например, пробег автомобиля, остаток долга). Создаёт папку сделки и складывает первичные документы. Назначает исполнителю задачу на подготовку расчётов.

Работа исполнителя. Исполнитель получает задачу и доступ к сделке и её папке, подготавливает расчёты в страховых компаниях, добавляет результаты и комментарии в сделку.

Выбор варианта. Продавец обсуждает варианты с клиентом, фиксирует итоговое решение и ставит исполнителю задачу на оформление выбранного полиса.

Оформление и оплата. Клиент оплачивает полис. Финансовый менеджер проверяет реквизиты и фиксирует факт оплаты в разделе платежей. После подтверждения исполнитель завершает оформление: выпускает полис в карточке сделки и добавляет сканы в соответствующую папку.

Комиссия и расходы. Продавец инициирует записи о комиссионных, скидках и выплатах исполнителю, а финансовый менеджер подтверждает суммы и статусы. Сервис Payments отслеживает состояние всех связанных платежей.

Мониторинг событий. CRM/Notifications настраивают напоминания о важных датах: следующем платеже, окончании срока полиса, потребности продления или других событиях. Задачи обновляются автоматически, при наступлении события отправляются уведомления.

7. Нефункциональные требования (минимальный набор)
RBAC и аудит действий, особенно операций с платежами и документами.

Надёжное хранение данных: ежедневные бэкапы БД, дублирование ссылок на документы.

Базовая защита доступа к персональным данным без специальных регуляторных требований; действует упрощённая модель доступа (см. docs/security-and-access.md).

Гибкая система фильтрации и поиска по сделкам, полисам, платежам и документам.

Возможность расширять бизнес-процессы (например, добавлять повторяющиеся задачи для продлений).