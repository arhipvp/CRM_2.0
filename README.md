**Быстрая навигация:** [План поставки](docs/delivery-plan.md), [Архитектура](docs/architecture.md#1-общая-структура-сервисов), [Инфраструктура](docs/tech-stack.md#инфраструктура), [Интеграции](docs/tech-stack.md#интеграции), [UX-документация фронтенда](docs/frontend/README.md), [Локальная настройка](docs/local-setup.md)

1. Общее представление
CRM предназначена для небольшой команды страховых агентов, которые ведут клиентов по долгосрочным страховым сделкам. Система концентрирует данные о клиентах, сделках, полисах, платежах и связанных документах, распределяет задачи между пользователями и обеспечивает контроль по ключевым событиям. Архитектурный черновик уже выделяет целевые сервисы (Gateway, Auth, CRM/Deals, Payments, Documents, Tasks, Notifications, Reports, Audit, Backup) — ниже зафиксированы их бизнес-требования и взаимосвязи. Состав первой поставки и критерии готовности описаны в документе [`docs/delivery-plan.md`](docs/delivery-plan.md). Подробные спецификации REST/SSE интерфейсов находятся в каталоге [`docs/api`](docs/api/README.md), а форматы интеграционных событий зафиксированы в [`docs/integration-events.md`](docs/integration-events.md).

**Технологический стек и базовые архитектурные принципы** собраны в документе [`docs/tech-stack.md`](docs/tech-stack.md), который служит основой для детальных спецификаций сервисов и инфраструктуры.

### Структура репозитория
- [`docs/local-setup.md`](docs/local-setup.md) — карта сервисов с портами и ссылками на инструкции запуска.
- Backend:
  - [`backend/gateway/README.md`](backend/gateway/README.md) — запуск BFF/Gateway.【F:backend/gateway/README.md†L1-L34】
  - [`backend/auth/README.md`](backend/auth/README.md) — конфигурация Auth и миграции Liquibase.【F:backend/auth/README.md†L1-L30】
  - [`backend/crm/README.md`](backend/crm/README.md) — инструкции для CRM/Deals и Celery.【F:backend/crm/README.md†L1-L32】
  - [`backend/payments/README.md`](backend/payments/README.md) — запуск Spring Boot Payments и Flyway.【F:backend/payments/README.md†L1-L28】
  - [`backend/documents/README.md`](backend/documents/README.md) — NestJS-сервис для Google Drive и BullMQ.【F:backend/documents/README.md†L1-L30】
  - [`backend/notifications/README.md`](backend/notifications/README.md) — SSE, очереди и отправка уведомлений.【F:backend/notifications/README.md†L1-L30】
  - [`backend/tasks/README.md`](backend/tasks/README.md) — обработка задач и отложенных событий.【F:backend/tasks/README.md†L1-L30】
  - [`backend/reports/README.md`](backend/reports/README.md) — текущее состояние отчётного сервиса и временная заглушка.【F:backend/reports/README.md†L1-L28】
  - [`backend/audit/README.md`](backend/audit/README.md) — журналирование и агрегаты для аналитики.【F:backend/audit/README.md†L1-L30】
- Frontend: [`frontend/README.md`](frontend/README.md) — запуск Next.js и тестовые профили.【F:frontend/README.md†L1-L36】
## Запуск окружения разработки

Пошаговая инструкция по подготовке `.env`, запуску инфраструктурных контейнеров и проверке доступности сервисов доступна в разделе [`docs/local-setup.md`](docs/local-setup.md). Там же уточняется, что Docker Compose создаёт пользователя и виртуальный хост RabbitMQ `crm`, а базовый `RABBITMQ_URL` и `CRM_RABBITMQ_URL` в `.env` уже указывают на них.

2. Пользовательские роли
Система использует одноуровневую модель доступа с пятью ролевыми типами. Если у роли есть доступ к сущности, то она может просматривать и изменять данные в рамках закреплённых за ней клиентов и сделок; дополнительных уровней «только чтение» или «расширенный доступ» нет для операционных ролей.

- **Администратор** — управляет пользователями, системными справочниками и имеет полный доступ ко всем сущностям для администрирования и аудита.
- **Продавец (агент)** — инициирует сделки, ведёт коммуникацию с клиентом, управляет журналом сделки, полисами, документами и расходами в своих сделках.
- **Исполнитель** — готовит расчёты, оформляет полисы и поддерживает документооборот в сделках, где назначен, с правом вносить изменения в назначенных сущностях.
- **Финансовый менеджер** — фиксирует и подтверждает платежи, контролирует комиссионные и выплаты исполнителям по всем сделкам с правом редактирования финансовых записей.
- **Руководитель** — наблюдает за воронкой продаж и базовыми отчётами (по мере появления), располагая просмотром всех сущностей без права менять операционные данные.

3. Основные сущности
Клиент. Физическое или юридическое лицо. Атрибуты: реквизиты, контакты, одно или несколько контактных лиц, сегмент, статус (потенциальный, активный, неактивный). У клиента может быть множество сделок.

Сделка. Объединяет страховые потребности клиента по одному объекту или группе объектов. Содержит:

описание объекта страхования (например, автомобиль, парк ТС, ипотечное имущество);

участников (ведущий пользователь, дополнительные участники);

журнал текстовых заметок (пробег авто, остаток долга и т.п.);

расчёты по страховым компаниям;

набор полисов;

привязанные задачи и документы (структура папок описана в разделе 5).

Расчёт. Результат обращения к страховой компании. Атрибуты: компания, программа, условия, тарифы, дата расчёта, комментарии, файлы. Хранится история изменений.

Полис. Конкретный договор страхования (обычно на 1 год). Атрибуты: номер, страхователь, программа, период действия, страховая сумма, премия, статус (черновик, действует, ожидает продления, закрыт). Привязан к сделке и клиенту.

Платёж. Любое движение денег, связанное с конкретным полисом (каждая запись обязана ссылаться ровно на один полис, распределение суммы между несколькими полисами не допускается):

премия клиента (оплата полиса);

полученная комиссия команды;

скидка клиенту (из комиссии);

выплата коллегам (из комиссии).
Атрибуты: сумма, валюта, даты плановая и фактическая, статус (запланирован, ожидается, получен, выплачен), связанный полис и сделка. Частичные оплаты и возвраты не фиксируются: при корректировках редактируется исходная запись. Интеграции с банками/бухгалтерией не требуются: ввод ручной или через импорт файлов пользователей.

Документ. Ссылка на файл в Google Drive. Типы: расчёт, заявление, договор, полис, акт, чек, переписка. Метаданные: владельцы (сделка/полис/платёж), дата загрузки, автор, заметки. Генерация документов не требуется — только хранение и структурирование.

Задача. Назначение для пользователя. Атрибуты: связанная сделка/полис/платёж, описание, срок, приоритет, напоминания, статус выполнения.

4. Ответственность сервисов

Развёрнутые обязанности и взаимодействия приводятся в документе [«Архитектурный обзор»](docs/architecture.md#2-взаимодействия-и-потоки-данных); ниже — краткое резюме доменов.
Gateway/BFF. Общая точка входа для фронтенда, управление сессиями, маршрутизация запросов к сервисам, агрегация данных (подробнее см. раздел [«Фронтенд» технологического стека](docs/tech-stack.md#фронтенд)). Фронтенд использует REST API шлюза и SSE-каналы для изменений сделок и уведомлений.

Auth. Управление пользователями, ролями и доступами к сделкам/документам (включая разграничение просмотра папок Google Drive).

CRM/Deals. Владеет клиентами, сделками, расчётами, полисами, журналами сделок, задачами, уведомлениями о ключевых событиях.

Payments. Учёт всех типов платежей, план-факт анализ, контроль комиссий и выплат.

Documents. Связывает сделки и полисы с папками Google Drive, хранит метаданные файлов, управляет доступами. Генерации документов нет.

Tasks. Планирование и исполнение задач, напоминания назначенным пользователям. Подробнее см. раздел [«Tasks» технологического стека](docs/tech-stack.md#tasks).

Notifications. Отправка уведомлений по событиям (Telegram, внутренние SSE-уведомления CRM), интеграция с ботом для доставки и подтверждений. Подробнее см. раздел [«Notifications» технологического стека](docs/tech-stack.md#notifications).

Telegram Bot. Отдельный сервис, обеспечивающий персональные уведомления продавцов и исполнителей, а также быстрые сценарии: создание сделки из чат-команды, запуск напоминаний, подтверждение ключевых этапов.

Reports (отложено). На старте доступна только заглушка без развитой аналитики; расширение функций и метрик планируется позднее.

Audit. Централизованный журнал действий пользователей и системных событий. Подробнее см. раздел [«Audit» технологического стека](docs/tech-stack.md#audit).

Backup. Резервное копирование баз и метаданных (документы хранятся на Google Drive). Подробнее см. раздел [«Backup» технологического стека](docs/tech-stack.md#backup).

5. Хранение документов
Базовая схема папок на Google Drive:

Клиент {ФИО или Наименование}/
  {Документы уровня клиента}.pdf
  Сделка {Краткое имя или ID}/
    Полис {Номер}/
      {Тип документа}_YYYYMMDD_{краткое описание}.pdf
Documents-сервис создаёт и поддерживает структуру папок, выдаёт ссылку, проверяет доступы. Документы уровня клиента (анкеты,
доверенности, договора на обслуживание и т.п.) хранятся прямо в корне папки клиента. Платёжные документы сохраняются в папках
соответствующей сделки или полиса, без отдельной секции.

Метаданные (тип, ссылка, автор, дата) сохраняются в БД Documents-сервиса.

Первоначально документы загружаются вручную пользователями через CRM.

6. Сквозной бизнес-процесс
Инициация сделки. Продавец создаёт клиента (если ещё не существует), заводит новую сделку и записывает в журнал ключевые параметры (например, пробег автомобиля, остаток долга). Возможна быстрая инициация через Telegram-бота: продавец в чате выбирает команду «Новая сделка», указывает клиента и ключевые параметры, после чего бот создаёт черновик сделки в CRM и ставит продавцу задачу дополнить данные. Независимо от канала создаётся папка сделки и складываются первичные документы. Назначается задача исполнителю на подготовку расчётов.

Работа по расчётам. Пользователь, ответственный за подготовку предложений, получает задачу и доступ к сделке и её папке, подготавливает расчёты в страховых компаниях, добавляет результаты и комментарии в сделку.

Выбор варианта. Ведущий пользователь обсуждает варианты с клиентом, фиксирует итоговое решение и ставит задачу на оформление выбранного полиса.

Оформление и оплата. Клиент оплачивает полис. Назначенный пользователь по финансовому направлению проверяет реквизиты и фиксирует факт оплаты в разделе платежей. После подтверждения пользователь, ведущий оформление, завершает выпуск полиса и добавляет сканы в соответствующую папку.

Комиссия и расходы. Ответственный за сделку пользователь инициирует записи о комиссионных, скидках и выплатах, а коллега, ведущий финансовый контроль, подтверждает суммы и статусы. Сервис Payments отслеживает состояние всех связанных платежей.

Мониторинг событий. CRM/Notifications настраивают напоминания о важных датах: следующем платеже, окончании срока полиса, потребности продления или других событиях. Задачи обновляются автоматически, при наступлении события отправляются уведомления в CRM и через Telegram-бота, где продавец может подтвердить обработку или инициировать быструю сделку.

7. Нефункциональные требования (минимальный набор)
RBAC и аудит действий, особенно операций с платежами и документами.

Надёжное хранение данных: ежедневные бэкапы БД, дублирование ссылок на документы.

Базовая защита доступа к персональным данным без обязательного соответствия отраслевым регуляторам; действует упрощённая модель доступа (см. docs/security-and-access.md).

Гибкая система фильтрации и поиска по сделкам, полисам, платежам и документам.

Возможность расширять бизнес-процессы (например, добавлять повторяющиеся задачи для продлений).

8. Архитектура Telegram-бота

Бот реализован как отдельный сервис, подключённый к Notifications для доставки сообщений и к CRM/Deals для создания и обновления сделок. Основные компоненты:

- шлюз Telegram API, получающий команды и подтверждения от пользователей;
- обработчик сценариев, поддерживающий шаблоны быстрых сделок (инициация, уточнение параметров, подтверждение задач);
- очередь уведомлений, в которую Notifications публикует события (новые задачи, приближающиеся дедлайны, статусы платежей);
- модуль аутентификации, проверяющий привязку Telegram-аккаунта к пользователю CRM через Auth.

Схема взаимодействий фиксируется в разделе `docs/architecture/bot.md` (будет обновляться по мере детализации).
