# Базовые переменные окружения для локального запуска.
# GitHub Actions удалены из репозитория, поэтому автоматические пайплайны недоступны;
# значения ниже помогают воспроизводить шаги вручную или в стороннем CI.

# --- Общие переменные окружения ---
TIMEZONE=Europe/Moscow

# Пути для журналов вспомогательных скриптов (можно переопределить при необходимости).
# DEV_UP_LOG_FILE=.local/logs/dev-up.log
# START_BACKEND_LOG_FILE=.local/run/backend/start-backend.log

# --- Настройки Docker-инфраструктуры ---
POSTGRES_HOST=localhost
POSTGRES_PORT=5432                               # Порт PostgreSQL на хосте; внутри docker-compose сервис слушает 5432
# POSTGRES_PORT — порт, который будет проброшен на хост. Меняйте его, если 5432 занят.
# POSTGRES_CONTAINER_PORT — внутренний порт кластера PostgreSQL в Docker. Оставьте 5432,
# чтобы сервисы внутри compose всегда подключались к контейнеру.
POSTGRES_CONTAINER_PORT=5432
POSTGRES_HOST_INTERNAL=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=crm
AUTH_DB_USER=auth
AUTH_DB_PASSWORD=auth
CRM_DB_USER=crm
CRM_DB_PASSWORD=crm
DOCUMENTS_DB_USER=documents
DOCUMENTS_DB_PASSWORD=documents
REPORTS_DB_USER=reports
REPORTS_DB_PASSWORD=reports
BACKUP_DB_USER=backup
BACKUP_DB_PASSWORD=backup

RABBITMQ_HOST=localhost
RABBITMQ_PORT=5672
RABBITMQ_MANAGEMENT_PORT=15672
RABBITMQ_HOST_INTERNAL=rabbitmq
RABBITMQ_DEFAULT_USER=crm
RABBITMQ_DEFAULT_PASS=crm
RABBITMQ_DEFAULT_VHOST=crm
# Скрипт infra/rabbitmq/bootstrap.sh использует *_RABBITMQ_URL и *_RABBITMQ_URI как единый источник
# и пропускает записи без корректных пользователя/vhost, выводя предупреждение.
# Это устраняет двусмысленность при настройке сервисов — обе формы переменных приводят к одному списку пользователей.
# правды для пользователей и vhost-ов. При добавлении сервисов обновляйте список
# переменных ниже — скрипт автоматически создаст соответствующие объекты.
# Значения выше соответствуют дефолтному пользователю/vhost `crm`, который создаётся Docker Compose.
# Для сервисов с собственными правами указывайте URL вида `SERVICE_RABBITMQ_URL=amqp://user:pass@host:port/vhost` (см. примеры ниже).

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_HOST_INTERNAL=redis

CONSUL_HTTP_PORT=8500
CONSUL_GRPC_PORT=8502
CONSUL_DNS_PORT=8600
CONSUL_HOST=localhost
CONSUL_HOST_INTERNAL=consul

PGADMIN_PORT=5050
PGADMIN_DEFAULT_EMAIL=admin@crm.example
PGADMIN_DEFAULT_PASSWORD=admin

# --- URL подключения приложений ---
# PostgreSQL (единый кластер, отдельные схемы на сервис)
# См. docs/tech-stack.md → «Инфраструктура» → «Базы данных»
# Используйте DATABASE_URL для административных задач (миграции, bootstrap данных)
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/crm
# Auth работает через R2DBC и указывает схему `auth` параметром `schema` (допустим `search_path`)
# Значение `localhost` подходит только для запуска Auth на хостовой машине; внутри контейнеров
# подставляйте сетевое имя PostgreSQL (например, `postgres`) или `host.docker.internal` для доступа к хосту.
# CRM читает `search_path` из query-параметра и прокидывает его в `server_settings` asyncpg.
AUTH_DATABASE_URL=r2dbc:postgresql://auth:auth@localhost:5432/crm?schema=auth
CRM_DATABASE_URL=postgresql://crm:crm@localhost:5432/crm?search_path=crm
DOCUMENTS_DATABASE_URL=postgresql://documents:documents@localhost:5432/crm?search_path=documents
DOCUMENTS_DATABASE_SCHEMA=documents                         # Имя схемы PostgreSQL для сервиса документов
DOCUMENTS_RUN_MIGRATIONS=false                               # true — применять миграции TypeORM при старте API/воркера
REPORTS_DATABASE_URL=postgresql://reports:reports@localhost:5432/crm?search_path=reports
REPORTS_SCHEMA=reports
REPORTS_CRM_SCHEMA=crm
# Отчётный сервис агрегирует данные из CRM; при необходимости добавьте дополнительные схемы через REPORTS_SOURCE_SCHEMAS.
REPORTS_SOURCE_SCHEMAS=crm
BACKUP_DATABASE_URL=postgresql://backup:backup@localhost:5432/crm?search_path=backup
BACKUP_SERVICE_PORT=8094
BACKUP_TIMEZONE=Europe/Moscow
BACKUP_POSTGRES_BACKUP_DSN=postgresql://postgres:postgres@localhost:5432/crm
# --- Внутренние адреса для docker compose ---
# Значения по умолчанию используют сетевые имена контейнеров (`postgres`, `rabbitmq`,
# `redis`, `consul`). Переопределяйте переменные с суффиксом `_INTERNAL`, если меняете
# названия сервисов в docker compose или подключаете контейнеры к внешним инстансам.
# Для запуска сервисов на хосте продолжайте использовать переменные без суффикса —
# они ориентированы на `localhost`.
DATABASE_URL_INTERNAL=postgresql://postgres:postgres@postgres:5432/crm
AUTH_DATABASE_URL_INTERNAL=r2dbc:postgresql://auth:auth@postgres:5432/crm?schema=auth
CRM_DATABASE_URL_INTERNAL=postgresql://crm:crm@postgres:5432/crm?search_path=crm
DOCUMENTS_DATABASE_URL_INTERNAL=postgresql://documents:documents@postgres:5432/crm?search_path=documents
REPORTS_DATABASE_URL_INTERNAL=postgresql://reports:reports@postgres:5432/crm?search_path=reports
BACKUP_INTERNAL_DATABASE_URL=postgresql://backup:backup@postgres:5432/crm?search_path=backup
BACKUP_INTERNAL_POSTGRES_BACKUP_DSN=postgresql://postgres:postgres@postgres:5432/crm
BACKUP_INTERNAL_CONSUL_HTTP_ADDR=http://consul:8500
BACKUP_INTERNAL_REDIS_HOST=redis
RABBITMQ_URL_INTERNAL=amqp://crm:crm@rabbitmq:5672/crm
CRM_RABBITMQ_INTERNAL_URL=amqp://crm:crm@rabbitmq:5672/crm
BACKUP_RABBITMQ_INTERNAL_URL=amqp://crm:crm@rabbitmq:5672/crm
BACKUP_RABBITMQ_INTERNAL_MANAGEMENT_URL=http://rabbitmq:15672
REDIS_URL_INTERNAL=redis://redis:6379/0
REDIS_CACHE_URL_INTERNAL=redis://redis:6379/1
REDIS_CELERY_URL_INTERNAL=redis://redis:6379/2
REDIS_BULLMQ_URL_INTERNAL=redis://redis:6379/3
REDIS_RATE_LIMIT_URL_INTERNAL=redis://redis:6379/4
AUTH_REDIS_URL_INTERNAL=redis://redis:6379/5
CRM_REDIS_URL_INTERNAL=redis://redis:6379/2
CRM_PERMISSIONS_REDIS_URL_INTERNAL=redis://redis:6379/3
CRM_CELERY_BROKER_URL_INTERNAL=redis://redis:6379/2
CRM_CELERY_RESULT_BACKEND_INTERNAL=redis://redis:6379/2
DOCUMENTS_REDIS_URL_INTERNAL=redis://redis:6379/3
TELEGRAM_BOT_REDIS_URL_INTERNAL=redis://redis:6379/6
CONSUL_HTTP_ADDR_INTERNAL=http://consul:8500
CONSUL_GRPC_ADDR_INTERNAL=consul:8502
CONSUL_DNS_ADDR_INTERNAL=consul:8600
# Для отключения S3 и использования DummyStorage удалите переменные ниже или оставьте пустыми (см. backend/backup/README.md).
# Не подставляйте пробелы вместо значения — они будут отброшены и endpoint не будет передан в клиент.
# Указывайте endpoint как URL, начинающийся с http:// или https://, без пробелов в начале и конце строки.
# Пример: BACKUP_S3_ENDPOINT_URL=https://storage.local
BACKUP_S3_ENDPOINT_URL=
# Пустое значение заменится на регион по умолчанию (us-east-1)
BACKUP_S3_REGION_NAME=
BACKUP_S3_BUCKET=
BACKUP_S3_ACCESS_KEY=
BACKUP_S3_SECRET_KEY=
BACKUP_ARTIFACTS_DIR=/tmp/backup-artifacts
# RabbitMQ для сервиса резервного копирования: URL на хосте (localhost).
# Внутреннее значение задаётся переменной BACKUP_RABBITMQ_INTERNAL_URL (см. блок выше).
BACKUP_RABBITMQ_URL=amqp://crm:crm@localhost:5672/crm
BACKUP_NOTIFICATION_EXCHANGE=backup.notifications

BACKUP_NOTIFICATION_ROUTING_KEY=jobs
BACKUP_RABBITMQ_MANAGEMENT_URL=http://localhost:15672
BACKUP_RABBITMQ_ADMIN_USER=crm
BACKUP_RABBITMQ_ADMIN_PASSWORD=crm
BACKUP_RABBITMQ_VHOST=crm
BACKUP_CONSUL_HTTP_ADDR=http://localhost:8500
BACKUP_CONSUL_TOKEN=
BACKUP_REDIS_HOST=localhost
BACKUP_REDIS_PORT=6379
BACKUP_REDIS_PASSWORD=
BACKUP_REDIS_DATA_DIR=/var/lib/redis

# Базовый URL использует пользователя CRM и vhost `crm`, поэтому подходит сервисам без собственного vhost.
# Индивидуальные URL ниже требуют, чтобы соответствующие пользователи и vhost-ы были созданы заранее (см. docs/local-setup.md#создайте-пользователей-и-vhost-ы-rabbitmq-для-сервисов).
RABBITMQ_URL=amqp://crm:crm@localhost:5672/crm
CRM_RABBITMQ_URL=amqp://crm:crm@localhost:5672/crm                            # CRM публикует события во vhost `crm`; переопределите при другом пользователе
RABBITMQ_MANAGEMENT_URL=http://localhost:15672

# Настройки событий и очередей задач CRM

CRM_TASKS_EVENTS_EXCHANGE=tasks.events
CRM_TASKS_EVENTS_SOURCE=crm.tasks
CRM_TASKS_EVENTS_ROUTING_KEYS__TASK_CREATED=task.created
CRM_TASKS_EVENTS_ROUTING_KEYS__TASK_STATUS_CHANGED=task.status.changed
CRM_TASKS_EVENTS_ROUTING_KEYS__TASK_REMINDER=task.reminder
CRM_TASKS_REMINDERS_QUEUE_KEY=tasks:reminders
CRM_TASKS_REMINDERS_POLL_INTERVAL_MS=5000
CRM_TASKS_SCHEDULING_BATCH_SIZE=100
CRM_TASKS_DELAYED_QUEUE_KEY=tasks:delayed

# Настройки уведомлений CRM
CRM_NOTIFICATIONS_DISPATCH_EXCHANGE=notifications.exchange
CRM_NOTIFICATIONS_DISPATCH_ROUTING_KEY=notifications.dispatch
CRM_NOTIFICATIONS_DISPATCH_REDIS_CHANNEL=notifications:dispatch
CRM_NOTIFICATIONS_DISPATCH_RETRY_ATTEMPTS=3
CRM_NOTIFICATIONS_DISPATCH_RETRY_DELAY_MS=60000
CRM_NOTIFICATIONS_QUEUE_NAME=notifications.events
CRM_NOTIFICATIONS_QUEUE_ROUTING_KEY=notifications.*
CRM_NOTIFICATIONS_QUEUE_DURABLE=true
CRM_NOTIFICATIONS_SSE_RETRY_MS=5000
CRM_NOTIFICATIONS_TEMPLATES_DEFAULT_LOCALE=ru-RU
CRM_NOTIFICATIONS_TELEGRAM_ENABLED=false
CRM_NOTIFICATIONS_TELEGRAM_MOCK=true
CRM_NOTIFICATIONS_TELEGRAM_BOT_TOKEN=
CRM_NOTIFICATIONS_TELEGRAM_DEFAULT_CHAT_ID=

# Redis (сессии, кеши, фоновые очереди)
# См. docs/tech-stack.md → «Инфраструктура» → «Брокеры сообщений и кэши»
REDIS_URL=redis://localhost:6379/0
REDIS_CACHE_URL=redis://localhost:6379/1
REDIS_CELERY_URL=redis://localhost:6379/2
REDIS_BULLMQ_URL=redis://localhost:6379/3
REDIS_RATE_LIMIT_URL=redis://localhost:6379/4
REDIS_KEY_PREFIX=gateway
REDIS_CACHE_TTL=300
REDIS_HEARTBEAT_PREFIX=gateway:sse

# Consul (service discovery и конфигурация)
# См. docs/tech-stack.md → «Инфраструктура» → «Service discovery»
CONSUL_HTTP_ADDR=http://localhost:8500
CONSUL_GRPC_ADDR=127.0.0.1:8502
CONSUL_DNS_ADDR=127.0.0.1:8600
CONSUL_ENABLED=true
CONSUL_HTTP_TIMEOUT=5000

# --- Безопасность и аутентификация ---
JWT_ACCESS_SECRET=change_me_access_secret
JWT_REFRESH_SECRET=change_me_refresh_secret
JWT_ISSUER=crm.local
JWT_AUDIENCE=crm.clients
SESSION_SECRET=change_me_session_secret

# --- Почтовые уведомления ---
# В локальной среде сервис отправки e-mail не используется.

# Порты и базовые URL сервисов (локальный запуск)
# Ссылки на логику переменных указаны в README соответствующих сервисов и в docs/local-setup.md
GATEWAY_SERVICE_PORT=8080                                  # См. backend/gateway/README.md
GATEWAY_SERVICE_HOST=0.0.0.0                               # Хост прослушивания Gateway (локально оставьте 0.0.0.0)
GATEWAY_BASE_URL=http://localhost:8080/api
BACKUP_BASE_URL=http://localhost:8094
GATEWAY_UPSTREAM_TIMEOUT=5000
GATEWAY_UPSTREAM_SSE_RECONNECT_DELAY=3000
GATEWAY_UPSTREAM_SSE_HEARTBEAT_INTERVAL=15000
GATEWAY_UPSTREAM_SSE_HEARTBEAT_TTL=60
AUTH_SERVICE_PORT=8081                                     # См. backend/auth/README.md
AUTH_BASE_URL=http://localhost:8081
AUTH_REDIS_URL=redis://localhost:6379/5
AUTH_JWT_ISSUER=http://localhost:8081
AUTH_JWT_SECRET=change_me                                   # Замените на случайное значение для локальной разработки
AUTH_JWT_AUDIENCE=crm-clients
AUTH_ACCESS_TOKEN_TTL=PT15M                                 # ISO-8601 длительность (15 минут)
AUTH_REFRESH_TOKEN_TTL=P7D                                  # ISO-8601 длительность (7 дней, формат «PnDTnHnM» без префикса PT для дней)
AUTH_BOOTSTRAP_ENABLED=false
AUTH_BOOTSTRAP_EMAIL=admin@crm.example
AUTH_BOOTSTRAP_PASSWORD=ChangeMePlease123!
AUTH_BOOTSTRAP_ROLES=ROLE_ADMIN,ROLE_USER
CRM_SERVICE_HOST=0.0.0.0                                   # Хост, на котором FastAPI слушает (переопределите при необходимости)
CRM_SERVICE_PORT=8082                                      # См. backend/crm/README.md
CRM_BASE_URL=http://localhost:8082
CRM_REDIS_URL=redis://localhost:6379/2
CRM_EVENTS_EXCHANGE=crm.events
CRM_JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}                       # Секрет подписи access-токена CRM
CRM_JWT_ISSUER=${JWT_ISSUER}                                   # Должен совпадать с AUTH_JWT_ISSUER
CRM_JWT_AUDIENCE=${JWT_AUDIENCE}                               # Должен совпадать с AUTH_JWT_AUDIENCE
CRM_AUTH_DISABLED=false                                        # Включите true для обхода проверок токена (только для разработки)
CRM_CELERY_BROKER_URL=redis://localhost:6379/2
CRM_CELERY_RESULT_BACKEND=redis://localhost:6379/2
CRM_CELERY_RETRY_DELAY_SECONDS=60
CRM_DOCUMENTS_BASE_URL=http://localhost:8084/documents      # Обязательный базовый URL API сервиса Documents; используется для метаданных и проверки связей
# BullMQ очередь синхронизации прав документов
CRM_PERMISSIONS_QUEUE_NAME=permissions:sync
CRM_PERMISSIONS_QUEUE_PREFIX=bull
CRM_PERMISSIONS_JOB_NAME=permissions.sync
CRM_PERMISSIONS_REDIS_URL=redis://localhost:6379/2
DOCUMENTS_SERVICE_PORT=8084                                # См. backend/documents/README.md
DOCUMENTS_BASE_URL=http://localhost:8084
DOCUMENTS_REDIS_URL=redis://localhost:6379/3
DOCUMENTS_REDIS_PREFIX=documents                              # Префикс ключей BullMQ в Redis
DOCUMENTS_PERMISSIONS_SYNC_QUEUE_NAME=documents.permissions.sync # Очередь BullMQ синхронизации прав папок
DOCUMENTS_PERMISSIONS_SYNC_JOB_TTL=300                        # TTL задания синхронизации прав (секунды)
DOCUMENTS_QUEUE_NAME=documents:tasks                           # Имя очереди BullMQ (job names: documents.upload/documents.sync)
DOCUMENTS_STORAGE_DRIVER=local                                 # Драйвер файлового хранилища (local, s3 и т.п.)
DOCUMENTS_STORAGE_ROOT=/var/lib/crm/documents                  # Абсолютный путь к корневому каталогу документов
DOCUMENTS_STORAGE_USER=crm-docs                                # Системный пользователь-владелец каталога
DOCUMENTS_STORAGE_GROUP=crm-sales                              # Основная группа, применяемая к каталогу
DOCUMENTS_STORAGE_DEFAULT_MODE=0770                            # Маска прав для создаваемых директорий
DOCUMENTS_STORAGE_ACL_ENABLED=true                             # Включить применение POSIX ACL
DOCUMENTS_STORAGE_QUOTA_MB=                                    # (опционально) Ограничение на суммарный объём файлов
DOCUMENTS_STORAGE_PUBLIC_BASE_URL=                             # (опционально) Публичный URL reverse-proxy для скачивания файлов
DOCUMENTS_UPLOAD_URL_BASE=http://localhost:9000/documents/upload  # Базовый URL файлового шлюза для подписанных ссылок
DOCUMENTS_UPLOAD_URL_TTL=900                                   # TTL подписанной ссылки (секунды)
DOCUMENTS_FOLDERS_TEMPLATE_DEFAULT="{title}"                     # Общий шаблон имени папки (плейсхолдеры: {title}, {ownerId}, {ownerType})
DOCUMENTS_FOLDERS_TEMPLATE_CLIENT="Client {ownerId}"             # Шаблон названия папки клиента
DOCUMENTS_FOLDERS_TEMPLATE_DEAL="Deal {ownerId}"                 # Шаблон названия папки сделки
DOCUMENTS_FOLDERS_TEMPLATE_POLICY="Policy {ownerId}"             # Шаблон названия папки полиса
DOCUMENTS_FOLDERS_TEMPLATE_PAYMENT="Payment {ownerId}"           # Шаблон названия папки платежа
DOCUMENTS_FOLDERS_WEB_BASE_URL=https://files.local/documents/    # Базовый URL reverse-proxy/файлового браузера
DOCUMENTS_BACKUP_STRATEGY=restic                                # Описание стратегии бэкапа каталога документов
DOCUMENTS_BACKUP_TARGET=s3:https://backup.example.com/crm-docs   # Целевой бакет/путь для бэкапов
DOCUMENTS_BACKUP_RETENTION=7d                                   # Политика хранения бэкапов (например, 7 дней)
TELEGRAM_BOT_SERVICE_PORT=8089                              # См. backend/telegram-bot/README.md
TELEGRAM_BOT_BOT_TOKEN=dev-mock-token                       # Токен BotFather; в stage/prod замените на рабочий
TELEGRAM_BOT_BOT_API_BASE=                                   # URL mock Bot API; оставьте пустым для работы с реальным Telegram
TELEGRAM_BOT_WEBHOOK_SECRET=dev-webhook-secret              # Секрет подписи webhook'ов (X-Telegram-Signature)
TELEGRAM_BOT_REDIS_URL=redis://localhost:6379/6
TELEGRAM_BOT_RABBITMQ_URL=amqp://telegram:telegram@localhost:5672/telegram
TELEGRAM_BOT_RABBITMQ_EXCHANGE_CRM=crm.domain
TELEGRAM_BOT_RABBITMQ_EXCHANGE_TASKS=tasks.events
TELEGRAM_BOT_RABBITMQ_EXCHANGE_NOTIFICATIONS=crm.events
TELEGRAM_BOT_RABBITMQ_QUEUE_NOTIFICATIONS=telegram.bot.notifications
TELEGRAM_BOT_EVENT_SOURCE=crm.telegram-bot
TELEGRAM_BOT_AUTH_BASE_URL=http://localhost:8081/api
TELEGRAM_BOT_AUTH_SERVICE_TOKEN=change_me
TELEGRAM_BOT_CRM_BASE_URL=http://localhost:8082/api/v1
TELEGRAM_BOT_CRM_SERVICE_TOKEN=change_me
TELEGRAM_BOT_HEALTHCHECK_TOKEN=bot-health-token
TELEGRAM_BOT_ENVIRONMENT=dev
# FastAPI-сервис Reports (poetry run reports-api)
REPORTS_SERVICE_PORT=8087                                  # См. backend/reports/README.md
REPORTS_BASE_URL=http://localhost:8087
REPORTS_SERVICE_HOST=0.0.0.0
# Переменные Audit удалены: сервис больше не входит в локальный профиль.

# Настройки upstream Gateway (используют объявленные выше порты сервисов)
GATEWAY_UPSTREAM_CRM_BASE_URL=http://localhost:8082/api/v1
GATEWAY_UPSTREAM_CRM_SERVICE_NAME=crm-service
GATEWAY_UPSTREAM_CRM_SSE_URL=http://localhost:8082/streams # Внутренний upstream CRM для канала deals
GATEWAY_UPSTREAM_AUTH_BASE_URL=http://localhost:8081/api
GATEWAY_UPSTREAM_AUTH_SERVICE_NAME=auth-service
GATEWAY_UPSTREAM_NOTIFICATIONS_BASE_URL=http://localhost:8082/api/v1
GATEWAY_UPSTREAM_NOTIFICATIONS_SERVICE_NAME=crm-service
GATEWAY_UPSTREAM_NOTIFICATIONS_SSE_URL=http://localhost:8082/streams
# Общие настройки CI/CD (используйте локально или в стороннем CI)
# --- Общие настройки CI/CD ---
CI_REGISTRY_IMAGE=ghcr.io/your-org/crm
SENTRY_AUTH_TOKEN=

# Внешние интеграции и сервисные ключи
# См. docs/local-setup.md → «Интеграции» за шагами получения доступов
# Дополнительные параметры для хранилища документов. Они дополняют основные настройки сервиса (см. выше) и не переопределяют их.
DOCUMENTS_STORAGE_MOUNT_UNIT=documents-mount@    # Имя unit'а systemd для монтирования тома (оставьте пустым, если не используется)
DOCUMENTS_STORAGE_SSH_KEY_PATH=                  # Путь к приватному ключу для доступа к файловому серверу/rsync (если требуется)
# Локальные эмуляторы/заглушки интеграций
# См. docs/local-setup.md → «Интеграции»
DOCUMENTS_STORAGE_LOCAL_PATH=./var/local-docs             # Альтернативный локальный путь для разработки (если том не смонтирован)

# --- Настройки desktop-приложения ---
DESKTOP_DEAL_DOCUMENTS_ROOT=./var/deal_documents                 # Базовый каталог для локальных папок сделок (используется desktop_app)
