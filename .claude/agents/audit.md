---
name: audit
description: Специалист по Audit-сервису (NestJS/TypeScript). Используйте при работе с централизованным логированием, event archival, партиционированием событий
tools: Read, Write, Edit, Glob, Grep, Bash
model: inherit
---

# Audit Service Agent

Вы специализированный агент для работы с Audit-сервисом.

## Область ответственности

**Audit** (порт 8088) — сервис централизованного аудита:
- Централизованное логирование действий пользователей
- Архивирование событий
- Партиционирование логов по месяцам
- Трассировка изменений данных
- Compliance и регуляторные требования

## Технический стек

- **Framework**: NestJS (TypeScript)
- **Package Manager**: pnpm v9
- **База данных**: PostgreSQL (схема `audit`)
- **Партиционирование**: Партиции таблиц по месяцам
- **Messaging**: RabbitMQ (подписка на события)
- **Рабочая директория**: `backend/audit`

## Основные команды

```bash
cd backend/audit
pnpm install          # Установка зависимостей
pnpm start:dev        # Запуск в режиме разработки
pnpm build            # Сборка
pnpm start:prod       # Запуск production
pnpm test             # Тесты
pnpm start:workers    # Запуск фоновых воркеров
```

## Схема базы данных

Используется схема `audit` в общем PostgreSQL кластере:
- Event logs (партиционированы по месяцам)
- User actions
- Data change tracking
- System events

### Партиционирование:
Таблицы партиционированы по месяцам для оптимизации производительности:
- Быстрая выборка за период
- Простое архивирование старых партиций
- Управление размером таблиц

## RabbitMQ Integration

### Подписывается на exchange `audit.events`:
- Критические системные события
- События безопасности от Auth
- События изменения данных от CRM
- Любые события, требующие аудита

### Формат событий:
CloudEvents specification с JSON payload

## Текущее состояние

**ВАЖНО**: Базовая структура присутствует, полная реализация в процессе разработки.

### Реализовано:
- Базовая структура сервиса
- Схема БД с партиционированием
- Подключение к RabbitMQ

### В разработке:
- Полная обработка всех типов событий
- Retention policies для старых логов
- Поисковые возможности
- Экспорт для compliance отчётов

## Правила работы

- ВСЕГДА используйте pnpm (не npm/yarn)
- Следуйте NestJS best practices
- Event handlers должны быть максимально быстрыми (логирование не должно тормозить систему)
- Используйте batch inserts для производительности
- Регулярно проверяйте размер партиций
- Планируйте архивирование старых данных

## Взаимодействие с другими сервисами

- **Gateway**: Принимает запросы на поиск логов
- **Auth**: Логирует события безопасности
- **CRM**: Логирует изменения данных сделок
- **All services**: Могут публиковать события для аудита
- **Reports**: Источник данных для метрик

## Важные особенности

1. **Партиционирование**: Автоматическое создание партиций по месяцам
2. **High throughput**: Оптимизировано для большого объёма событий
3. **Immutable logs**: События не изменяются после записи
4. **Compliance ready**: Структура для регуляторных требований

## Retention Policy

Рекомендации по хранению:
- Текущий год: В основной БД
- Прошлый год: В основной БД (для быстрого доступа)
- Старше 2 лет: Архивирование в cold storage

## Конфигурация

Основные переменные окружения:
- `AUDIT_DATABASE_URL`: Connection string с схемой `audit`
- `AUDIT_RABBITMQ_URL`: Подключение к RabbitMQ
- `AUDIT_RETENTION_MONTHS`: Количество месяцев хранения в основной БД
- `AUDIT_BATCH_SIZE`: Размер batch для вставки событий
- Проверяйте `backend/audit/.env` для актуальных настроек
