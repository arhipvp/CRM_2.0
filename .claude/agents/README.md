# Claude Code Субагенты для CRM проекта

Этот каталог содержит специализированных субагентов для работы с различными компонентами микросервисной CRM-системы.

## Что такое субагенты?

Субагенты — это специализированные AI-агенты в Claude Code, которые имеют экспертные знания о конкретных частях вашего проекта. Когда вы работаете с определённым микросервисом, Claude Code автоматически использует соответствующего субагента для более точной и эффективной работы.

## Доступные субагенты

### Клиентские приложения

- **`desktop-app`** — Desktop Application (Python/Tkinter) - десктопное приложение, GUI, работа с API

### Микросервисы (Backend)

- **`gateway`** — Gateway/BFF (NestJS) - единая точка входа, SSE-стримы, роутинг
- **`auth`** — Auth Service (Spring Boot/Kotlin) - аутентификация, авторизация, JWT, RBAC
- **`crm`** — CRM/Deals Service (FastAPI/Python) - клиенты, сделки, платежи, полисы
- **`documents`** — Documents Service (NestJS) - файлы, метаданные, POSIX ACL
- **`notifications`** — Notifications Service (NestJS) - уведомления, SSE, Telegram
- **`tasks`** — Tasks Service (NestJS) - задачи, напоминания, SLA
- **`reports`** — Reports Service (FastAPI/Python) - аналитика, materialized views
- **`audit`** — Audit Service (NestJS) - централизованный аудит, логирование
- **`telegram-bot`** — Telegram Bot (Python/aiogram) - интеграция с Telegram
- **`backup`** — Backup Service - автоматические бэкапы, S3 storage

### Инфраструктура

- **`infrastructure`** — DevOps и инфраструктура - Docker, миграции, bootstrap, окружение

## Как использовать

### Автоматическое использование

Claude Code автоматически определяет контекст вашей работы и использует подходящего субагента. Например:

```
Вы: "Нужно добавить новый endpoint в Gateway для обработки SSE событий"
Claude: [автоматически использует субагента gateway]
```

### Явный вызов субагента

Вы можете явно указать, какого субагента использовать, упомянув его имя:

```
Вы: "Используя CRM субагента, помоги разобраться с логикой платежей"
```

### Работа с конкретным сервисом

Когда вы упоминаете путь к файлу или название сервиса, Claude автоматически использует соответствующего агента:

```
Вы: "Исправь баг в backend/auth/src/services/jwt.service.ts"
Claude: [использует субагента auth]
```

## Структура субагента

Каждый субагент знает:

1. **Область ответственности** — что делает этот сервис
2. **Технический стек** — какие технологии используются
3. **Команды** — как запускать, тестировать, собирать сервис
4. **Архитектура** — как сервис взаимодействует с другими
5. **Правила работы** — best practices и важные нюансы
6. **Конфигурация** — какие переменные окружения нужны

## Примеры использования

### Работа с десктопным приложением

```
Вы: "Добавь форму для управления сделками в десктоп приложение"

Claude использует:
1. desktop-app - создаёт UI в Tkinter
2. gateway - проверяет доступность API
3. crm - смотрит API endpoints для сделок
```

```
Вы: "Десктоп приложение зависает при загрузке данных"

Claude использует:
1. desktop-app - добавляет threading для сетевых запросов
2. gateway - проверяет производительность API
```

### Разработка нового функционала

```
Вы: "Нужно добавить возможность прикреплять документы к сделкам"

1. crm - для добавления связи с документами в модели сделки
2. documents - для API загрузки и хранения файлов
3. gateway - для проксирования запросов загрузки
4. desktop-app - для UI загрузки файлов
```

### Отладка проблемы

```
Вы: "Платежи не сохраняются в базе данных"

Claude использует:
1. crm - проверяет логику платежей (они в CRM, не отдельный сервис!)
2. infrastructure - проверяет миграции и схему БД
```

### Настройка окружения

```
Вы: "Не могу запустить проект, ошибка подключения к PostgreSQL"

Claude использует:
1. infrastructure - проверяет bootstrap и docker-compose
2. Соответствующий сервис - проверяет конфигурацию подключения
```

### Работа с инфраструктурой

```
Вы: "Нужно добавить новую миграцию для таблицы клиентов"

Claude использует:
1. infrastructure - для общего понимания системы миграций
2. crm - для создания Alembic миграции в нужном формате
```

## Важные особенности проекта

### Платежи в CRM
**КРИТИЧНО**: Нет отдельного сервиса Payments! Вся логика платежей в CRM service:
- Базовые записи: `crm.payments`
- Доходы: `crm.payment_incomes`
- Расходы: `crm.payment_expenses`

### Технологический стек
- **Desktop**: Python 3.8+ (Tkinter) — использует **pip** с requirements.txt
- **NestJS сервисы**: Gateway, Documents, Notifications, Tasks, Audit — используют **pnpm**
- **Python сервисы**: CRM, Reports, Telegram Bot — используют **Poetry**
- **Kotlin сервисы**: Auth — использует **Gradle wrapper**

### Базы данных
Один PostgreSQL кластер, множество схем:
- Connection strings отличаются для разных языков (R2DBC, asyncpg, JDBC)
- Каждый сервис имеет свою схему

### RabbitMQ
Event-driven архитектура:
- `crm.events`, `tasks.events`, `notifications.events`, `audit.events`, `backup.notifications`
- Формат: CloudEvents specification

## Добавление нового субагента

Если вы добавляете новый микросервис или компонент:

1. Создайте файл `.claude/agents/<service-name>.md`
2. Используйте существующие субагенты как шаблон
3. Заполните секции:
   - `name`, `description`, `tools`, `model` в frontmatter (YAML header)
   - Область ответственности
   - Технический стек
   - Основные команды
   - Структура проекта
   - Ключевые особенности
   - Правила работы
   - Взаимодействие с другими сервисами
   - Environment переменные
   - Частые проблемы и решения
   - Testing
   - Debugging
   - Troubleshooting Checklist
4. Обновите этот README, добавив новый субагент в нужную секцию
5. (Опционально) Добавьте примеры использования в секцию "Примеры использования"

## Полезные команды Claude Code

Управление субагентами через Claude Code:

```
/agents          # Просмотр и управление субагентами
```

## Документация Claude Code

Больше информации о субагентах:
- [Документация по субагентам](https://docs.claude.com/en/docs/claude-code/sub-agents.md)
- [Настройки Claude Code](https://docs.claude.com/en/docs/claude-code/settings.md)

## Поддержка

При возникновении вопросов или проблем:
1. Проверьте описание субагента в соответствующем .md файле
2. Обратитесь к основной документации проекта в `CLAUDE.md`
3. Используйте команду `/help` в Claude Code
